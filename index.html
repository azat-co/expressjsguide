<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Express.js Guide: The Comprehensive Book on Express.js | PDF/EPUB/MOBI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="en" name="Content-Language">
    <meta content="Express.js Guide: The Comprehensive Book on Express.js" name="title">
    <meta content="The in-depth, detailed, hand-on manual on Express.js, the most popular Node.js framework. Will get you up and running fast and save you time." name="description">
    <meta name="author" content="Azat Mardanov">
    <link rel="author" href="https://plus.google.com/u/0/116816240985852388027">
    <link rel="publisher" href="https://plus.google.com/u/0/116816240985852388027">
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DCTERMS">
    <meta content="Express.js Guide" name="DCTERMS.title">
    <meta content="Technical" name="DCTERMS.subject">
    <meta content="Leanpub" name="DCTERMS.publisher">
    <meta content="2013-08-11" name="DCTERMS.date">
    <meta content="eng" name="DCTERMS.language">
    <meta content="Express.js Guide: The Comprehensive Book on Express.js" property="og:title">
    <meta content="book" property="og:type">
    <meta content="https://s3.amazonaws.com/titlepages.leanpub.com/express/medium?1383506595" property="og:image">
    <meta content="https://leanpub.com/express" property="og:url">
    <meta content="Leanpub" property="og:site_name">
    <meta content="The in-depth, detailed, hand-on manual on Express.js, the most popular Node.js framework. Will get you up and running fast and save you time." property="og:description">
    <!-- Le styles -->
    <link href="assets/css/bootstrap.css" rel="stylesheet" type="text/css" />
    <link href="assets/css/bootstrap-responsive.css" rel="stylesheet" type="text/css" />
    <!-- Font-awesmome Css -->
    <link href="assets/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
	<!-- Theme CSS -->
    <link href="assets/css/style.css" rel="stylesheet" type="text/css" />
    <!-- Magnific Popup CSS -->
	<link href="assets/js/plugins/magnificPopup/magnific-popup.css" rel="stylesheet" type="text/css" />
    <!-- Quotes Rotator CSS -->
	<link href="assets/js/plugins/QuotesRotator/css/QuotesRotator.css" rel="stylesheet" type="text/css" />
    <script src="assets/js/plugins/QuotesRotator/js/modernizr.custom.js"></script>


    <!--[if IE 7]>
      <link rel="stylesheet" href="assets/css/font-awesome-ie7.min.css">
    <![endif]-->

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="assets/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
<!--     <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png"> -->
    <link rel="shortcut icon" href="assets/ico/favicon.ico">
    <script type="text/javascript" src="https://gumroad.com/js/gumroad.js"></script>
  </head>

  <body>
	<header id="marketing">
    <div class="container">
     <div class="row">
        <div class="span12">
        	<div class="header-inner">
        	<a class="logo pull-left" href="http://expressjsguide.com">The Comprehensive Book on Express.js</a>
        	<div class="social-icons text-right pull-right">
                <a href="#" class="share-facebook"><i class="icon-facebook"></i></a>
                <a href="#" class="share-twitter"><i class="icon-twitter"></i></a>
            </div><!--/social-icons-->
            </div><!--/header-inner-->
        </div><!--/span12-->
        <div class="clearfix"></div>
        <div class="span12">
        <div class="masthead">
        	<div class="row">
	            <div class="span5 text-center">
                	<div class="marketing-media">
                  	<img src="assets/img/title-page-cover.png" alt="How to sell online books" width="228" height="316" />
                    <a href="http://samples.leanpub.com/express-sample.pdf" class="link-white"><i class="icon-download"></i> Download Express.js Guide Sample</a>
                    </div><!--/marketing-media-->
                </div><!--/span5-->
            	<div class="span7">
                	<h1 class="hero-title">Express.js Guide: The Comprehensive Book on Express.js</h1>
                    <p class="hero-desc">
                      The in-depth, detailed, hand-on manual on Express.js, the most popular Node.js framework. Will get you up and running fast and save you time. Understand the concepts, learn the best practices. Become an Express.js expert today.
                    </p>
                    <form class="hero-form text-center">
                        <fieldset>
                            <label style="cursor: default">Get the Professional package for $29.99</label>
                            <a href="http://gum.co/express" onclick="_gaq.push(['_trackEvent', 'BuyLinks', 'Professional', 'Buy now (top)']);" class="gumroad-button0 btn btn-info btn-large btn-block">Buy now</a>
                        </fieldset>
                        <p class="text-small-alt">Other options start at $9.99 only. <a href="#packages" onclick="_gaq.push(['_trackEvent', 'NavLinks', 'Packages', 'Jump to other packages']);">Jump to the other packages.</a></p>
                    </form>
                </div><!--/span7-->
            </div><!--/row-->
        </div><!--/masthead-->
        </div><!--/span12-->
        </div><!--/row-->
        </div><!--/container-->
     </header><!--/marketing-->

     <section id="inside" class="sec-wrap">
     	<div class="container">
        <div class="row">
            <div class="span12">
                <h2 class="sec-title"><span>What's Inside Express.js Guide</span></h2>

            </div><!--span12-->
         </div><!--/row-->
         <div class="row">

            <div class="span6">
              <p>Express.js API reference, quick start guides, 20+ meticulously explained examples and tutorials — over 270 pages with more than 60 illustrations.</p>
          		<div class="accordion" id="chapter">
                    <div class="accordion-group">
                      <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#chapter" href="#collapseForeword">
                           Foreword by Anatoliy Chakkaev
                        </a>
                      </div>
                      <div id="collapseForeword" class="accordion-body collapse in">
                        <div class="accordion-inner">
                          <p class="text-lead">Foreword by Anatoliy Chakkaev (<a href="https://twitter.com/1602">@1602</a>), the creator of <a href="http://compoundjs.com">CompoundJS</a> and <a href="http://jugglingdb.co">JugglingDB</a>. </p>
                        </div>
                      </div>
                    </div><!--/accordion-group-->
                    <div class="accordion-group">
                      <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#chapter" href="#collapseOne">
                          1. Quick Start
                        </a>
                      </div>
                      <div id="collapseOne" class="accordion-body collapse">
                        <div class="accordion-inner">
                          <p class="text-lead">In this part we’ll briefly go over what is Express.js, install it, build a few simple applications and begin to touch on configurations.</p>
                          <ul class="unstyled list-bullet">
                            <li>What is Express.js</li>
                            <li>Installation</li>
                            <li>Hello World Example</li>
                            <li>CLI</li>
                            <li>MVC Structure and Modules</li>
                          </ul>
                        </div>
                      </div>
                    </div><!--/accordion-group-->
                    <div class="accordion-group">
                      <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#chapter" href="#collapseTwo">
                          2. The Interface
                        </a>
                      </div>
                      <div id="collapseTwo" class="accordion-body collapse">
                        <div class="accordion-inner">
                           <p class="text-lead">This part can be used as a stand alone reference for the Express.js API, because it contains description of all the main methods and properties, as well as short examples and exaplanations.</p>
                          <ul class="unstyled list-bullet">
                            <li>Configuration and Settings</li>
                            <li>Middlewares</li>
                            <li>Parameters</li>
                            <li>Routing</li>
                            <li>Request and Response</li>
                            <li>Running an App</li>
                            <li>Error Handling</li>
                          </ul>
                        </div>
                      </div>
                    </div><!--/accordion-group-->
                    <div class="accordion-group">
                      <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#chapter" href="#collapseThree">
                          3. Tips and Tricks
                        </a>
                      </div>
                      <div id="collapseThree" class="accordion-body collapse">
                        <div class="accordion-inner">
                          <p class="text-lead">The best industry practices from the trenches of running production Node.js for everything at the Joyent/Node.js partner Storify. Some topics involve:</p>
                          <ul class="unstyled list-bullet">
                            <li>Abstraction</li>
                            <li>Streams</li>
                            <li>Redis</li>
                            <li>Clusters</li>
                            <li>Authentication</li>
                            <li>Stylus, LESS and SASS</li>
                            <li>Domains</li>
                            <li>Security</li>
                            <li>Socket.IO</li>
                          </ul>
                        </div>
                      </div>
                    </div><!--/accordion-group-->
                    <div class="accordion-group">
                      <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#chapter" href="#collapseFour">
                          4. Tutorials and Examples
                        </a>
                      </div>
                      <div id="collapseFour" class="accordion-body collapse">
                        <div class="accordion-inner">
                          <p class="text-lead">Hands-on REST API servers with NPM libraries (superagent, Mongoose, Mongoskin, Mocha)third-party services (Storify API, AngelList), databases (MongoDB) and front-end clients (Backbone.js).</p>
                            <ul class="unstyled list-bullet">
                              <li>Instagram Gallery</li>
                              <li>Todo App</li>
                              <li>REST API</li>
                              <li>HackHall</li>
                          </ul>
                          <p>In addition to four aforementioned major examples, there are many other smaller ones. Their full source code is available for examination at <a href="http://github.com/azat-co/expressjsguide">github.com/azat-co/expressjsguide</a>.
                        </div>
                      </div>
                    </div><!--/accordion-group-->
                    <div class="accordion-group">
                      <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#chapter" href="#collapseFive">
                          5. Source Code
                        </a>
                      </div>
                      <div id="collapseFive" class="accordion-body collapse">
                        <div class="accordion-inner">
                          <p class="text-lead">Tested and fully working source code for all examples and tutorials.</p>
                        </div>
                      </div>
                    </div><!--/accordion-group-->
                    <div class="accordion-group">
                      <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#chapter" href="#collapseSix">
                          6. ExpressWorks Automated Workshop
                        </a>
                      </div>
                      <div id="collapseSix" class="accordion-body collapse">
                        <div class="accordion-inner">
                          <p class="text-lead"><a href="http://github.com/azat-co/expressworks">ExpressWorks</a> is an automated Express.js/Node.js workshop akin <a href="http://nodeschool.io">nodeschool.io</a>, based on workshopper and inspired by stream-adventure by <a href="http://twitter.com/substack">@substack</a> and <a href="http://twitter.com/maxogden">@maxogden</a>.</p>
                        </div>
                      </div>
                    </div><!--/accordion-group-->



              </div><!--/accordion-->
              <p>Read an Express.js Guide sample <a href="#sample">online</a> or download a <a href="http://samples.leanpub.com/express-sample.pdf">PDF sample</a>.</p>
              <p>Jump to Express.js Guide <a href="#packages">packages and pricing</a>.</p>
            </div><!--/span6-->
            <div class="span6">
	                <ul class="thumbnails">
                      <li class="span3">
                        <a href="assets/img/query-node.png" title="Processing query string params." class="thumbnail">
                          <img src="assets/img/query-node-thumb.png" alt="sample-thumb" width="133" height="106"/>
                        </a>
                      </li>
                      <li class="span3">
                        <a href="assets/img/navigation.png" title="Navigation in PDF." class="thumbnail">
                          <img src="assets/img/navigation-thumb.png" alt="sample-thumb" width="125" height="106"/>
                        </a>
                      </li>
                      <li class="span3">
                        <a href="assets/img/sfy-gallery.png" title="Instagram Gallery with Storify API." class="thumbnail">
                          <img src="assets/img/sfy-gallery-thumb.png" alt="sample-thumb" width="127" height="106"/>
                        </a>
                      </li>
                      <li class="span3">
                        <a href="assets/img/expressworks.png" title="ExpressWorks — an automated Express.js workshop." class="thumbnail">
                          <img src="assets/img/expressworks-thumb.png" alt="sample-thumb" width="114" height="106"/>
                        </a>
                      </li>
                    </ul>
            </div><!--/span6-->
        </div><!--/row-->
        </div><!--/container-->
     </section><!--/inside-->


    <section id="testimonial" class="sec-wrap">
          <div class="container">
            <div class="row">
              <div class="span12">
                <h2 class="sec-title"><span>Real Testimonials</span></h2>
              </div><!--span12-->
            </div>
            <div class="row testimonials-box">
                <div class="span12">

                <div id="cbp-qtrotator" class="cbp-qtrotator">
                  <div class="cbp-qtcontent cbp-qtcurrent" style="transition: opacity 700ms ease; -webkit-transition: opacity 700ms ease;">
                    <div class="row">
                      <div class="span4">
                        <blockquote class="twitter-tweet"><p>This is a great book to learn and reference Express.js&#10;intro to express.js <a href="http://t.co/EHgghwikpD">http://t.co/EHgghwikpD</a> via <a href="https://twitter.com/azat_co">@azat_co</a> <a href="https://twitter.com/search?q=%23express&amp;src=hash">#express</a>.js <a href="https://twitter.com/search?q=%23node&amp;src=hash">#node</a>.js</p>&mdash; Josh Pagley (@JoshPagley) <a href="https://twitter.com/JoshPagley/statuses/397714379782627328">November 5, 2013</a></blockquote>
                        <script async src="http://platform.twitter.com/widgets.js" charset="utf-8"></script>
                      </div>
                      <div class="span4">
                        <blockquote class="twitter-tweet"><p>Excellent ebook about Node.js Express framework:&#10;Express.js Guide&#10;<a href="http://t.co/ZatBm6wt4e">http://t.co/ZatBm6wt4e</a>&#10;by <a href="https://twitter.com/azat_co">@azat_co</a></p>&mdash; Caio Ribeiro Pereira (@crp_underground) <a href="https://twitter.com/crp_underground/statuses/395520014435893248">October 30, 2013</a></blockquote>
                      </div>
                      <div class="span4">
                        <blockquote class="twitter-tweet"><p><a href="https://twitter.com/azat_co">@azat_co</a> I&#39;m new with expressjs and find this book very useful! Good examples, and good for kindle users too.</p>&mdash; Babs Daher (@BARdaher) <a href="https://twitter.com/BARdaher/statuses/395203525292343297">October 29, 2013</a></blockquote>
                      </div>
                    </div>
                  </div><!--/cbp-qtcontent-->


                 <div class="cbp-qtcontent" style="transition: opacity 700ms ease; -webkit-transition: opacity 700ms ease;">
                    <div class="row">
                      <div class="span4">
                        <blockquote class="twitter-tweet"><p><a href="https://twitter.com/azat_co">@azat_co</a> Awesome!!!</p>&mdash; Lucas Churchill (@_agtlucas) <a href="https://twitter.com/_agtlucas/statuses/397130257142018048">November 3, 2013</a></blockquote>
                      </div>
                      <div class="span4">
                        <blockquote class="twitter-tweet"><p>Check out <a href="https://twitter.com/azat_co">@azat_co</a>&#39;s new book on Express.js with an API reference, quick start guides and hands-on tutorials. <a href="https://t.co/CLCyQPIOhQ">https://t.co/CLCyQPIOhQ</a></p>&mdash; Brian Rinaldi (@remotesynth) <a href="https://twitter.com/remotesynth/statuses/392711542245842945">October 22, 2013</a></blockquote>
                      </div>
                      <div class="span4">
                        <blockquote class="twitter-tweet"><p><a href="https://twitter.com/azat_co">@azat_co</a> I like it and I want to get it in my brain. Your other books <a href="https://twitter.com/search?q=%23RPJS&amp;src=hash">#RPJS</a> and <a href="https://twitter.com/search?q=%23ohmyjs&amp;src=hash">#ohmyjs</a> too :-)</p>&mdash; Rolf Bulk (@robumanX) <a href="https://twitter.com/robumanX/statuses/395082201580060672">October 29, 2013</a></blockquote>
                      </div>
                    </div>

                  </div><!--/cbp-qtcontent-->


                  <div class="cbp-qtcontent" style="transition: opacity 700ms ease; -webkit-transition: opacity 700ms ease;">
                    <div class="row">
                      <div class="span4">
                        <blockquote class="twitter-tweet"><p><a href="https://twitter.com/azat_co">@azat_co</a> Immensely benefited from your ExpressJS guide. Your blog is a huge timesaver for building Node.js apps!! <a href="https://twitter.com/search?q=%23nodejs&amp;src=hash">#nodejs</a></p>&mdash; Indrajit Chakrabarty (@indyfromoz) <a href="https://twitter.com/indyfromoz/statuses/397865380439261185">November 5, 2013</a></blockquote>
                      </div>
                      <div class="span4">
                        <blockquote class="twitter-tweet"><p>I’m reading &quot;Express.js Guide — the most popular Node.js framework’s manual&quot; by <a href="https://twitter.com/azat_co">@azat_co</a> <a href="https://twitter.com/search?q=%23RPJS&amp;src=hash">#RPJS</a> <a href="https://t.co/WSPS3KbZ9S">https://t.co/WSPS3KbZ9S</a></p>&mdash; Manuel Kiessling (@manuelkiessling) <a href="https://twitter.com/manuelkiessling/statuses/392760255249002496">October 22, 2013</a></blockquote>
                      </div>
                      <div class="span4">
                        <blockquote class="twitter-tweet"><p>I just got the Express.js Guide from <a href="https://twitter.com/azat_co">@azat_co</a> on <a href="https://twitter.com/gumroad">@Gumroad</a>: <a href="http://t.co/6c1nXMe9mZ">http://t.co/6c1nXMe9mZ</a> :)</p>&mdash; Stefan Ritter (@S__Ritter) <a href="https://twitter.com/S__Ritter/statuses/397028329988968448">November 3, 2013</a></blockquote>
                      </div>
                    </div>
                  </div><!--/cbp-qtcontent-->
                  <div class="cbp-qtcontent" style="transition: opacity 700ms ease; -webkit-transition: opacity 700ms ease;">
                    <div class="row">
                      <div class="span4">
                       <blockquote class="twitter-tweet"><p><a href="https://twitter.com/azat_co">@azat_co</a> yes i know it’s very helpful</p>&mdash; Nenad Vulic  (@nenadvulic) <a href="https://twitter.com/nenadvulic/statuses/397820122502795264">November 5, 2013</a></blockquote>
                      </div>
                      <div class="span4">
                        <blockquote class="twitter-tweet"><p>just bought Express.js Guide from <a href="https://twitter.com/azat_co">@azat_co</a> on <a href="https://twitter.com/gumroad">@Gumroad</a>: <a href="https://t.co/XHRraAvxm4">https://t.co/XHRraAvxm4</a></p>&mdash; martin drenovac (@drenovac) <a href="https://twitter.com/drenovac/statuses/396826352726196224">November 3, 2013</a></blockquote>
                      </div>
                      <div class="span4">
                        <blockquote class="twitter-tweet"><p>I have to admit <a href="https://twitter.com/search?q=%23NodeJS&amp;src=hash">#NodeJS</a>+<a href="https://twitter.com/search?q=%23ExpressJs&amp;src=hash">#ExpressJs</a> is awesome and fun to code with. Thanks <a href="https://twitter.com/azat_co">@azat_co</a> for such an easy walk through <a href="https://twitter.com/search?q=%23ExpressJS&amp;src=hash">#ExpressJS</a></p>&mdash; Antonio Ramirez (@tonydspaniard) <a href="https://twitter.com/tonydspaniard/statuses/402069629217935360">November 17, 2013</a></blockquote>
                      </div>
                    </div>
                  </div><!--/cbp-qtcontent-->

                </div><!--/cbp-qtrotator-->
                </div><!--span12-->
            </div><!--/row-->
            <p>Jump to Express.js Guide <a href="#packages">packages and pricing</a>.</p>
            </div><!--/container-->
         </section>


     <section id="author" class="sec-wrap">
     	<div class="container">
        <div class="row">
            <div class="span12">
                <h2 class="sec-title"><span>About the Author</span></h2>
            </div><!--span12-->
            <div class="span10 offset1">
                <div class="media">
                  <a class="pull-left" href="#">
                    <img class="media-object" src="assets/img/author-photo-small.png" alt="Azat Mardanov: a software engineer, an author and a yogi." title="Azat Mardanov: a software engineer, an author and a yogi."/>
                  </a>
                  <div class="media-body">

                    <p>Azat Mardanov has over 12 years of experience in web, mobile and software development. With a Bachelor’s Degree in Informatics and a Master of Science in Information Systems Technology degree, Azat possesses deep academic knowledge as well as extensive practical experience.</p>

                    <p>Currently, Azat works as a Senior Software Engineer at <a href="http://docusign.com">DocuSign</a>, where his team rebuilds 50 million user product (DocuSign web app) using the tech stack of Node.js, Express.js, Backbone.js, CoffeeScript, Jade, Stylus and Redis.</p>

                    <p>Recently, he worked as an engineer at the curated social media news aggregator website, <a href="http://storify.com">Storify.com</a> (acquired by <a href="http://livefyre.com">LiveFyre</a>) which is used by BBC, NBC, CNN, The White House and others. Storify runs everything on Node.js unlike other companies. It&#8217;s the maintainer of the open-source library <a href="http://npmjs.org/jade-browser">jade-browser</a>. </p>

                    <p>Before that, Azat worked as a CTO/co-founder at <a href="http://www.crunchbase.com/company/gizmo">Gizmo</a> — an enterprise cloud platform for mobile marketing campaigns, and has undertaken the prestigious <a href="http://500.co/">500 Startups</a> business accelerator program. </p>

                    <p>Prior to this, Azat was developing he developed mission-critical applications for government agencies in Washington, DC, including the <a href="http://nih.gov">National Institutes of Health</a>, the <a href="http://ncbi.nlm.nih.gov">National Center for Biotechnology Information</a>, and the <a href="http://fdic.gov">Federal Deposit Insurance Corporation</a>, as well as <a href="http://lockheedmartin.com">Lockheed Martin</a>. </p>

                    <p>Azat is a frequent attendee at Bay Area tech meet-ups and hackathons (<a href="http://angelhack.com">AngelHack</a> hackathon ’12 finalist with team <a href="http://fashionmetric.com">FashionMetric.com</a>).</p>

                    <p>In addition, Azat teaches technical classes at <a href="http://generalassemb.ly">General Assembly</a>, <a href="http://hackreactor.com">Hack Reactor</a>, <a href="http://parisoma.com">pariSOMA</a> and <a href="http://marakana.com">Marakana</a> (acquired by Twitter) to much acclaim.</p>

                    <p>In his spare time, he writes about technology on his blog: <a href="http://webapplog.com">webAppLog.com</a> which is <a href="http://expressjsguide.com/assets/img/expressjs-tutorial.png">number one</a> in &#8220;express.js tutorial&#8221; Google search results. Azat is also the author of <a href="http://expressjsguide.com">Express.js Guide</a>, <a href="http://rpjs.co">Rapid Prototyping with JS</a> and <a href="http://leanpub.com/ohmyjs">Oh My JS</a>; and the creator of open-source Node.js projects, including <a href="http://npmjs.org/expressworks">ExpressWorks</a>, <a href="http://npmjs.org/mongoui">mongoui</a> and <a href="http://hackhall.com">HackHall</a>.</p>

                    <div class="social-icons text-left">
                      <a href="#" class="share-facebook"><i class="icon-facebook"></i></a>
                      <a href="#" class="share-twitter"><i class="icon-twitter"></i></a>
                    </div><!--/social-icons-->
                  </div><!--/media-body-->
                </div><!--/media-->
            </div><!--span10-->
        </div><!--/row-->
        </div><!--/container-->
     </section><!--/inside-->



     <section id="packages" class="sec-wrap">
      <div class="container">
        <div class="row">
            <div class="span12">
                <h2 class="sec-title"><span>The Express.js Guide Packages</span></h2>
            </div><!--span12-->
        </div>
        <div class="row">
            <div class="span10 offset1">
                <div class="media">
                  <div class="media-body">
                      <fieldset>
                          <div class="span3">
                            <div class="control-group text-center">
                                <h1>Kindle Only Express.js</h1>
                                <label class="subhead">(budget)</label>
                                <p class="text-small-alt includes">This option includes:</p>
                                <div class="includes">
                                  <ul>
                                    <li><i class="icon-ok"></i> MOBI (for Kindle)</span> </li>
                                    <li><i class="icon-ok"></i> Code in the book</li>
                                    <li>&nbsp;</li>

                                  </ul>
                                </div>
                                <a href="https://gum.co/iUnq" onclick="_gaq.push(['_trackEvent', 'BuyLinks', 'Kindle', 'Buy now']);" class="gumroad-button0 btn  btn-info btn-large btn-block">Buy now</a>
                                <label>Get MOBI (for Kindle) for $9.99</label>

                            </div><!--/control-group-->
                          </div>

                          <div class="span3">
                            <div class="control-group text-center">
                                <h1>Professional Express.js</h1>
                                <label class="subhead">(most popular & recommended)</label>
                                <p class="text-small-alt includes">The package includes:</p>
                                <div class="includes">
                                  <ul>
                                    <li><i class="icon-ok"></i> PDF</li>
                                    <li><i class="icon-ok"></i> EPUB (for iPad, iPhone, Mac)</li>
                                    <li><i class="icon-ok"></i> MOBI (for Kindle)</li>
                                    <li><i class="icon-ok"></i> Code in the book</li>
                                    <li><i class="icon-ok"></i> Executable code for all examples</li>
                                    <li><i class="icon-ok"></i> ExpressWorks workshop</li>
                                    <li><i class="icon-ok"></i> Online access via <a href="http://anywherelib.com">AnyWhereLib.com</a></li>
                                    <!-- <li><i class="icon-ok"></i> <span  rel="tooltip" data-toggle="tooltip" title="DRM-free, but only owner is allowed to use the ebook. Public sharing is prohibited.">Single-person license</a>&nbsp;<i class="icon-question-sign"></i></span> </li> -->
                                    <li>&nbsp;</li>
                                  </ul>
                                </div>
                                <a href="http://gum.co/express" onclick="_gaq.push(['_trackEvent', 'BuyLinks', 'Professional', 'Buy now']);" class="gumroad-button0 btn  btn-danger btn-large btn-block">Buy now</a>
                                <label>Get the Professional package for $29.99</label>

                            </div><!--/control-group-->
                          </div>

                          <div class="span3">
                            <div class="control-group text-center">
                                <h1>Team Express.js</h1>
                                <label  class="subhead">(for teams and corporations)</label>
                                <p class="text-small-alt includes">
                                  The package includes:
                                </p>
                                <div class="includes">
                                  <ul>
                                    <li><i class="icon-ok"></i> PDF</li>
                                    <li><i class="icon-ok"></i> EPUB (for iPad, iPhone, Mac)</li>
                                    <li><i class="icon-ok"></i> MOBI (for Kindle)</li>
                                    <li><i class="icon-ok"></i> Code in the book</li>
                                    <li><i class="icon-ok"></i> Executable code for everything</li>
                                    <li><i class="icon-ok"></i> ExpressWorks workshop</li>
                                    <li><i class="icon-ok"></i> Online access via <a href="http://anywherelib.com">AnyWhereLib.com</a></li>
                                    <li><i class="icon-ok"></i> <span  rel="tooltip" data-toggle="tooltip" title="Owner is allowed to share the ebook between colleagues, friends and family. Public sharing is prohibited."><b>Multi-person DRM-free license</b>&nbsp;<i class="icon-question-sign"></i></span> </li>
                                    <li><span  rel="tooltip" data-toggle="tooltip" title="Oh My JS: The Best JavaScript Articles"><i class="icon-ok"></i> Bonus: <a href="http://leanpub.com/ohmyjs" target="_blank" >Oh My JS ebook</a></span></li>
                                    <li>&nbsp;</li>
                                  </ul>
                                 </div>
                                <a href="http://gum.co/expressteam/" onclick="_gaq.push(['_trackEvent', 'BuyLinks', 'Team', 'Buy now']);" class="btn btn-info btn-large  btn-info btn-block">Buy now</a>
                                <label>Get the Team package for $49.99</label>
                            </div><!--/control-group-->
                          </div>
<!--
                          <div class="span3">
                            <div class="control-group text-center">
                                <h1>Premium Express.js</h1>
                                <p class="text-small-alt includes">
                                  The package includes:</p>
                                <div class="includes">
                                  <ul>
                                    <li><i class="icon-ok"></i> PDF</li>
                                    <li><i class="icon-ok"></i> ePub (iPad, iPhone, Mac)</li>
                                    <li><i class="icon-ok"></i> MOBI (Kindle)</li>
                                    <li><i class="icon-ok"></i> Source code</li>
                                    <li><i class="icon-ok"></i> ExpressWorks workshop</li>
                                    <li><i class="icon-ok"></i> <span  rel="tooltip" data-toggle="tooltip" title="Company is allowed to share the ebook between colleagues. Public sharing is prohibited."> <b>Multi-person</b> DRM-free license <i class="icon-question-sign"></i></span> </li>
                                    <li><i class="icon-ok"></i> <b>5 paperback copies</b></li>
                                    <li>&nbsp;</li>
                                    <li>&nbsp;</li>
                                </ul>
                                </div>
                                <a href="http://gum.co/expresspremium/" class="btn btn-info btn-large  btn-block">Buy Now</a>
                                <label>Get the Premium package for $149.99</label>
                            </div>
                          </div> --><!--/control-group-->
                        </fieldset>

                  </div><!--/media-body-->
                </div><!--/media-->
             <!-- <p class="packages-footer-copy"> All packages are 100% refundable and <a href="https://gumroad.com/guide/basics/is-gumroad-for-me#security">secured by Gumroad</a>.</p> -->


            </div><!--span-->
        </div><!--/row-->
        <div class="row paperback">
          <div class="span10 offset1">
            <p class=""> All purchases are 100% refundable and <a href="https://gumroad.com/guide/basics/is-gumroad-for-me#security">secured by Gumroad</a>.</p>
            <p> Express.js Guide is also available in <b>print</b> for $39.99 (list price) at <a href="https://www.createspace.com/4540968" onclick="_gaq.push(['_trackEvent', 'BuyLinks', 'CreateSpace pbook', 'CreateSpace']);">CreateSpace</a> and <a href="http://amzn.to/19Ed2Jj" onclick="_gaq.push(['_trackEvent', 'BuyLinks', 'Amazon.com pbook', 'Amazon.com']);">Amazon.com</a>.</p>
            <!-- <p>For your conveniece, Personal and Team packages include executable source code of all the examples and the <a href="http://npmjs.org/expressworks" target="_blank">ExpressWorks</a> automated workshop.</p> -->
          </div>
        </div>
        </div><!--/container-->
     </section><!--/inside-->

     <section id="marketing-footer" class="sec-wrap">
      <div class="container">
         <div class="row">
          <div class="span8 offset2">
                <form class="hero-form tweet-form">
                   <div class="row-fluid">
                      <div class="span3 text-center">
                        <img src="assets/img/title-page-small.png" width="128" height="177" alt="book cover" />
                        </div>
                        <div class="span9">
                        <fieldset>
                            <div class="control-group text-center">

                              <label style="cursor: default">Get the Professional package for $29.99</label>
                              <a href="http://gum.co/express" onclick="_gaq.push(['_trackEvent', 'BuyLinks', 'Professional', 'Buy now (middle)']);" class="gumroad-button0 btn btn-info btn-large btn-block">Buy now</a>

                              <p class="text-small-alt">Other options start at $9.99 only. <a href="#packages" onclick="_gaq.push(['_trackEvent', 'NavLinks', 'Packages', 'Jump to other packages']);">Jump to the other packages.</a></p>
                            </div><!--/control-group-->
                        </fieldset>
                        </div><!--/span9-->
                   </div><!--/row-fluid-->
                </form>
            </div><!--/span8-->
        </div><!--/row-->
      </div><!--/container-->
    </section><!--/inside-->

     <section id="sample" class="sec-wrap">
       <div class="container">
     <div class="row">
            <div class="span12">
                <h2 class="sec-title"><span>The Express.js Guide Sample</span></h2>
            </div><!--span12-->
        </div>
        <div class="row">
<div class="span8 offset2">
<div id="leanpub-toc">
<h2>Table of Contents for The Sample </h2>
<ol class="toc">
<ul class="toc has-parts">
  <li>
    <ul>
      <li>
        <a href="#leanpub-auto-foreword">Foreword</a>
      </li>
      <li>
        <a href="#leanpub-auto-acknowledgment">Acknowledgment</a>
      </li>
      <li>
        <a href="#introduction">Introduction</a>
        <ul>
          <li>
            <a href="#leanpub-auto-why">Why</a>
          </li>
          <li>
            <a href="#leanpub-auto-what-this-book-is">What This Book is</a>
          </li>
          <li>
            <a href="#leanpub-auto-what-this-book-is-not">What This Book is Not</a>
          </li>
          <li>
            <a href="#leanpub-auto-who-this-book-is-for">Who This Book is For</a>
          </li>
          <li>
            <a href="#leanpub-auto-notation">Notation</a>
          </li>
          <li>
            <a href="#leanpub-auto-navigation">Navigation</a>
          </li>
          <li>
            <a href="#leanpub-auto-how-to-use-the-book">How to Use the Book</a>
          </li>
          <li>
            <a href="#leanpub-auto-examples">Examples</a>
          </li>
          <li>
            <a href="#leanpub-auto-contact-us">Contact Us</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="#leanpub-auto-quick-start"><span class="section-number">I </span>Quick Start</a>
  </li>
  <li>
    <a href="#leanpub-auto-the-interface"><span class="section-number">II </span>The Interface</a>
  </li>
  <li>
    <a href="#leanpub-auto-tips-and-tricks"><span class="section-number">III </span>Tips and Tricks</a>
  </li>
  <li>
    <a href="#tutorials-and-examples"><span class="section-number">IV </span>Tutorials and Examples</a>
    <ul>
      <li>
        <a href="#leanpub-auto-instagram-gallery"><span class="section-number">1 </span>Instagram Gallery</a>
        <ul>
          <li>
            <a href="#leanpub-auto-a-file-structure"><span class="section-number">1.1 </span>A File Structure</a>
          </li>
          <li>
            <a href="#leanpub-auto-dependencies"><span class="section-number">1.2 </span>Dependencies</a>
          </li>
          <li>
            <a href="#leanpub-auto-nodejs-server"><span class="section-number">1.3 </span>Node.js Server</a>
          </li>
          <li>
            <a href="#leanpub-auto-handlebars-template"><span class="section-number">1.4 </span>Handlebars Template</a>
          </li>
          <li>
            <a href="#leanpub-auto-conclusion"><span class="section-number">1.5 </span>Conclusion</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-todo-app"><span class="section-number">2 </span>Todo App</a>
        <ul>
          <li>
            <a href="#leanpub-auto-scaffolding"><span class="section-number">2.1 </span>Scaffolding</a>
          </li>
          <li>
            <a href="#leanpub-auto-mongodb"><span class="section-number">2.2 </span>MongoDB</a>
          </li>
          <li>
            <a href="#leanpub-auto-structure"><span class="section-number">2.3 </span>Structure</a>
          </li>
          <li>
            <a href="#leanpub-auto-appjs"><span class="section-number">2.4 </span>app.js</a>
          </li>
          <li>
            <a href="#leanpub-auto-routes"><span class="section-number">2.5 </span>Routes</a>
          </li>
          <li>
            <a href="#leanpub-auto-jades"><span class="section-number">2.6 </span>Jades</a>
          </li>
          <li>
            <a href="#leanpub-auto-less"><span class="section-number">2.7 </span>LESS</a>
          </li>
          <li>
            <a href="#leanpub-auto-conclusion-1"><span class="section-number">2.8 </span>Conclusion</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-rest-api"><span class="section-number">3 </span>REST API</a>
        <ul>
          <li>
            <a href="#leanpub-auto-test-coverage"><span class="section-number">3.1 </span>Test Coverage</a>
          </li>
          <li>
            <a href="#leanpub-auto-dependencies-1"><span class="section-number">3.2 </span>Dependencies</a>
          </li>
          <li>
            <a href="#leanpub-auto-implementation"><span class="section-number">3.3 </span>Implementation</a>
          </li>
          <li>
            <a href="#leanpub-auto-conclusion-2"><span class="section-number">3.4 </span>Conclusion</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#hackhall"><span class="section-number">4 </span>HackHall</a>
        <ul>
          <li>
            <a href="#leanpub-auto-what-is-hackhall"><span class="section-number">4.1 </span>What is HackHall</a>
          </li>
          <li>
            <a href="#leanpub-auto-running-hackhall"><span class="section-number">4.2 </span>Running HackHall</a>
          </li>
          <li>
            <a href="#leanpub-auto-structure-1"><span class="section-number">4.3 </span>Structure</a>
          </li>
          <li>
            <a href="#leanpub-auto-expressjs-app"><span class="section-number">4.4 </span>Express.js App</a>
          </li>
          <li>
            <a href="#leanpub-auto-routes-1"><span class="section-number">4.5 </span>Routes</a>
            <ul>
              <li>
                <a href="#leanpub-auto-indexjs"><span class="section-number">4.5.1 </span>index.js</a>
              </li>
              <li>
                <a href="#leanpub-auto-authjs"><span class="section-number">4.5.2 </span>auth.js</a>
              </li>
              <li>
                <a href="#leanpub-auto-mainjs"><span class="section-number">4.5.3 </span>main.js</a>
              </li>
              <li>
                <a href="#leanpub-auto-usersjs"><span class="section-number">4.5.4 </span>users.js</a>
              </li>
              <li>
                <a href="#leanpub-auto-applicationsjs"><span class="section-number">4.5.5 </span>applications.js</a>
              </li>
              <li>
                <a href="#leanpub-auto-postsjs"><span class="section-number">4.5.6 </span>posts.js</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#leanpub-auto-mogoose-models"><span class="section-number">4.6 </span>Mogoose Models</a>
          </li>
          <li>
            <a href="#leanpub-auto-mocha-tests"><span class="section-number">4.7 </span>Mocha Tests</a>
          </li>
          <li>
            <a href="#leanpub-auto-conclusion-3"><span class="section-number">4.8 </span>Conclusion</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-expressworks">ExpressWorks</a>
        <ul>
          <li>
            <a href="#leanpub-auto-what-is-expressworks">What is ExpressWorks?</a>
          </li>
          <li>
            <a href="#leanpub-auto-installation-recommended">Installation (recommended)</a>
          </li>
          <li>
            <a href="#leanpub-auto-local-installation-advanced">Local Installation (advanced)</a>
          </li>
          <li>
            <a href="#leanpub-auto-usage">Usage</a>
          </li>
          <li>
            <a href="#leanpub-auto-reset">Reset</a>
          </li>
          <li>
            <a href="#leanpub-auto-steps">Steps</a>
            <ul>
              <li>
                <a href="#leanpub-auto-hello-world">Hello World</a>
              </li>
              <li>
                <a href="#leanpub-auto-jade">Jade</a>
              </li>
              <li>
                <a href="#leanpub-auto-good-old-form">Good Old Form</a>
              </li>
              <li>
                <a href="#leanpub-auto-static">Static</a>
              </li>
              <li>
                <a href="#leanpub-auto-stylish-css">Stylish CSS</a>
              </li>
              <li>
                <a href="#leanpub-auto-param-pam-pam">Param Pam Pam</a>
              </li>
              <li>
                <a href="#leanpub-auto-whats-in-query">What’s in Query</a>
              </li>
              <li>
                <a href="#leanpub-auto-json-me">JSON Me</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href="#related-reading-and-resources">Related Reading and Resources</a>
        <ul>
          <li>
            <a href="#leanpub-auto-other-nodejs-frameworks">Other Node.js Frameworks</a>
          </li>
          <li>
            <a href="#leanpub-auto-nodejs-books">Node.js Books</a>
          </li>
          <li>
            <a href="#leanpub-auto-javascript-classics">JavaScript Classics</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main">
<h2 id="leanpub-auto-foreword">Foreword</h2>

<p>Dear reader, you are holding a book which will open you to understanding and fluent usage of the Express.js framework — <em>de facto</em> standard in web application programming on Node.js. I would especially recommend this book because it was written by a practicing engineer, one who has a comprehensive knowledge about the full stack of web application development and Express.js in particular.</p>

<p>Azat and I worked on the same Node.js/Express.js code base at <a href="http://storify.com">Storify</a> — the social media curation tool that Washington Post, CNN, BBC, The White House and other news corps use — which was recently acquired by <a href="http://livefyre.com">LiveFyre</a>. Right before the Express.js Guide release, he asked me to write the foreword, because it’ll sound objective, sincere and unbiased coming from the creator of <strong>another</strong> Node.js framework: <a href="http://compoundjs.com">CompoundJS</a>.</p>

<p>However, nobody is reading forewords. So, instead of a foreword, I’ll share my story. Actually, I never thought it was worth sharing and there’s definitely nothing exciting about it. But from the other point of view — thousands of young programmers living similar ordinary lives - it could be inspiring: it’s a common story, but a kind of successful one.</p>

<p>My way to web development started when I was a student and joined a team as junior PHP programmer. I was working here for about five years and the main lesson I have learned was: education is nothing compared to real work experience. The next page of my professional life was work in outsourcing (PHP and Ruby on Rails). And then I found Node.js.</p>

<p>It was something that I always wanted: processes that do not have to wait for DB/IO operations which are keeping all the resources, but doing something useful instead. This is the simple reason why I started using it; it’s more efficient compared to synchronous programming environments. By “efficient” I do not mean not speed of processing, but more flexibility in programming style.</p>

<p>As a good example of this flexibility, I can share some solutions I recently programmed for a Redis adapter for the <a href="https://github.com/1602/jugglingdb">Jugglingdb ORM</a>. Problem: during peaks of website usage, we are running a lot of db queries to serve pages, and most of the queries are the same. The obvious solution is to cache results of the queries, but this solution requires additional coding and some logic for cache invalidation. We’ve come with a better solution: cache queries and not results. When a query comes, we don’t execute it immediately; instead, we wait for some time, collect identical queries, then execute query once and run multiple callbacks to serve all clients. This solution is simple and requires no additional logic. As a result, we have flat db usage even during peaks. This solution is natural in Node.js, and that’s why Node.js rocks!</p>

<p>Life after discovering Node.js was great, full of interesting challenges and work, but one thing was annoying: each time I start a new project, I have to do almost the same work to organize code. For me as a Rails developer, it was really great to be able to create well-structured MVC applications fast, generate scaffolding controllers / views and other stuff. But this kind of tool was missing in Node.js and that’s why I spent my Christmas holidays writing it; the project was called express-on-railway at first, then RailwayJS, then CompoundJS.</p>

<p>The main goal of this project was to bring structure to an Express.js application, add the ability to extend applications in a standard way, and generate application code. So, it was not a new framework, but just Express.js with decent MVC structure, which is good for developers who don’t need to learn anything but Express.js to be able to understand what’s going on in CompoundJS application. And it was a kind of piggybacking on Express.js and Rails experience: the idea was to get best ideas from rails and bring to node platform, and Express.js was selected as the base because it is the most popular framework for Node.js and has a relatively big community, so I won’t be alone with my “new framework”. It was the start of my open-source years, which completely changed my attitude to programming and all matters, but that is another story.</p>

<p>And what can I say to conclude: web development in Node.js started with Express.js. It is a minimalistic and a robust framework which gives you all you need to build decent web applications. Even if you decide to move to some more advanced frameworks at some point, Express.js knowledge is a basic skill you have to learn. In addition, this book contains everything you need to know to start using Express.js and clearly explains all concepts and answers to most of the questions that newcomers usually ask. For these reasons, this book is a must-read!</p>

<p>–</p>

<p>Anatoliy Chakkaev,</p>

<p>Creator of <a href="http://compoundjs.com">CompoundJS</a> and <a href="http://jugglingdb.co/">JugglingDB</a></p>

<h2 id="leanpub-auto-acknowledgment">Acknowledgment</h2>

<p>This book would not be possible without the existence of my parents, the Internet and JavaScript. Also, words cannot express my gratitude to Tony Phillips, Shawn Drost, Douglas Calhoun and Marcus Phillips for founding HackReactor and helping many people venture into new careers.</p>

<p>In addition to that special thanks to General Assembly, pariSOMA and Marakana for giving me opportunities to test my instructions; to Peter Armstrong for LeanPub; to Sahil Lavingia for Gumroad; to Daring Fireball for Markdown; to Metaclassy for Byword; to Fred Zirdung for advices; to Janet Williams for editing; and to Rachmad Adv for the splendid cover!</p>

<h2 id="introduction">Introduction</h2>

<div class="aside sidebarish">
  <h3 id="leanpub-auto-summary">Summary</h3>

  <p>In this part, we’ll go over why this book was written, who might benefit from the book and how to use it most efficiently.</p>

</div>

<h3 id="leanpub-auto-why">Why</h3>

<p>Express.js is the most popular Node.js web framework yet. As of this writing (September of 2013), there are no books that are solely dedicated to it. Its official website has bits of insights for advanced Node.js programmers. However, I found that many people — including those who go through <a href="http://hackreactor.com">HackReactor</a> program and come to my Node.js classes at General Assembly and pariSOMA — are interested in a comprehensive resource. The one that would cover all the different components of Express.js work together in a real production-like application. The goal of Express.js Guide is to become such resource.</p>

<h3 id="leanpub-auto-what-this-book-is">What This Book is</h3>

<p>Express.js Guide is a concise book on <strong>one</strong> particular library. This book contains Express.js API <a href="https://github.com/visionmedia/express/tree/3.3.5">3.3.5</a> description, the best practices on code organization and patterns, real-world examples of web apps. The topics include but not limited to middleware, command-line interface and scaffolding, rendering templates, extracting params from dynamic URLs, parsing payloads and cookies, managing authentication with sessions, error handling and prepping apps for production.</p>

<p>For more details and for what exactly the book covers, please refer to the <strong>Table of Contents</strong>.</p>

<h3 id="leanpub-auto-what-this-book-is-not">What This Book is Not</h3>

<p>This book is <strong>not</strong> an introduction to Node.js, nor is it a book that covers all aspects of building a modern day web application, e.g., websockets, databases and (of course) front-end development. Keep in mind that readers also <strong>won’t find</strong> in Express.js Guide a resource for learning programming and/or JavaScript fundamentals.</p>

<p>You might want to take a look at <a href="http://rpjs.co">Rapid Prototyping with JS</a> for the introduction to Node.js, MongoDB and front-end development with Backbone.js.</p>

<p>In the real-world and especially in Node.js development, due to its modularized philosophy, we seldom use just a single framework. In the book, we have tried to stick only to Express.js and leave everything else out as much as possible, without compromising the usefulness of examples. Therefore, we intentionally left out some important chunks of web developments, for example databases, authentication and testing. Although these elements are present in tutorials and examples, they’re not explained in detail. For those materials, you could check books in the <a href="#related-reading-and-resources">Related Reading and Resources</a> section at the end of the book.</p>

<h3 id="leanpub-auto-who-this-book-is-for">Who This Book is For</h3>

<p>This book is for people fluent in programming and front-end JavaScript. In addition, to get the most benefits, readers must be familiar with basic Node.js concepts like <code>process</code> and <code>global</code>, and know core modules, including streams, clusters and buffer type.</p>

<p>If you’re thinking of starting a Node.js app, or of rewriting an existing one, and your weapon of choice is Express.js — this guide is for you! It will answer most of your “how” and “why” questions.</p>

<h3 id="leanpub-auto-notation">Notation</h3>

<p>The code blocks will look like this: <code>console.log('Hello reader!');</code>. The terminal and console commands will have prefixes <code>$</code> and <code>&gt;</code> correspondingly.</p>

<p>If we mention and use a specific file or a folder, those names will be monospaced as well: <code>index.js</code>.</p>

<p>If there is a class or a module name in the text, it’ll be emboldened, e.g., <strong>superagent</strong>.</p>

<p>The new resources will be hot-linked only the first time we mention them.</p>

<h3 id="leanpub-auto-navigation">Navigation</h3>

<p>In PDF, EPUB/iPad and Mobi/Kindle versions, you could use the <strong>Table of Contents</strong>, which is in the beginning of the book and has internal links, to jump to the most interesting parts or chapters.</p>

<p>For faster navigation between parts, chapters and sections of the book, please use the book’s navigation pane which is based on the Table of Contents (the screenshot is below).</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/navigation.png" alt="The Table of Contents pane in the Mac OS X Preview app."><p class="caption">The Table of Contents pane in the Mac OS X Preview app.</p>
</div>

<p>PDF version of the book is suitable for printing on US Letter paper because all links are in the footnotes.</p>

<h3 id="leanpub-auto-how-to-use-the-book">How to Use the Book</h3>

<p>If you’re contemplating using Express.js or writing an app with it, read the whole book from top to bottom. However, if you’re somewhat familiar with the framework, jump straight to the question at hand. You can also skim through them later and more advanced chapters that deal with code organization and getting apps production.</p>

<h3 id="leanpub-auto-examples">Examples</h3>

<p>The book contains code snippets and run-ready examples. The latter is available in GitHub repository at <a href="http://github.com/azat-co/expressjsguide">github.com/azat-co/expressjsguide</a>. Additional examples are in <a href="http://github.com/azat-co/todo-express">http://github.com/azat-co/todo-express</a>, <a href="http://github.com/azat-co/sfy-gallery">github.com/azat-co/sfy-gallery</a> and <a href="http://github.com/azat-co/expressjsguide">github.com/azat-co/hackhall</a>.</p>

<p>The provided examples were written and tested with the specific versions of dependencies only. Because Node.js and its ecosystem of modules are being developed rapidly, please pay attention whether the new versions have breaking changes or not. Here is the list of versions that we used:</p>

<ul>
<li>Express.js v3.3.5</li>
  <li>Google Chrome Version 28.0.1500.95</li>
  <li>Node.js v0.10.12</li>
  <li>MongoDB v2.2.2</li>
  <li>Redis v2.6.7</li>
  <li>NPM v1.2.32</li>
</ul>


<h3 id="leanpub-auto-contact-us">Contact Us</h3>

<p>Let’s be friends on the Internet!</p>

<ul>
<li>Tweet Node.js question on Twitter: <a href="https://twitter.com/azat_co">@azat_co</a>
</li>
  <li>Follow on Facebook: <a href="https://www.facebook.com/azat.mardanov">facebook.com/azat.mardanov</a>
</li>
  <li>Website: <a href="http://expressjsguide.com/">expressjsguide.com</a>
</li>
  <li>GitHub: <a href="https://github.com/azat-co/expressjsguide">github.com/azat-co/rpjs</a>
</li>
</ul>
<p><strong>Other Ways to Reach Us</strong></p>

<ul>
<li>Email Azat directly: <a href="mailto:hi@azat.co">hi@azat.co</a>
</li>
  <li>Google Group: <a href="mailto:rpjs@googlegroups.com">rpjs@googlegroups.com</a> and <a href="https://groups.google.com/forum/#!forum/rpjs">https://groups.google.com/forum/#!forum/rpjs</a>
</li>
  <li>Blog: <a href="http://webapplog.com">webapplog.com</a>
</li>
  <li>
<a href="http://hackhall.com">HackHall</a>: community for hackers, hipsters and pirates</li>
</ul>
<p><strong>Share on Twitter</strong> with ClickToTweet link: <a href="http://clicktotweet.com/HDUx0">http://clicktotweet.com/HDUx0</a>, or just click:</p>

<blockquote>
  <p><a href="http://clicktotweet.com/HDUx0">“I’m reading Express.js Guide — the most popular Node.js framework’s manual by @azat_co #RPJS”</a></p>
</blockquote>

<!-- begin mainmatter -->
<h1 id="leanpub-auto-quick-start">
<span class="section-number">I. </span>Quick Start</h1>

  <blockquote>
    <p>This is a sample. Read the full version of Express.js Guide at <a href="http://gum.co/express">gum.co/express</a> or jump to Express.js Guide <a href="#packages">packages and pricing</a>.</p>
  </blockquote>
  <p>In this part, we’ll briefly go over what Express.js is, install it, build a few simple applications and begin to touch on configurations.</p>


<h1 id="leanpub-auto-the-interface">
<span class="section-number">II. </span>The Interface</h1>

  <p>This part can be used as a stand alone reference for the Express.js API, because it contains description of all the main methods and properties, as well as short examples and explanations.</p>

  <blockquote>
    <p>This is a sample. Read the full version of Express.js Guide at <a href="http://gum.co/express">gum.co/express</a> or jump to Express.js Guide <a href="#packages">packages and pricing</a>.</p>
  </blockquote>



<h1 id="leanpub-auto-tips-and-tricks">
<span class="section-number">III. </span>Tips and Tricks</h1>

  <blockquote>
    <p>This is a sample. Read the full version of Express.js Guide at <a href="http://gum.co/express">gum.co/express</a> or jump to Express.js Guide <a href="#packages">packages and pricing</a>.</p>
  </blockquote>

  <p>In this part we’ll cover some common patterns for Node.js/Express.js development such as code organization, streams, Redis, clusters, authentication, Stylus, LESS and SASS, domains, security and Socket.IO.</p>


<h1 id="tutorials-and-examples">
<span class="section-number">IV. </span>Tutorials and Examples</h1>
  <blockquote>
    <p>This is a sample. Read the full version of Express.js Guide at <a href="http://gum.co/express">gum.co/express</a> or jump to Express.js Guide <a href="#packages">packages and pricing</a>.</p>
  </blockquote>
<div class="aside sidebarish">
  <h3 id="leanpub-auto-summary-1">Summary</h3>

  <p>This part has tutorials which are step-by-step learning guides, and examples that are more complex but less meticulous. The former group includes Instagram Gallery, Todo App and REST API. They’ll introduce readers to how Express.js interacts with other aspects of web services. We’ll learn how to make requests to a third-party site, connect to a database and perform CRUD (create, read, update and delete) operations on it, render Jade templates, compile LESS stylesheets, utilize CSRF and build Mocha tests. The HackHall example on the other hand, can serve as a reference and give you hints on how to use Mongoose, OAuth, sessions and prepare the app for deployment.</p>

</div>

<h2 id="leanpub-auto-instagram-gallery">
<span class="section-number">1 </span>Instagram Gallery</h2>

<div class="aside sidebarish">
  <h3 id="leanpub-auto-summary-2">Summary</h3>

  <p>This tutorial will demonstrate how to use Express.js external third-party services. In this tutorial, in addition to Express.js, we’ll use Instagram photos via Storify API, superagent, consolidate and handlebars modules.</p>

</div>

<table class="exercise sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="https://leanpub.com/site_images/express/leanpub_exercise.png" alt="exercise">
</td>
    <td>
      <h3 id="leanpub-auto-example">Example</h3>

  <p>The full source code of this example is available at <a href="https://github.com/azat-co/sfy-gallery">https://github.com/azat-co/sfy-gallery</a>.</p>

    </td>
  </tr></tbody></table>
<p><a href="http://storify.com">Storify</a> runs on <a href="http://nodejs.org">Node.js</a> and <a href="http://expressjs.com">Express.js</a>; therefore, why not use these technologies to write an application that demonstrates how to build apps that rely on third-party APIs and HTTP requests to them?</p>

<p>The Instagram Gallery app will fetch a story object and display its title, description, and a gallery of the elements/images like this:</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/sfy-gallery.png" alt="Instagram Gallery: Storify API + Node.js = &lt;3 "><p class="caption">Instagram Gallery: Storify API + Node.js = &lt;3 </p>
</div>

<h3 id="leanpub-auto-a-file-structure">
<span class="section-number">1.1 </span>A File Structure</h3>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> - index.js
<code class="lineno">2</code> - package.json
<code class="lineno">3</code> - views/index.html
<code class="lineno">4</code> - css/bootstrap-responsive.min.css
<code class="lineno">5</code> - css/flatly-bootstrap.min.css
</pre></div>

</div>

<p>Where <code>index.js</code> is our main Node.js file and <code>index.html</code> the Handlebars template.</p>

<h3 id="leanpub-auto-dependencies">
<span class="section-number">1.2 </span>Dependencies</h3>

<p>Our dependencies include:</p>

<ul>
<li>express: 3.2.5 for Express.js framework</li>
  <li>superagent: 0.14.6 for making HTTP requests</li>
  <li>consolidate: 0.9.1 for using Handlebars with Express.js</li>
  <li>handlebars: 1.0.12 for using Handlebars template engine</li>
</ul>
<p>The <code>package.json</code> file:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="s">"name"</code><code class="o">:</code> <code class="s">"sfy-demo"</code><code class="p">,</code>
<code class="lineno"> 3</code>   <code class="s">"version"</code><code class="o">:</code> <code class="s">"0.0.0"</code><code class="p">,</code>
<code class="lineno"> 4</code>   <code class="s">"description"</code><code class="o">:</code> <code class="s">"Simple Node.js demo app on top of Storify API"</code><code class="p">,</code>
<code class="lineno"> 5</code>   <code class="s">"main"</code><code class="o">:</code> <code class="s">"index.js"</code><code class="p">,</code>
<code class="lineno"> 6</code>   <code class="s">"scripts"</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 7</code>     <code class="s">"test"</code><code class="o">:</code> <code class="s">"echo </code><code class="se">\"</code><code class="s">Error: no test specified</code><code class="se">\"</code><code class="s"> &amp;&amp; exit 1"</code>
<code class="lineno"> 8</code>   <code class="p">},</code>
<code class="lineno"> 9</code>   <code class="s">"dependencies"</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">10</code>     <code class="s">"express"</code><code class="o">:</code> <code class="s">"3.2.5"</code><code class="p">,</code>
<code class="lineno">11</code>     <code class="s">"superagent"</code><code class="o">:</code> <code class="s">"0.14.6"</code><code class="p">,</code>
<code class="lineno">12</code>     <code class="s">"consolidate"</code><code class="o">:</code> <code class="s">"0.9.1"</code><code class="p">,</code>
<code class="lineno">13</code>     <code class="s">"handlebars"</code><code class="o">:</code> <code class="s">"1.0.12"</code>
<code class="lineno">14</code>   <code class="p">},</code>
<code class="lineno">15</code>   <code class="s">"repository"</code><code class="o">:</code> <code class="s">""</code><code class="p">,</code>
<code class="lineno">16</code>   <code class="s">"author"</code><code class="o">:</code> <code class="s">"Azat Mardanov"</code><code class="p">,</code>
<code class="lineno">17</code>   <code class="s">"license"</code><code class="o">:</code> <code class="s">"BSD"</code>
<code class="lineno">18</code> <code class="p">}</code>
</pre></div>

</div>

<h3 id="leanpub-auto-nodejs-server">
<span class="section-number">1.3 </span>Node.js Server</h3>

<p>At the beginning of the file, we require dependencies:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
<code class="lineno">2</code> <code class="kd">var</code> <code class="nx">superagent</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'superagent'</code><code class="p">);</code>
<code class="lineno">3</code> <code class="kd">var</code> <code class="nx">consolidate</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'consolidate'</code><code class="p">);</code>
<code class="lineno">4</code>
<code class="lineno">5</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
</pre></div>

</div>

<p>Then, configure template engine:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">engine</code><code class="p">(</code><code class="s1">'html'</code><code class="p">,</code> <code class="nx">consolidate</code><code class="p">.</code><code class="nx">handlebars</code><code class="p">);</code>
<code class="lineno">2</code> <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view engine'</code><code class="p">,</code> <code class="s1">'html'</code><code class="p">);</code>
<code class="lineno">3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'views'</code><code class="p">,</code> <code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/views'</code><code class="p">);</code>
</pre></div>

</div>

<p>Set up a static folder middleware:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/public'</code><code class="p">));</code>
</pre></div>

</div>

<p>If you want to serve any other story, feel free to do so. All you need is the username of the author and the story slug, for my gallery of the capitol of Tatarstan, <a href="http://en.wikipedia.org/wiki/Kazan">Kazan</a>, leave the following:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">user</code> <code class="o">=</code> <code class="s1">'azat_co'</code><code class="p">;</code>
<code class="lineno">2</code> <code class="kd">var</code> <code class="nx">story_slug</code> <code class="o">=</code> <code class="s1">'kazan'</code><code class="p">;</code>
</pre></div>

</div>

<p>Paste your values, i.e., Storify API key, username and _token if you have one. As of this writing, Storify API is public, meaning there is no need for the authentication. In case this changes in the future, please obtain your sign up for an API key at <a href="http://dev.storify.com/request">http://dev.storify.com/request</a> or follow the official documentation at <a href="http://dev.storify.com">dev.storify.com</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">api_key</code> <code class="o">=</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno">2</code> <code class="kd">var</code> <code class="nx">username</code> <code class="o">=</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno">3</code> <code class="kd">var</code> <code class="nx">_token</code> <code class="o">=</code> <code class="s2">""</code><code class="p">;</code>
</pre></div>

</div>

<p>Let’s define the home route:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code><code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
</pre></div>

</div>

<p>Now we’ll fetch elements from Storify API the route’s callback:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   <code class="nx">superagent</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s2">"http://api.storify.com/v1/stories/"</code>
<code class="lineno">2</code>     <code class="o">+</code> <code class="nx">user</code> <code class="o">+</code> <code class="s2">"/"</code> <code class="o">+</code> <code class="nx">story_slug</code><code class="p">)</code>
<code class="lineno">3</code>     <code class="p">.</code><code class="nx">query</code><code class="p">({</code><code class="nx">api_key</code><code class="o">:</code> <code class="nx">api_key</code><code class="p">,</code>
<code class="lineno">4</code>       <code class="nx">username</code><code class="o">:</code> <code class="nx">username</code><code class="p">,</code>
<code class="lineno">5</code>       <code class="nx">_token</code><code class="o">:</code> <code class="nx">_token</code><code class="p">})</code>
<code class="lineno">6</code>     <code class="p">.</code><code class="nx">set</code><code class="p">({</code>  <code class="nx">Accept</code><code class="o">:</code> <code class="s1">'application/json'</code> <code class="p">})</code>
<code class="lineno">7</code>     <code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">storifyResponse</code><code class="p">){</code>
<code class="lineno">8</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">);</code>
</pre></div>

</div>

<p>To render the template with the story object which is in the HTTP response bodyâ€™s content property:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>       <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'index'</code><code class="p">,</code> <code class="nx">storifyResponse</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">content</code><code class="p">);</code>
<code class="lineno">2</code>     <code class="p">})</code>
<code class="lineno">3</code>
<code class="lineno">4</code> <code class="p">})</code>
<code class="lineno">5</code>
<code class="lineno">6</code> <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="mi">3001</code><code class="p">);</code>
</pre></div>

</div>

<h3 id="leanpub-auto-handlebars-template">
<span class="section-number">1.4 </span>Handlebars Template</h3>

<p>The <code>views/index.html</code> file:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="cp">&lt;!DOCTYPE html lang="en"&gt;</code>
<code class="lineno"> 2</code> <code class="nt">&lt;html&gt;</code>
<code class="lineno"> 3</code>   <code class="nt">&lt;head&gt;</code>
<code class="lineno"> 4</code>     <code class="nt">&lt;link</code> <code class="na">type=</code><code class="s">"text/css"</code>
<code class="lineno"> 5</code>       <code class="na">href=</code><code class="s">"css/flatly-bootstrap.min.css"</code>
<code class="lineno"> 6</code>       <code class="na">rel=</code><code class="s">"stylesheet"</code> <code class="nt">/&gt;</code>
<code class="lineno"> 7</code>     <code class="nt">&lt;link</code> <code class="na">type=</code><code class="s">"text/css"</code>
<code class="lineno"> 8</code>       <code class="na">href=</code><code class="s">"css/bootstrap-responsive.min.css"</code>
<code class="lineno"> 9</code>       <code class="na">rel=</code><code class="s">"stylesheet"</code><code class="nt">/&gt;</code>
<code class="lineno">10</code>   <code class="nt">&lt;/head&gt;</code>
<code class="lineno">11</code>
<code class="lineno">12</code>   <code class="nt">&lt;body</code> <code class="na">class=</code><code class="s">"container"</code><code class="nt">&gt;</code>
<code class="lineno">13</code>     <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"row"</code><code class="nt">&gt;</code>
<code class="lineno">14</code>       <code class="nt">&lt;h1&gt;</code>{{title}}<code class="nt">&lt;small&gt;</code> by {{author.name}}<code class="nt">&lt;/small&gt;&lt;/h1&gt;</code>
<code class="lineno">15</code>       <code class="nt">&lt;p&gt;</code>{{description}}<code class="nt">&lt;/p&gt;</code>
<code class="lineno">16</code>     <code class="nt">&lt;/div&gt;</code>
<code class="lineno">17</code>     <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"row"</code><code class="nt">&gt;</code>
<code class="lineno">18</code>       <code class="nt">&lt;ul</code> <code class="na">class=</code><code class="s">"thumbnails"</code><code class="nt">&gt;</code>
<code class="lineno">19</code>       {{#each elements}}
<code class="lineno">20</code>         <code class="nt">&lt;li</code> <code class="na">class=</code><code class="s">"span3"</code><code class="nt">&gt;</code>
<code class="lineno">21</code>           <code class="nt">&lt;a</code> <code class="na">class=</code><code class="s">"thumbnail"</code> <code class="na">href=</code><code class="s">"{{permalink}}"</code>
<code class="lineno">22</code>           <code class="na">target=</code><code class="s">"_blank"</code><code class="nt">&gt;</code>
<code class="lineno">23</code>             <code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"{{data.image.src}}"</code>
<code class="lineno">24</code>               <code class="na">title=</code><code class="s">"{{data.image.caption}}"</code> <code class="nt">/&gt;</code>
<code class="lineno">25</code>           <code class="nt">&lt;/a&gt;</code>
<code class="lineno">26</code>         <code class="nt">&lt;/li&gt;</code>
<code class="lineno">27</code>       {{/each}}
<code class="lineno">28</code>       <code class="nt">&lt;/ul&gt;</code>
<code class="lineno">29</code>     <code class="nt">&lt;/div&gt;</code>
<code class="lineno">30</code>   <code class="nt">&lt;/body&gt;</code>
<code class="lineno">31</code>
<code class="lineno">32</code> <code class="nt">&lt;/html&gt;</code>
</pre></div>

</div>

<h3 id="leanpub-auto-conclusion">
<span class="section-number">1.5 </span>Conclusion</h3>

<p>Express.js and superagent allow developers to retrieve and manipulate data provided by third-party services such as Storify, Twitter and Facebook in just a few lines of code.</p>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="https://leanpub.com/site_images/express/leanpub_information.png" alt="information">
</td>
    <td>
      <h3 id="leanpub-auto-note">Note</h3>

  <p>In most cases, service providers (such as Google, Facebook and Twitter) require authentication (which is not the case with Storify API as of this writing). To make OAuth 1.0, OAuth 2.0 and OAuth Echo requests, consider <a href="https://npmjs.org/package/oauth">oauth</a> (<a href="https://github.com/ciaranj/node-oauth">GitHub</a>), <a href="https://npmjs.org/package/everyauth">everyauth</a> (<a href="https://github.com/bnoguchi/everyauth">GitHub</a>) and/or <a href="http://passportjs.org/">Passport</a>(<a href="http://passportjs.org/">website</a> and <a href="https://github.com/jaredhanson/passport">GitHub</a>).</p>

    </td>
  </tr></tbody></table>
<h2 id="leanpub-auto-todo-app">
<span class="section-number">2 </span>Todo App</h2>

<div class="aside sidebarish">
  <h3 id="leanpub-auto-summary-3">Summary</h3>

  <p>Todo apps are considered to be quintessential in showcasing frameworks akin to famous <a href="http://todomvc.com">Todomvc.com</a> for front-end JavaScript frameworks. In this example, we’ll use Jade, forms, LESS, AJAX/XHR and CSRF.</p>

</div>

<p>In our Todo app, we’ll intentionally not use Backbone.js or Angular to demonstrate how to build <em>traditional</em> websites with the use of forms and redirects. In addition to that, we’ll explain how to plug-in CSRF and LESS.</p>

<table class="exercise sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="https://leanpub.com/site_images/express/leanpub_exercise.png" alt="exercise">
</td>
    <td>
      <h3 id="leanpub-auto-example-1">Example</h3>

  <p>All the source code is in the <a href="http://github.com/azat-co/todo-express">github.com/azat-co/todo-express</a> for your convenience.</p>

    </td>
  </tr></tbody></table>
<p>Here are some screenshots of Todo app in which we start from a home page:</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/todo-home.png" alt="The Todo app home page."><p class="caption">The Todo app home page.</p>
</div>

<p>There’s an empty list (unless you played with this app before):</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/todo-list-empty.png" alt="The empty Todo List page."><p class="caption">The empty Todo List page.</p>
</div>

<p>Now we can add four items to the Todo List:</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/todo-list-added.png" alt="The Todo List page with added items."><p class="caption">The Todo List page with added items.</p>
</div>

<p>Mark one of the tasks as “done”, e.g.. “Buy milk”:</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/todo-list-done.png" alt="The Todo List page with one item marked done."><p class="caption">The Todo List page with one item marked done.</p>
</div>

<p>Going to the Complete page reveals this <em>done</em> item:</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/todo-completed.png" alt="The Todo app Completed page."><p class="caption">The Todo app Completed page.</p>
</div>

<p>Deletion of an item from the Todo list is the only action performed via AJAX/XHR request. The rest of the logic is done via GETs and POSTs (by forms).</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/todo-removed.png" alt="The Todo List page with a removed tasks."><p class="caption">The Todo List page with a removed tasks.</p>
</div>

<h3 id="leanpub-auto-scaffolding">
<span class="section-number">2.1 </span>Scaffolding</h3>

<p>As usual, we start by running</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>express todo-express
<code class="lineno">2</code> <code class="nv">$ </code><code class="nb">cd </code>todo-express
<code class="lineno">3</code> <code class="nv">$ </code>npm install
</pre></div>

</div>

<p>This will give us the basic Express.js application.</p>

<p>We’ll need to add two extra dependencies to <code>package.json</code>, the less-middleware and Mongoskin libraries:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>npm install less-middleware --save
<code class="lineno">2</code> <code class="nv">$ </code>npm install mongoskin --save
</pre></div>

</div>

<p>Changing the name to <code>todo-express</code> is optional:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="s">"name"</code><code class="o">:</code> <code class="s">"todo-express"</code><code class="p">,</code>
<code class="lineno"> 3</code>   <code class="s">"version"</code><code class="o">:</code> <code class="s">"0.0.1"</code><code class="p">,</code>
<code class="lineno"> 4</code>   <code class="s">"private"</code><code class="o">:</code> <code class="nb">true</code><code class="p">,</code>
<code class="lineno"> 5</code>   <code class="s">"scripts"</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 6</code>     <code class="s">"start"</code><code class="o">:</code> <code class="s">"node app.js"</code>
<code class="lineno"> 7</code>   <code class="p">},</code>
<code class="lineno"> 8</code>   <code class="s">"dependencies"</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 9</code>     <code class="s">"express"</code><code class="o">:</code> <code class="s">"3.3.5"</code><code class="p">,</code>
<code class="lineno">10</code>     <code class="s">"jade"</code><code class="o">:</code> <code class="s">"*"</code><code class="p">,</code>
<code class="lineno">11</code>     <code class="s">"mongoskin"</code><code class="o">:</code> <code class="s">"~0.6.0"</code><code class="p">,</code>
<code class="lineno">12</code>     <code class="s">"less-middleware"</code><code class="o">:</code> <code class="s">"~0.1.12"</code>
<code class="lineno">13</code>   <code class="p">}</code>
<code class="lineno">14</code> <code class="p">}</code>
</pre></div>

</div>

<h3 id="leanpub-auto-mongodb">
<span class="section-number">2.2 </span>MongoDB</h3>

<p>Install MongoDB if you don’t have it already.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>brew update
<code class="lineno">2</code> <code class="nv">$ </code>brew install mongodb
<code class="lineno">3</code> <code class="nv">$ </code>mongo --version
</pre></div>

</div>
<p>For more flavors of MongoDB installation, check out <a href="http://docs.mongodb.org/manual/tutorial/install-mongodb-on-os-x/">the official docs</a>.</p>

<h3 id="leanpub-auto-structure">
<span class="section-number">2.3 </span>Structure</h3>

<p>The final version of the app has the following folder/file structure (<a href="http://github.com/azat-co/todo-express">GitHub</a>):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> /todo-express
<code class="lineno"> 2</code>   /public
<code class="lineno"> 3</code>     /bootstrap
<code class="lineno"> 4</code>       *.less
<code class="lineno"> 5</code>     /images
<code class="lineno"> 6</code>     /javascripts
<code class="lineno"> 7</code>       main.js
<code class="lineno"> 8</code>       jquery.js
<code class="lineno"> 9</code>     /stylesheets
<code class="lineno">10</code>       style.css
<code class="lineno">11</code>       main.less
<code class="lineno">12</code>   /routes
<code class="lineno">13</code>     tasks.js
<code class="lineno">14</code>     index.js
<code class="lineno">15</code>   /views
<code class="lineno">16</code>     tasks_completed.jade
<code class="lineno">17</code>     layout.jade
<code class="lineno">18</code>     index.jade
<code class="lineno">19</code>     tasks.jade
<code class="lineno">20</code>   app.js
<code class="lineno">21</code>   readme.md
<code class="lineno">22</code>   package.json
</pre></div>

</div>

<p>The <code>*.less</code> in <code>bootstrap</code> folder means there are bunch of <a href="http://getbootstrap.com/">Twitter Bootstrap</a> (the CSS framework) source files. They’re available at <a href="https://github.com/twbs/bootstrap/tree/master/less">GitHub</a>.</p>

<h3 id="leanpub-auto-appjs">
<span class="section-number">2.4 </span>app.js</h3>

<p>This is a break down of the Express.js generated <code>app.js</code> file with addition of routes, database, session, LESS and param middlewares.</p>

<p>Firstly, we import dependencies with Node.js global <code>require()</code> function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
</pre></div>

</div>

<p>Similarly, we get access to our own modules which are app’s routes:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">routes</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./routes'</code><code class="p">);</code>
<code class="lineno">2</code> <code class="kd">var</code> <code class="nx">tasks</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./routes/tasks'</code><code class="p">);</code>
</pre></div>

</div>

<p>The core <code>http</code> and <code>path</code> modules will be needed as well:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">);</code>
<code class="lineno">2</code> <code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'path'</code><code class="p">);</code>
</pre></div>

</div>

<p>Mongoskin is a better alternative to the native MongoDB driver:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">mongoskin</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongoskin'</code><code class="p">);</code>
</pre></div>

</div>

<p>One line is all we need to get the database connection object. The first param follows standard URI convention of <code>protocol://username:password@host:port/database</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">mongoskin</code><code class="p">.</code><code class="nx">db</code><code class="p">(</code><code class="s1">'mongodb://localhost:27017/todo?auto_reconnect'</code><code class="p">,</code> <code class="p">{</code><code class="nx">safe</code><code class="o">:</code><code class="kc">true</code><code class="o">\</code>
<code class="lineno">2</code> <code class="p">});</code>
</pre></div>

</div>

<p>The app itself:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
</pre></div>

</div>

<p>In this middleware, we <em>export</em> the database object to all middlewares. By doing so, we’ll be able to perform database operations in the routes modules:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code> <code class="o">=</code> <code class="p">{};</code>
</pre></div>

</div>

<p>We just store the tasks collection in every request:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">collection</code><code class="p">(</code><code class="s1">'tasks'</code><code class="p">);</code>
<code class="lineno">2</code>   <code class="nx">next</code><code class="p">();</code>
<code class="lineno">3</code> <code class="p">})</code>
</pre></div>

</div>

<p>This  line allows us to access <code>appname</code> from within every jade template:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">locals</code><code class="p">.</code><code class="nx">appname</code> <code class="o">=</code> <code class="s1">'Express.js Todo App'</code>
</pre></div>

</div>

<p>We set the server port to either the environment variable or if that’s undefined to 3000:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'port'</code><code class="p">,</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code><code class="p">);</code>
</pre></div>

</div>

<p>These statements tell Express.js where templates live and what file extension to prepend in case the extension is omitted during the <code>render</code> calls:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'views'</code><code class="p">,</code> <code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/views'</code><code class="p">);</code>
<code class="lineno">2</code> <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view engine'</code><code class="p">,</code> <code class="s1">'jade'</code><code class="p">);</code>
</pre></div>

</div>

<p>Display Express.js favicon (the graphic in the URL address bar of browsers):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">favicon</code><code class="p">());</code>
</pre></div>

</div>

<p>Out-of-the-box logger will print requests in the terminal window:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">logger</code><code class="p">(</code><code class="s1">'dev'</code><code class="p">));</code>
</pre></div>

</div>

<p>The <code>bodyParser()</code> middleware is needed for painlessly accessing incoming data:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">bodyParser</code><code class="p">());</code>
</pre></div>

</div>

<p>The <code>methodOverride()</code> middleware is a work around for HTTP methods that involve headers. It’s not essential for this example, but we’ll leave it here:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">methodOverride</code><code class="p">());</code>
</pre></div>

</div>

<p>To use CSRF, we need <code>cookieParser()</code> and <code>session()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">cookieParser</code><code class="p">());</code>
<code class="lineno">2</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">session</code><code class="p">({</code>
<code class="lineno">3</code>   <code class="nx">secret</code><code class="o">:</code> <code class="s1">'59B93087-78BC-4EB9-993A-A61FC844F6C9'</code>
<code class="lineno">4</code> <code class="p">}));</code>
</pre></div>

</div>

<p>The <code>csrf()</code> middleware itself. The order is important; in other words, <code>csrf()</code> <strong>must</strong> be preceded by <code>cookieParser()</code> and <code>session()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">csrf</code><code class="p">());</code>
</pre></div>

</div>

<p>To process LESS stylesheets into CSS ones, we utilize <code>less-middleware</code> in this manner:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">require</code><code class="p">(</code><code class="s1">'less-middleware'</code><code class="p">)({</code>
<code class="lineno">2</code>   <code class="nx">src</code><code class="o">:</code> <code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/public'</code><code class="p">,</code>
<code class="lineno">3</code>   <code class="nx">compress</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">4</code> <code class="p">}));</code>
</pre></div>

</div>

<p>The other static files are also in the <code>public</code> folder:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'public'</code><code class="p">)));</code>
</pre></div>

</div>

<p>Remember CSRF? This is how we expose it to templates:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">locals</code><code class="p">.</code><code class="nx">_csrf</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">_csrf</code><code class="p">;</code>
<code class="lineno">3</code>   <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno">4</code> <code class="p">})</code>
</pre></div>

</div>

<p>The router plug-in is enabled by this statement. It’s important to have this line <strong>after</strong> <code>less-middleware</code> and <code>csrf()</code> lines above:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">router</code><code class="p">);</code>
</pre></div>

</div>

<p>It’s possible to configure different behavior based on environments:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="k">if</code> <code class="p">(</code><code class="s1">'development'</code> <code class="o">==</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'env'</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">errorHandler</code><code class="p">());</code>
<code class="lineno">3</code> <code class="p">}</code>
</pre></div>

</div>

<p>When there’s a request that matches route/RegExp with <code>:task_id</code> in it, this block is executed:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">param</code><code class="p">(</code><code class="s1">'task_id'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">,</code> <code class="nx">taskId</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</div>

<p>The value of task ID is in <code>taskId</code> and we query the database to find that object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">findById</code><code class="p">(</code><code class="nx">taskId</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">task</code><code class="p">){</code>
</pre></div>

</div>

<p>It’s very important to check for errors and empty results:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="lineno">2</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">task</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Task is not found.'</code><code class="p">));</code>
</pre></div>

</div>

<p>If there’s data, store it in the request and proceed to next middleware:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">task</code> <code class="o">=</code> <code class="nx">task</code><code class="p">;</code>
<code class="lineno">2</code>     <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno">3</code>   <code class="p">});</code>
<code class="lineno">4</code> <code class="p">});</code>
</pre></div>

</div>

<p>Now it’s time to define our routes. We start with home page:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">index</code><code class="p">);</code>
</pre></div>

</div>

<p>The Todo List page:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/tasks'</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">.</code><code class="nx">list</code><code class="p">);</code>
</pre></div>

</div>

<p>This route will mark all tasks in the todo list as completed if the user presses <em>all done</em> button. In a RESP API, the HTTP method would be PUT but because we’re building classical web apps with forms, we have to use POST:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/tasks'</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">.</code><code class="nx">markAllCompleted</code><code class="p">)</code>
</pre></div>

</div>

<p>The same URL for adding new tasks as for marking all tasks completed, but in the previous methods itself (<code>markAllCompleted</code>) you’ll see how we handle flow control:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/tasks'</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">.</code><code class="nx">add</code><code class="p">);</code>
</pre></div>

</div>

<p>To mark a single task completed, we use aforementioned <code>:task_id</code> string in our URL pattern. In REST API, this should have been a PUT request:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/tasks/:task_id'</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">.</code><code class="nx">markCompleted</code><code class="p">);</code>
</pre></div>

</div>

<p>Unlike with the POST route above, we utilize Express.js param middleware with <code>:task_id</code> token:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="s1">'/tasks/:task_id'</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">.</code><code class="nx">del</code><code class="p">);</code>
</pre></div>

</div>

<p>For our Completed page, we define this route:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/tasks/completed'</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">.</code><code class="nx">completed</code><code class="p">);</code>
</pre></div>

</div>

<p>In case of malicious attacks or mistyped URLs, it’s a user-friendly thing to catch all requests with <code>*</code>. Keep in mind that if we had a match previously, the Node.js won’t come to execute this block:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="s1">'*'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
<code class="lineno">2</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">404</code><code class="p">);</code>
<code class="lineno">3</code> <code class="p">})</code>
</pre></div>

</div>

<p>Finally, we spin up our application with good ‘ol <code>http</code> method:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">http</code><code class="p">.</code><code class="nx">createServer</code><code class="p">(</code><code class="nx">app</code><code class="p">).</code><code class="nx">listen</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">),</code>
<code class="lineno">2</code>   <code class="kd">function</code><code class="p">(){</code>
<code class="lineno">3</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Express server listening on port '</code>
<code class="lineno">4</code>       <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">));</code>
<code class="lineno">5</code>   <code class="p">}</code>
<code class="lineno">6</code> <code class="p">);</code>
</pre></div>

</div>

<p>The full content of <code>app.js</code> file:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="cm">/**</code>
<code class="lineno"> 2</code> <code class="cm"> * Module dependencies.</code>
<code class="lineno"> 3</code> <code class="cm"> */</code>
<code class="lineno"> 4</code>
<code class="lineno"> 5</code> <code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
<code class="lineno"> 6</code> <code class="kd">var</code> <code class="nx">routes</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./routes'</code><code class="p">);</code>
<code class="lineno"> 7</code> <code class="kd">var</code> <code class="nx">tasks</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./routes/tasks'</code><code class="p">);</code>
<code class="lineno"> 8</code> <code class="kd">var</code> <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">);</code>
<code class="lineno"> 9</code> <code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'path'</code><code class="p">);</code>
<code class="lineno">10</code> <code class="kd">var</code> <code class="nx">mongoskin</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongoskin'</code><code class="p">);</code>
<code class="lineno">11</code> <code class="kd">var</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">mongoskin</code><code class="p">.</code><code class="nx">db</code><code class="p">(</code><code class="s1">'mongodb://localhost:27017/todo?auto_reconnect'</code><code class="p">,</code> <code class="p">{</code><code class="nx">safe</code><code class="o">:</code><code class="kc">true</code><code class="o">\</code>
<code class="lineno">12</code> <code class="p">});</code>
<code class="lineno">13</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
<code class="lineno">14</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">15</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code> <code class="o">=</code> <code class="p">{};</code>
<code class="lineno">16</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">collection</code><code class="p">(</code><code class="s1">'tasks'</code><code class="p">);</code>
<code class="lineno">17</code>   <code class="nx">next</code><code class="p">();</code>
<code class="lineno">18</code> <code class="p">})</code>
<code class="lineno">19</code> <code class="nx">app</code><code class="p">.</code><code class="nx">locals</code><code class="p">.</code><code class="nx">appname</code> <code class="o">=</code> <code class="s1">'Express.js Todo App'</code>
<code class="lineno">20</code> <code class="c1">// all environments</code>
<code class="lineno">21</code>
<code class="lineno">22</code>
<code class="lineno">23</code> <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'port'</code><code class="p">,</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code><code class="p">);</code>
<code class="lineno">24</code> <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'views'</code><code class="p">,</code> <code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/views'</code><code class="p">);</code>
<code class="lineno">25</code> <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view engine'</code><code class="p">,</code> <code class="s1">'jade'</code><code class="p">);</code>
<code class="lineno">26</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">favicon</code><code class="p">());</code>
<code class="lineno">27</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">logger</code><code class="p">(</code><code class="s1">'dev'</code><code class="p">));</code>
<code class="lineno">28</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">bodyParser</code><code class="p">());</code>
<code class="lineno">29</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">methodOverride</code><code class="p">());</code>
<code class="lineno">30</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">cookieParser</code><code class="p">());</code>
<code class="lineno">31</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">session</code><code class="p">({</code><code class="nx">secret</code><code class="o">:</code> <code class="s1">'59B93087-78BC-4EB9-993A-A61FC844F6C9'</code><code class="p">}));</code>
<code class="lineno">32</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">csrf</code><code class="p">());</code>
<code class="lineno">33</code>
<code class="lineno">34</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">require</code><code class="p">(</code><code class="s1">'less-middleware'</code><code class="p">)({</code> <code class="nx">src</code><code class="o">:</code> <code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/public'</code><code class="p">,</code> <code class="nx">compress</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}</code><code class="o">\</code>
<code class="lineno">35</code> <code class="p">));</code>
<code class="lineno">36</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'public'</code><code class="p">)));</code>
<code class="lineno">37</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">38</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">locals</code><code class="p">.</code><code class="nx">_csrf</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">_csrf</code><code class="p">;</code>
<code class="lineno">39</code>   <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno">40</code> <code class="p">})</code>
<code class="lineno">41</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">router</code><code class="p">);</code>
<code class="lineno">42</code>
<code class="lineno">43</code> <code class="c1">// development only</code>
<code class="lineno">44</code> <code class="k">if</code> <code class="p">(</code><code class="s1">'development'</code> <code class="o">==</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'env'</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno">45</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">errorHandler</code><code class="p">());</code>
<code class="lineno">46</code> <code class="p">}</code>
<code class="lineno">47</code> <code class="nx">app</code><code class="p">.</code><code class="nx">param</code><code class="p">(</code><code class="s1">'task_id'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">,</code> <code class="nx">taskId</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">48</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">findById</code><code class="p">(</code><code class="nx">taskId</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">task</code><code class="p">){</code>
<code class="lineno">49</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="lineno">50</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">task</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Task is not found.'</code><code class="p">));</code>
<code class="lineno">51</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">task</code> <code class="o">=</code> <code class="nx">task</code><code class="p">;</code>
<code class="lineno">52</code>     <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno">53</code>   <code class="p">});</code>
<code class="lineno">54</code> <code class="p">});</code>
<code class="lineno">55</code>
<code class="lineno">56</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">index</code><code class="p">);</code>
<code class="lineno">57</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/tasks'</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">.</code><code class="nx">list</code><code class="p">);</code>
<code class="lineno">58</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/tasks'</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">.</code><code class="nx">markAllCompleted</code><code class="p">)</code>
<code class="lineno">59</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/tasks'</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">.</code><code class="nx">add</code><code class="p">);</code>
<code class="lineno">60</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/tasks/:task_id'</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">.</code><code class="nx">markCompleted</code><code class="p">);</code>
<code class="lineno">61</code> <code class="nx">app</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="s1">'/tasks/:task_id'</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">.</code><code class="nx">del</code><code class="p">);</code>
<code class="lineno">62</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/tasks/completed'</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">.</code><code class="nx">completed</code><code class="p">);</code>
<code class="lineno">63</code>
<code class="lineno">64</code> <code class="nx">app</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="s1">'*'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
<code class="lineno">65</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">404</code><code class="p">);</code>
<code class="lineno">66</code> <code class="p">})</code>
<code class="lineno">67</code> <code class="nx">http</code><code class="p">.</code><code class="nx">createServer</code><code class="p">(</code><code class="nx">app</code><code class="p">).</code><code class="nx">listen</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">),</code> <code class="kd">function</code><code class="p">(){</code>
<code class="lineno">68</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Express server listening on port '</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">));</code>
<code class="lineno">69</code> <code class="p">});</code>
</pre></div>

</div>

<h3 id="leanpub-auto-routes">
<span class="section-number">2.5 </span>Routes</h3>

<p>There are only two files in <code>routes</code> folder. One of them serves the home page (e.g., <a href="http://localhost:3000/">http://localhost:3000/</a>) and is straightforward:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="cm">/*</code>
<code class="lineno">2</code> <code class="cm"> * GET home page.</code>
<code class="lineno">3</code> <code class="cm"> */</code>
<code class="lineno">4</code>
<code class="lineno">5</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">index</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
<code class="lineno">6</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'index'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">title</code><code class="o">:</code> <code class="s1">'Express.js Todo App'</code> <code class="p">});</code>
<code class="lineno">7</code> <code class="p">};</code>
</pre></div>

</div>

<p>The remaining logic that deals with tasks itself has been placed in the <code>todo-express/routes/tasks.js</code>. Let’s break it down a bit.</p>

<p>We start by exporting <code>list()</code> request handler that gives us list of incomplete tasks:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">list</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">){</code>
</pre></div>

</div>

<p>To do so, we perform a database search with completed=false query:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno">2</code>     <code class="nx">completed</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno">3</code>   <code class="p">}).</code><code class="nx">toArray</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">){</code>
</pre></div>

</div>

<p>In the callback, we need to check for any errors:
<code>javascript
    if (error) return next(error);
</code></p>

<p>Since we use <code>toArray()</code>, we can send the date directly to the template:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'tasks'</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">2</code>       <code class="nx">title</code><code class="o">:</code> <code class="s1">'Todo List'</code><code class="p">,</code>
<code class="lineno">3</code>       <code class="nx">tasks</code><code class="o">:</code> <code class="nx">tasks</code> <code class="o">||</code> <code class="p">[]</code>
<code class="lineno">4</code>     <code class="p">});</code>
<code class="lineno">5</code>   <code class="p">});</code>
<code class="lineno">6</code> <code class="p">};</code>
</pre></div>

</div>

<p>Adding a new task requires us to check for the name parameter:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">add</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">){</code>
<code class="lineno">2</code>   <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code> <code class="o">||</code> <code class="o">!</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">name</code><code class="p">)</code>
<code class="lineno">3</code>     <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'No data provided.'</code><code class="p">));</code>
</pre></div>

</div>

<p>Thanks to our middleware, we already have a database collection in the <code>req</code> object, and the default value for the task is incomplete (<code>completed: false</code>):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">save</code><code class="p">({</code>
<code class="lineno">2</code>     <code class="nx">name</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code>
<code class="lineno">3</code>     <code class="nx">completed</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno">4</code>   <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">task</code><code class="p">){</code>
</pre></div>

</div>

<p>Again, it’s important to check for errors and propagate them with Express.js <code>next()</code> function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="lineno">2</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">task</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Failed to save.'</code><code class="p">));</code>
</pre></div>

</div>

<p>The logging is optional; however, it’s useful for learning and debugging:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Added %s with id=%s'</code><code class="p">,</code> <code class="nx">task</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code> <code class="nx">task</code><code class="p">.</code><code class="nx">_id</code><code class="p">);</code>
</pre></div>

</div>

<p>Lastly, we redirect back to the Todo List page when the saving operation is finished successfully:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/tasks'</code><code class="p">);</code>
<code class="lineno">2</code>   <code class="p">})</code>
<code class="lineno">3</code> <code class="p">};</code>
</pre></div>

</div>

<p>This method marks all incomplete tasks as complete:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">markAllCompleted</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</div>

<p>Because we had to re-use POST route and since it’s a good illustration of flow control, we check for the <code>all_done</code> parameter to decide if this request comes from the <em>all done</em> button or the <em>add</em> button:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">all_done</code>
<code class="lineno">2</code>     <code class="o">||</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">all_done</code> <code class="o">!==</code> <code class="s1">'true'</code><code class="p">)</code>
<code class="lineno">3</code>     <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
</pre></div>

</div>

<p>If the execution come this far, we perform db query with <code>multi: true</code>:
<code>javascript
  req.db.tasks.update({
    completed: false
  }, {$set: {
    completed: true
  }}, {multi: true}, function(error, count){
</code></p>

<p>Significant error handling, logging and redirection back to Todo List page:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="lineno">2</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Marked %s task(s) completed.'</code><code class="p">,</code> <code class="nx">count</code><code class="p">);</code>
<code class="lineno">3</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/tasks'</code><code class="p">);</code>
<code class="lineno">4</code>   <code class="p">})</code>
<code class="lineno">5</code> <code class="p">};</code>
</pre></div>

</div>

<p>The Completed route is akin to Todo List except for the completed flag value (true in this case):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">completed</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno"> 3</code>     <code class="nx">completed</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 4</code>   <code class="p">}).</code><code class="nx">toArray</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 5</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'tasks_completed'</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 6</code>       <code class="nx">title</code><code class="o">:</code> <code class="s1">'Completed'</code><code class="p">,</code>
<code class="lineno"> 7</code>       <code class="nx">tasks</code><code class="o">:</code> <code class="nx">tasks</code> <code class="o">||</code> <code class="p">[]</code>
<code class="lineno"> 8</code>     <code class="p">});</code>
<code class="lineno"> 9</code>   <code class="p">});</code>
<code class="lineno">10</code> <code class="p">};</code>
</pre></div>

</div>

<p>This is the route that takes care of marking a single task as done. We use <code>updateById</code> but the same thing can be accomplished with a plain <code>update</code> method from Mongoskin/MongoDB API. The trick with <code>completed: req.body.completed === 'true</code> is needed because the incoming value is a string and not a boolean.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">markCompleted</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">completed</code><code class="p">)</code>
<code class="lineno">3</code>     <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Param is missing'</code><code class="p">));</code>
<code class="lineno">4</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">updateById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">task</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">5</code>     <code class="nx">$set</code><code class="o">:</code> <code class="p">{</code><code class="nx">completed</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">completed</code> <code class="o">===</code> <code class="s1">'true'</code><code class="p">}},</code>
<code class="lineno">6</code>     <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">count</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</div>

<p>Once more, we perform error and results check (<code>update()</code> and <code>updateById()</code> don’t return object, but the count of affected documents instead):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="lineno"> 2</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">count</code> <code class="o">!==</code><code class="mi">1</code><code class="p">)</code>
<code class="lineno"> 3</code>         <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Something went wrong.'</code><code class="p">));</code>
<code class="lineno"> 4</code>       <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Marked task %s with id=%s completed.'</code><code class="p">,</code>
<code class="lineno"> 5</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">task</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code>
<code class="lineno"> 6</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">task</code><code class="p">.</code><code class="nx">_id</code><code class="p">);</code>
<code class="lineno"> 7</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/tasks'</code><code class="p">);</code>
<code class="lineno"> 8</code>     <code class="p">}</code>
<code class="lineno"> 9</code>   <code class="p">)</code>
<code class="lineno">10</code> <code class="p">}</code>
</pre></div>

</div>

<p>Delete is the single route called by an AJAX request. However, there’s nothing special about its implementation. The only difference is that we don’t redirect, but send status 200 back.</p>

<p>Just for your information, the <code>remove()</code> method can be used instead of <code>removeById()</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">del</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">removeById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">task</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">count</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="lineno"> 4</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">count</code> <code class="o">!==</code><code class="mi">1</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Something went wrong.'</code><code class="p">));</code>
<code class="lineno"> 5</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Deleted task %s with id=%s completed.'</code><code class="p">,</code>
<code class="lineno"> 6</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">task</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code>
<code class="lineno"> 7</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">task</code><code class="p">.</code><code class="nx">_id</code><code class="p">);</code>
<code class="lineno"> 8</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 9</code>   <code class="p">});</code>
<code class="lineno">10</code> <code class="p">}</code>
</pre></div>

</div>

<p>For your convenience, here’s the full content of the <code>todo-express/routes/tasks.js</code> file:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="cm">/*</code>
<code class="lineno"> 2</code> <code class="cm"> * GET users listing.</code>
<code class="lineno"> 3</code> <code class="cm"> */</code>
<code class="lineno"> 4</code>
<code class="lineno"> 5</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">list</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">){</code>
<code class="lineno"> 6</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">completed</code><code class="o">:</code> <code class="kc">false</code><code class="p">}).</code><code class="nx">toArray</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">){</code>
<code class="lineno"> 7</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="lineno"> 8</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'tasks'</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 9</code>       <code class="nx">title</code><code class="o">:</code> <code class="s1">'Todo List'</code><code class="p">,</code>
<code class="lineno">10</code>       <code class="nx">tasks</code><code class="o">:</code> <code class="nx">tasks</code> <code class="o">||</code> <code class="p">[]</code>
<code class="lineno">11</code>     <code class="p">});</code>
<code class="lineno">12</code>   <code class="p">});</code>
<code class="lineno">13</code> <code class="p">};</code>
<code class="lineno">14</code>
<code class="lineno">15</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">add</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">){</code>
<code class="lineno">16</code>   <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code> <code class="o">||</code> <code class="o">!</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">name</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'No data provided.'</code><code class="p">));</code>
<code class="lineno">17</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">save</code><code class="p">({</code>
<code class="lineno">18</code>     <code class="nx">name</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code>
<code class="lineno">19</code>     <code class="nx">completed</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno">20</code>   <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">task</code><code class="p">){</code>
<code class="lineno">21</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="lineno">22</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">task</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Failed to save.'</code><code class="p">));</code>
<code class="lineno">23</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Added %s with id=%s'</code><code class="p">,</code> <code class="nx">task</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code> <code class="nx">task</code><code class="p">.</code><code class="nx">_id</code><code class="p">);</code>
<code class="lineno">24</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/tasks'</code><code class="p">);</code>
<code class="lineno">25</code>   <code class="p">})</code>
<code class="lineno">26</code> <code class="p">};</code>
<code class="lineno">27</code>
<code class="lineno">28</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">markAllCompleted</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">29</code>   <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">all_done</code> <code class="o">||</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">all_done</code> <code class="o">!==</code> <code class="s1">'true'</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno">30</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">update</code><code class="p">({</code>
<code class="lineno">31</code>     <code class="nx">completed</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno">32</code>   <code class="p">},</code> <code class="p">{</code><code class="nx">$set</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">33</code>     <code class="nx">completed</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">34</code>   <code class="p">}},</code> <code class="p">{</code><code class="nx">multi</code><code class="o">:</code> <code class="kc">true</code><code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">count</code><code class="p">){</code>
<code class="lineno">35</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="lineno">36</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Marked %s task(s) completed.'</code><code class="p">,</code> <code class="nx">count</code><code class="p">);</code>
<code class="lineno">37</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/tasks'</code><code class="p">);</code>
<code class="lineno">38</code>   <code class="p">})</code>
<code class="lineno">39</code> <code class="p">};</code>
<code class="lineno">40</code>
<code class="lineno">41</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">completed</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">42</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">completed</code><code class="o">:</code> <code class="kc">true</code><code class="p">}).</code><code class="nx">toArray</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">tasks</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">43</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'tasks_completed'</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">44</code>       <code class="nx">title</code><code class="o">:</code> <code class="s1">'Completed'</code><code class="p">,</code>
<code class="lineno">45</code>       <code class="nx">tasks</code><code class="o">:</code> <code class="nx">tasks</code> <code class="o">||</code> <code class="p">[]</code>
<code class="lineno">46</code>     <code class="p">});</code>
<code class="lineno">47</code>   <code class="p">});</code>
<code class="lineno">48</code> <code class="p">};</code>
<code class="lineno">49</code>
<code class="lineno">50</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">markCompleted</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">51</code>   <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">completed</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Param is missing'</code><code class="p">));</code>
<code class="lineno">52</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">updateById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">task</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="p">{</code><code class="nx">$set</code><code class="o">:</code> <code class="p">{</code><code class="nx">completed</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">completed</code> <code class="o">===\</code>
<code class="lineno">53</code>  <code class="s1">'true'</code><code class="p">}},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">count</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">54</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="lineno">55</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">count</code> <code class="o">!==</code><code class="mi">1</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Something went wrong.'</code><code class="p">));</code>
<code class="lineno">56</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Marked task %s with id=%s completed.'</code><code class="p">,</code> <code class="nx">req</code><code class="p">.</code><code class="nx">task</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code> <code class="nx">req</code><code class="p">.</code><code class="nx">task</code><code class="p">.</code><code class="o">\</code>
<code class="lineno">57</code> <code class="nx">_id</code><code class="p">);</code>
<code class="lineno">58</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/tasks'</code><code class="p">);</code>
<code class="lineno">59</code>   <code class="p">})</code>
<code class="lineno">60</code> <code class="p">};</code>
<code class="lineno">61</code>
<code class="lineno">62</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">del</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">63</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">tasks</code><code class="p">.</code><code class="nx">removeById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">task</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">count</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">64</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="lineno">65</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">count</code> <code class="o">!==</code><code class="mi">1</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Something went wrong.'</code><code class="p">));</code>
<code class="lineno">66</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Deleted task %s with id=%s completed.'</code><code class="p">,</code> <code class="nx">req</code><code class="p">.</code><code class="nx">task</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code> <code class="nx">req</code><code class="p">.</code><code class="nx">task</code><code class="o">\</code>
<code class="lineno">67</code> <code class="p">.</code><code class="nx">_id</code><code class="p">);</code>
<code class="lineno">68</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">200</code><code class="p">);</code>
<code class="lineno">69</code>   <code class="p">});</code>
<code class="lineno">70</code> <code class="p">};</code>
</pre></div>

</div>

<h3 id="leanpub-auto-jades">
<span class="section-number">2.6 </span>Jades</h3>

<p>In the Todo app, we use four templates:</p>

<ul>
<li>
<code>layout.jade</code>: the skeleton of HTML pages that is used on all pages</li>
  <li>
<code>index.jade</code>: home page</li>
  <li>
<code>tasks.jade</code>: Todo List page</li>
  <li>
<code>tasks_completed.jade</code>: Completed page</li>
</ul>
<p>Let’s go through each file starting with <code>layout.jade</code>. It starts with doctype, html and head types:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> doctype 5
<code class="lineno">2</code> html
<code class="lineno">3</code>   head
</pre></div>

</div>

<p>We should have <code>appname</code> variable set:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>     title= title + ' | ' + appname
</pre></div>

</div>

<p>Next we include <code>*.css</code> files but underneath, Express.js will serve its contents from LESS files:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>     link(rel="stylesheet", href="/stylesheets/style.css")
<code class="lineno">2</code>     link(rel="stylesheet", href="/bootstrap/bootstrap.css")
<code class="lineno">3</code>     link(rel="stylesheet", href="/stylesheets/main.css")
</pre></div>

</div>

<p>The body with Twitter Bootstrap structure consist of <code>.container</code> and <code>.navbar</code>. To read more about those and other classes, go to <a href="http://getbootstrap.com/css/">getbootstrap.com/css/</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code>   body
<code class="lineno"> 2</code>     .container
<code class="lineno"> 3</code>       .navbar.navbar-default
<code class="lineno"> 4</code>         .container
<code class="lineno"> 5</code>           .navbar-header
<code class="lineno"> 6</code>             a.navbar-brand(href='/')= appname
<code class="lineno"> 7</code>       .alert.alert-dismissable
<code class="lineno"> 8</code>       h1= title
<code class="lineno"> 9</code>       p Welcome to Express.js Todo app by<code class="ni">&amp;nbsp;</code>
<code class="lineno">10</code>         a(href='http://twitter.com/azat_co') @azat_co
<code class="lineno">11</code>         |. Please enjoy.
</pre></div>

</div>

<p>This is the place where other jades (like <code>tasks.jade</code>) will be imported:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>       block content
</pre></div>

</div>

<p>The last lines include front-end JavaScript files:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   script(src='/javascripts/jquery.js', type="text/javascript")
<code class="lineno">2</code>   script(src='/javascripts/main.js', type="text/javascript")
</pre></div>

</div>

<p>The full <code>layout.jade</code> file:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">doctype</code> 5
<code class="lineno"> 2</code> <code class="nt">html</code>
<code class="lineno"> 3</code>   <code class="nt">head</code>
<code class="lineno"> 4</code>     <code class="nt">title</code><code class="p">=</code> <code class="n">title</code> <code class="o">+</code> <code class="err">'</code> <code class="o">|</code> <code class="err">'</code> <code class="o">+</code> <code class="n">appname</code>
<code class="lineno"> 5</code>     <code class="nt">link</code>(<code class="na">rel=</code><code class="s">"stylesheet"</code><code class="err">,</code> <code class="na">href=</code><code class="s">"/stylesheets/style.css"</code>)
<code class="lineno"> 6</code>     <code class="nt">link</code>(<code class="na">rel=</code><code class="s">"stylesheet"</code><code class="err">,</code> <code class="na">href=</code><code class="s">"/bootstrap/bootstrap.css"</code>)
<code class="lineno"> 7</code>     <code class="nt">link</code>(<code class="na">rel=</code><code class="s">"stylesheet"</code><code class="err">,</code> <code class="na">href=</code><code class="s">"/stylesheets/main.css"</code>)
<code class="lineno"> 8</code>
<code class="lineno"> 9</code>   <code class="nt">body</code>
<code class="lineno">10</code>     <code class="nc">.container</code>
<code class="lineno">11</code>       <code class="nc">.navbar.navbar-default</code>
<code class="lineno">12</code>         <code class="nc">.container</code>
<code class="lineno">13</code>           <code class="nc">.navbar-header</code>
<code class="lineno">14</code>             <code class="nt">a</code><code class="nc">.navbar-brand</code>(<code class="na">href=</code><code class="s">'/'</code>)<code class="p">=</code> <code class="n">appname</code>
<code class="lineno">15</code>       <code class="nc">.alert.alert-dismissable</code>
<code class="lineno">16</code>       <code class="nt">h1</code><code class="p">=</code> <code class="n">title</code>
<code class="lineno">17</code>       <code class="nt">p</code> Welcome to Express.js Todo app by&amp;nbsp;
<code class="lineno">18</code>         <code class="nt">a</code>(<code class="na">href=</code><code class="s">'http://twitter.com/azat_co'</code>) @azat_co
<code class="lineno">19</code>         |. Please enjoy.
<code class="lineno">20</code>       <code class="nt">block</code> content
<code class="lineno">21</code>   <code class="nt">script</code>(<code class="na">src=</code><code class="s">'/javascripts/jquery.js'</code><code class="err">,</code> <code class="na">type=</code><code class="s">"text/javascript"</code>)
<code class="lineno">22</code>   <code class="nt">script</code>(<code class="na">src=</code><code class="s">'/javascripts/main.js'</code><code class="err">,</code> <code class="na">type=</code><code class="s">"text/javascript"</code>)
</pre></div>

</div>

<p>The <code>index.jade</code> file is our home page and it’s quite vanilla. The most interesting thing it had is the <code>nav-pills</code> menu:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">extends</code> layout
<code class="lineno"> 2</code>
<code class="lineno"> 3</code> <code class="nt">block</code> content
<code class="lineno"> 4</code>   <code class="nc">.menu</code>
<code class="lineno"> 5</code>     <code class="nt">h2</code> Menu
<code class="lineno"> 6</code>     <code class="nt">ul</code><code class="nc">.nav.nav-pills</code>
<code class="lineno"> 7</code>       <code class="nt">li</code><code class="nc">.active</code>
<code class="lineno"> 8</code>         <code class="nt">a</code>(<code class="na">href=</code><code class="s">"/tasks"</code>) Home
<code class="lineno"> 9</code>       <code class="nt">li</code>
<code class="lineno">10</code>         <code class="nt">a</code>(<code class="na">href=</code><code class="s">"/tasks"</code>) Todo List
<code class="lineno">11</code>       <code class="nt">li</code>
<code class="lineno">12</code>         <code class="nt">a</code>(<code class="na">href=</code><code class="s">"/tasks"</code>) Completed
<code class="lineno">13</code>   <code class="nc">.home</code>
<code class="lineno">14</code>     <code class="nt">p</code> This is an example of classical (no front-end JavaScript frameworks) web ap\
<code class="lineno">15</code> <code class="nt">plication</code> built with Express.js 3.3.5 for
<code class="lineno">16</code>       <code class="nt">a</code>(<code class="na">href=</code><code class="s">"http://expressjsguide.com"</code>) Express.js Guide
<code class="lineno">17</code>       |.
<code class="lineno">18</code>     <code class="nt">p</code> The full source code is available at
<code class="lineno">19</code>       <code class="nt">a</code>(<code class="na">href=</code><code class="s">'http://github.com/azat-co/todo-express'</code>) github.com/azat-co/todo-ex\
<code class="lineno">20</code> <code class="nt">press</code>
<code class="lineno">21</code>       |.
</pre></div>

</div>

<p>The <code>tasks.jade</code> uses <code>extends layout</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> extends layout
<code class="lineno">2</code>
<code class="lineno">3</code> block content
</pre></div>

</div>

<p>Then goes our main page specific content:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code>   .menu
<code class="lineno"> 2</code>     h2 Menu
<code class="lineno"> 3</code>     ul.nav.nav-pills
<code class="lineno"> 4</code>       li
<code class="lineno"> 5</code>         a(href='/') Home
<code class="lineno"> 6</code>       li.active
<code class="lineno"> 7</code>         a(href='/tasks') Todo List
<code class="lineno"> 8</code>       li
<code class="lineno"> 9</code>         a(href="/tasks/completed") Completed
<code class="lineno">10</code>   h1= title
</pre></div>

</div>

<p>The <code>div</code> with list class will hold the Todo List:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   .list
<code class="lineno">2</code>     .item.add-task
</pre></div>

</div>

<p>The form to mark all items as done has CSRF token in a hidden field and uses POST method pointed to <code>/tasks</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>       div.action
<code class="lineno">2</code>         form(action='/tasks', method='post')
<code class="lineno">3</code>           input(type='hidden', value='true', name='all_done')
<code class="lineno">4</code>           input(type='hidden', value=locals._csrf, name='_csrf')
<code class="lineno">5</code>           input(type='submit', class='btn btn-success btn-xs', value='all done')
</pre></div>

</div>

<p>Similar CSRF enabled form is for new task creation:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>       form(action="/tasks", method='post')
<code class="lineno">2</code>         input(type='hidden', value=locals._csrf, name='_csrf')
<code class="lineno">3</code>         div.name
<code class="lineno">4</code>           input(type="text", name="name", placeholder='Add a new task')
<code class="lineno">5</code>         div.delete
<code class="lineno">6</code>           input.btn.btn-primary.btn-sm(type="submit", value='add')
</pre></div>

</div>

<p>When we start the app for the first time (or clean the database), there are no tasks:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>     if (tasks.length === 0)
<code class="lineno">2</code>       | No tasks.
</pre></div>

</div>

<p>Jade supports iterations with <code>each</code> command:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>     each task, index in tasks
<code class="lineno">2</code>       .item
<code class="lineno">3</code>         div.action
</pre></div>

</div>

<p>This form submits data to individual task route:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>           form(action='/tasks/#{task._id}', method='post')
<code class="lineno">2</code>             input(type='hidden', value=task._id.toString(), name='id')
<code class="lineno">3</code>             input(type='hidden', value='true', name='completed')
<code class="lineno">4</code>             input(type='hidden', value=locals._csrf, name='_csrf')
<code class="lineno">5</code>             input(type='submit', class='btn btn-success btn-xs task-done', value=\
<code class="lineno">6</code> 'done')
</pre></div>

</div>

<p>The <code>index</code> variable is used to display order in the list of tasks:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>         div.num
<code class="lineno">2</code>           span=index+1
<code class="lineno">3</code>             |.<code class="ni">&amp;nbsp;</code>
<code class="lineno">4</code>         div.name
<code class="lineno">5</code>           span.name=task.name
<code class="lineno">6</code>           //- no support for DELETE method in forms
<code class="lineno">7</code>           //- http://amundsen.com/examples/put-delete-forms/
<code class="lineno">8</code>           //- so do XHR request instead from public/javascripts/main.js
</pre></div>

</div>

<p>The delete button doesn’t have anything fancy attached to it, because events are attached to these buttons from <code>main.js</code> front-end JavaScript file:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>         div.delete
<code class="lineno">2</code>           a(class='btn btn-danger btn-xs task-delete', data-task-id=task._id.toSt\
<code class="lineno">3</code> ring(), data-csrf=locals._csrf) delete
</pre></div>

</div>

<p>The full source code of <code>tasks.jade</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">extends</code> layout
<code class="lineno"> 2</code>
<code class="lineno"> 3</code> <code class="nt">block</code> content
<code class="lineno"> 4</code>
<code class="lineno"> 5</code>   <code class="nc">.menu</code>
<code class="lineno"> 6</code>     <code class="nt">h2</code> Menu
<code class="lineno"> 7</code>     <code class="nt">ul</code><code class="nc">.nav.nav-pills</code>
<code class="lineno"> 8</code>       <code class="nt">li</code>
<code class="lineno"> 9</code>         <code class="nt">a</code>(<code class="na">href=</code><code class="s">'/'</code>) Home
<code class="lineno">10</code>       <code class="nt">li</code><code class="nc">.active</code>
<code class="lineno">11</code>         <code class="nt">a</code>(<code class="na">href=</code><code class="s">'/tasks'</code>) Todo List
<code class="lineno">12</code>       <code class="nt">li</code>
<code class="lineno">13</code>         <code class="nt">a</code>(<code class="na">href=</code><code class="s">"/tasks/completed"</code>) Completed
<code class="lineno">14</code>   <code class="nt">h1</code><code class="p">=</code> <code class="n">title</code>
<code class="lineno">15</code>
<code class="lineno">16</code>   <code class="nc">.list</code>
<code class="lineno">17</code>     <code class="nc">.item.add-task</code>
<code class="lineno">18</code>       <code class="nt">div</code><code class="nc">.action</code>
<code class="lineno">19</code>         <code class="nt">form</code>(<code class="na">action=</code><code class="s">'/tasks'</code><code class="err">,</code> <code class="na">method=</code><code class="s">'post'</code>)
<code class="lineno">20</code>           <code class="nt">input</code>(<code class="na">type=</code><code class="s">'hidden'</code><code class="err">,</code> <code class="na">value=</code><code class="s">'true'</code><code class="err">,</code> <code class="na">name=</code><code class="s">'all_done'</code>)
<code class="lineno">21</code>           <code class="nt">input</code>(<code class="na">type=</code><code class="s">'hidden'</code><code class="err">,</code> <code class="na">value=</code><code class="nv">locals</code><code class="err">.</code><code class="na">_csrf</code><code class="err">,</code> <code class="na">name=</code><code class="s">'_csrf'</code>)
<code class="lineno">22</code>           <code class="nt">input</code>(<code class="na">type=</code><code class="s">'submit'</code><code class="err">,</code> <code class="na">class=</code><code class="s">'btn btn-success btn-xs'</code><code class="err">,</code> <code class="na">value=</code><code class="s">'all done'</code>)
<code class="lineno">23</code>       <code class="nt">form</code>(<code class="na">action=</code><code class="s">"/tasks"</code><code class="err">,</code> <code class="na">method=</code><code class="s">'post'</code>)
<code class="lineno">24</code>         <code class="nt">input</code>(<code class="na">type=</code><code class="s">'hidden'</code><code class="err">,</code> <code class="na">value=</code><code class="nv">locals</code><code class="err">.</code><code class="na">_csrf</code><code class="err">,</code> <code class="na">name=</code><code class="s">'_csrf'</code>)
<code class="lineno">25</code>         <code class="nt">div</code><code class="nc">.name</code>
<code class="lineno">26</code>           <code class="nt">input</code>(<code class="na">type=</code><code class="s">"text"</code><code class="err">,</code> <code class="na">name=</code><code class="s">"name"</code><code class="err">,</code> <code class="na">placeholder=</code><code class="s">'Add a new task'</code>)
<code class="lineno">27</code>         <code class="nt">div</code><code class="nc">.delete</code>
<code class="lineno">28</code>           <code class="nt">input</code><code class="nc">.btn.btn-primary.btn-sm</code>(<code class="na">type=</code><code class="s">"submit"</code><code class="err">,</code> <code class="na">value=</code><code class="s">'add'</code>)
<code class="lineno">29</code>     <code class="nt">if</code> (tasks.length === 0)
<code class="lineno">30</code>       | No tasks.
<code class="lineno">31</code>     <code class="nt">each</code> task, index in tasks
<code class="lineno">32</code>       <code class="nc">.item</code>
<code class="lineno">33</code>         <code class="nt">div</code><code class="nc">.action</code>
<code class="lineno">34</code>           <code class="nt">form</code>(<code class="na">action=</code><code class="s">'/tasks/#{task._id}'</code><code class="err">,</code> <code class="na">method=</code><code class="s">'post'</code>)
<code class="lineno">35</code>             <code class="nt">input</code>(<code class="na">type=</code><code class="s">'hidden'</code><code class="err">,</code> <code class="na">value=</code><code class="nv">task</code><code class="err">.</code><code class="na">_id</code><code class="err">.</code><code class="na">toString</code><code class="err">(</code>), name='id')
<code class="lineno">36</code>             <code class="nt">input</code>(<code class="na">type=</code><code class="s">'hidden'</code><code class="err">,</code> <code class="na">value=</code><code class="s">'true'</code><code class="err">,</code> <code class="na">name=</code><code class="s">'completed'</code>)
<code class="lineno">37</code>             <code class="nt">input</code>(<code class="na">type=</code><code class="s">'hidden'</code><code class="err">,</code> <code class="na">value=</code><code class="nv">locals</code><code class="err">.</code><code class="na">_csrf</code><code class="err">,</code> <code class="na">name=</code><code class="s">'_csrf'</code>)
<code class="lineno">38</code>             <code class="nt">input</code>(<code class="na">type=</code><code class="s">'submit'</code><code class="err">,</code> <code class="na">class=</code><code class="s">'btn btn-success btn-xs task-done'</code><code class="err">,</code> <code class="na">value=</code><code class="err">\</code>
<code class="lineno">39</code> <code class="err">'</code><code class="nt">done</code>')
<code class="lineno">40</code>         <code class="nt">div</code><code class="nc">.num</code>
<code class="lineno">41</code>           <code class="nt">span</code><code class="p">=</code><code class="n">index</code><code class="o">+</code><code class="mi">1</code>
<code class="lineno">42</code>             |.&amp;nbsp;
<code class="lineno">43</code>         <code class="nt">div</code><code class="nc">.name</code>
<code class="lineno">44</code>           <code class="nt">span</code><code class="nc">.name</code><code class="p">=</code><code class="n">task</code><code class="o">.</code><code class="n">name</code>
<code class="lineno">45</code>           <code class="c">//- no support for DELETE method in forms</code>
<code class="lineno">46</code>           <code class="c">//- http://amundsen.com/examples/put-delete-forms/</code>
<code class="lineno">47</code>           <code class="c">//- so do XHR request instead from public/javascripts/main.js</code>
<code class="lineno">48</code>         <code class="nt">div</code><code class="nc">.delete</code>
<code class="lineno">49</code>           <code class="nt">a</code>(<code class="na">class=</code><code class="s">'btn btn-danger btn-xs task-delete'</code><code class="err">,</code> <code class="na">data-task-id=</code><code class="nv">task</code><code class="err">.</code><code class="na">_id</code><code class="err">.</code><code class="na">toSt</code><code class="err">\</code>
<code class="lineno">50</code> <code class="na">ring</code><code class="err">(</code>), data-csrf=locals._csrf) delete
</pre></div>

</div>

<p>Last but not least, comes <code>tasks_completed.jade</code> which is just a striped down version of <code>tasks.jade</code> file:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">extends</code> layout
<code class="lineno"> 2</code>
<code class="lineno"> 3</code> <code class="nt">block</code> content
<code class="lineno"> 4</code>
<code class="lineno"> 5</code>   <code class="nc">.menu</code>
<code class="lineno"> 6</code>     <code class="nt">h2</code> Menu
<code class="lineno"> 7</code>     <code class="nt">ul</code><code class="nc">.nav.nav-pills</code>
<code class="lineno"> 8</code>       <code class="nt">li</code>
<code class="lineno"> 9</code>         <code class="nt">a</code>(<code class="na">href=</code><code class="s">'/'</code>) Home
<code class="lineno">10</code>       <code class="nt">li</code>
<code class="lineno">11</code>         <code class="nt">a</code>(<code class="na">href=</code><code class="s">'/tasks'</code>) Todo List
<code class="lineno">12</code>       <code class="nt">li</code><code class="nc">.active</code>
<code class="lineno">13</code>         <code class="nt">a</code>(<code class="na">href=</code><code class="s">"/tasks/completed"</code>) Completed
<code class="lineno">14</code>
<code class="lineno">15</code>   <code class="nt">h1</code><code class="p">=</code> <code class="n">title</code>
<code class="lineno">16</code>
<code class="lineno">17</code>   <code class="nc">.list</code>
<code class="lineno">18</code>     <code class="nt">if</code> (tasks.length === 0)
<code class="lineno">19</code>       | No tasks.
<code class="lineno">20</code>     <code class="nt">each</code> task, index in tasks
<code class="lineno">21</code>       <code class="nc">.item</code>
<code class="lineno">22</code>         <code class="nt">div</code><code class="nc">.num</code>
<code class="lineno">23</code>           <code class="nt">span</code><code class="p">=</code><code class="n">index</code><code class="o">+</code><code class="mi">1</code>
<code class="lineno">24</code>             |.&amp;nbsp;
<code class="lineno">25</code>         <code class="nt">div</code><code class="nc">.name.completed-task</code>
<code class="lineno">26</code>           <code class="nt">span</code><code class="nc">.name</code><code class="p">=</code><code class="n">task</code><code class="o">.</code><code class="n">name</code>
</pre></div>

</div>

<h3 id="leanpub-auto-less">
<span class="section-number">2.7 </span>LESS</h3>

<p>As we’ve mentioned before, after applying proper middleware in <code>app.js</code> files, we can put <code>*.less</code> files anywhere under <code>public</code> folder. Express.js works by accepting request for some <code>.css</code> file and tries to match corresponding file by name. Therefore, we include <code>*.css</code> files in our jades.</p>

<p>Here is the content of the <code>todo-express/public/stylesheets/main.less</code> file:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="o">*</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="n">font</code><code class="o">-</code><code class="n">size</code><code class="o">:</code><code class="mi">20</code><code class="n">px</code><code class="p">;</code>
<code class="lineno"> 3</code> <code class="p">}</code>
<code class="lineno"> 4</code> <code class="p">.</code><code class="n">btn</code> <code class="p">{</code>
<code class="lineno"> 5</code>   <code class="c1">// margin-left: 20px;</code>
<code class="lineno"> 6</code>   <code class="c1">// margin-right: 20px;</code>
<code class="lineno"> 7</code> <code class="p">}</code>
<code class="lineno"> 8</code> <code class="p">.</code><code class="n">num</code> <code class="p">{</code>
<code class="lineno"> 9</code>   <code class="c1">// margin-right: 3px;</code>
<code class="lineno">10</code> <code class="p">}</code>
<code class="lineno">11</code> <code class="p">.</code><code class="n">item</code> <code class="p">{</code>
<code class="lineno">12</code>   <code class="nl">height:</code> <code class="mi">44</code><code class="n">px</code><code class="p">;</code>
<code class="lineno">13</code>   <code class="nl">width:</code> <code class="mi">100</code><code class="o">%</code><code class="p">;</code>
<code class="lineno">14</code>   <code class="nl">clear:</code> <code class="n">both</code><code class="p">;</code>
<code class="lineno">15</code>   <code class="p">.</code><code class="n">name</code> <code class="p">{</code>
<code class="lineno">16</code>     <code class="nl">width:</code> <code class="mi">300</code><code class="n">px</code><code class="p">;</code>
<code class="lineno">17</code>   <code class="p">}</code>
<code class="lineno">18</code>   <code class="p">.</code><code class="n">action</code> <code class="p">{</code>
<code class="lineno">19</code>     <code class="nl">width:</code> <code class="mi">100</code><code class="n">px</code><code class="p">;</code>
<code class="lineno">20</code>   <code class="p">}</code>
<code class="lineno">21</code>   <code class="p">.</code><code class="n">delete</code> <code class="p">{</code>
<code class="lineno">22</code>     <code class="nl">width:</code> <code class="mi">100</code><code class="n">px</code>
<code class="lineno">23</code>   <code class="p">}</code>
<code class="lineno">24</code>   <code class="n">div</code> <code class="p">{</code>
<code class="lineno">25</code>     <code class="nl">float:</code><code class="n">left</code><code class="p">;</code>
<code class="lineno">26</code>   <code class="p">}</code>
<code class="lineno">27</code> <code class="p">}</code>
<code class="lineno">28</code> <code class="p">.</code><code class="n">home</code> <code class="p">{</code>
<code class="lineno">29</code>   <code class="n">margin</code><code class="o">-</code><code class="n">top</code><code class="o">:</code> <code class="mi">40</code><code class="n">px</code><code class="p">;</code>
<code class="lineno">30</code> <code class="p">}</code>
<code class="lineno">31</code> <code class="p">.</code><code class="n">name</code><code class="p">.</code><code class="n">completed</code><code class="o">-</code><code class="n">task</code> <code class="p">{</code>
<code class="lineno">32</code>   <code class="n">text</code><code class="o">-</code><code class="n">decoration</code><code class="o">:</code> <code class="n">line</code><code class="o">-</code><code class="n">through</code><code class="p">;</code>
<code class="lineno">33</code> <code class="p">}</code>
</pre></div>

</div>

<h3 id="leanpub-auto-conclusion-1">
<span class="section-number">2.8 </span>Conclusion</h3>

<p>The Todo app is considered classical because it doesn’t rely on any front-end framework. This was done intentionally to show how easy it is to use Express.js for such tasks. In modern day development, people often leverage some sort of REST API server architecture with front-end client built with Backbone.js, Angular, Ember or <a href="http://todomvc.com">something else</a>. Next examples dive into details about how to write such servers.</p>

<h2 id="leanpub-auto-rest-api">
<span class="section-number">3 </span>REST API</h2>

<div class="aside sidebarish">
  <h3 id="leanpub-auto-summary-4">Summary</h3>

  <p>In this tutorial in addition to Express.js, we’ll use MongoDB via Mongoskin. We’ll also use Mocha and Superagent to write functional tests.</p>

</div>

<p>This tutorial will walk you through writing test using the <a href="http://visionmedia.github.io/mocha/">Mocha</a> and <a href="http://visionmedia.github.io/superagent/">Super Agent</a> libraries and then use them in a test-driven development manner to build a <a href="http://nodejs.org">Node.js</a> free JSON REST API server utilizing <a href="http://expressjs.com/">Express.js</a> framework and <a href="https://github.com/kissjs/node-mongoskin">Mongoskin</a> library for <a href="http://www.mongodb.org/">MongoDB</a>.</p>

<table class="exercise sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="https://leanpub.com/site_images/express/leanpub_exercise.png" alt="exercise">
</td>
    <td>
      <h3 id="leanpub-auto-example-2">Example</h3>

  <p>All the source code is in the <a href="https://github.com/azat-co/rest-api-express">github.com/azat-co/rest-api-express</a> for your convenience.</p>

    </td>
  </tr></tbody></table>
<p>In this REST API server, we’ll perform <strong>create, update, remove and delete</strong> (CRUD) operations and harness Express.js <a href="http://expressjs.com/api.html#middleware">middleware</a> concept with <code>app.param()</code> and <code>app.use()</code> methods.</p>

<h3 id="leanpub-auto-test-coverage">
<span class="section-number">3.1 </span>Test Coverage</h3>

<p>Before anything else, let’s write functional tests that make HTTP requests to our soon-to-be-created REST API server. If you know how to use <a href="http://visionmedia.github.io/mocha/">Mocha</a> or just want to jump straight to the Express.js app implementation, feel free to do so. You can use CURL terminal commands for testing too.</p>

<p>Assuming we already have Node.js, <a href="http://npmjs.org">NPM</a> and MongoDB installed, let’s create a <em>new</em> folder (or if you wrote the tests, use that folder):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> mkdir rest-api
<code class="lineno">2</code> <code class="nb">cd </code>rest-api
</pre></div>

</div>

<p>We’ll use <a href="http://visionmedia.github.io/mocha/">Mocha</a>, <a href="https://github.com/LearnBoost/expect.js/">Expect.js</a> and <a href="http://visionmedia.github.io/superagent/">Super Agent</a> libraries. To install them, run these commands from the project folder:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>npm install -g mocha
<code class="lineno">2</code> <code class="nv">$ </code>npm install expect.js
<code class="lineno">3</code> <code class="nv">$ </code>npm install superagent
</pre></div>

</div>

<table class="tip sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="https://leanpub.com/site_images/express/leanpub_tip.png" alt="tip">
</td>
    <td>
      <h3 id="leanpub-auto-tip">Tip</h3>

  <p>Installing Mocha locally will give us the ability to use different versions at the same time. To run tests, simply point to <code>./node_modules/mocha/bin/mocha</code>. A better alternative would be to use Makefile as outlined in the HackHall example.</p>

    </td>
  </tr></tbody></table>
<p>Now let’s create <strong>express.test.js</strong> file in the same folder which will have six suites:</p>

<ul>
<li>creating a new object</li>
  <li>retrieving an object by its ID</li>
  <li>retrieving the whole collection</li>
  <li>updating an object by its ID</li>
  <li>checking an updated object by its ID</li>
  <li>removing an object by its ID</li>
</ul>
<p>HTTP requests are just a breeze with Super Agent’s chained functions which we’ll put inside of each test suite.</p>

<p>Here is the full source code for the <strong>rest-api-express/express.test.js</strong> file:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">superagent</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'superagent'</code><code class="p">)</code>
<code class="lineno"> 2</code> <code class="kd">var</code> <code class="nx">expect</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'expect.js'</code><code class="p">)</code>
<code class="lineno"> 3</code>
<code class="lineno"> 4</code> <code class="nx">describe</code><code class="p">(</code><code class="s1">'express rest api server'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(){</code>
<code class="lineno"> 5</code>   <code class="kd">var</code> <code class="nx">id</code>
<code class="lineno"> 6</code>
<code class="lineno"> 7</code>   <code class="nx">it</code><code class="p">(</code><code class="s1">'post object'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno"> 8</code>     <code class="nx">superagent</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'http://localhost:3000/collections/test'</code><code class="p">)</code>
<code class="lineno"> 9</code>       <code class="p">.</code><code class="nx">send</code><code class="p">({</code> <code class="nx">name</code><code class="o">:</code> <code class="s1">'John'</code>
<code class="lineno">10</code>         <code class="p">,</code> <code class="nx">email</code><code class="o">:</code> <code class="s1">'john@rpjs.co'</code>
<code class="lineno">11</code>       <code class="p">})</code>
<code class="lineno">12</code>       <code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno">13</code>         <code class="c1">// console.log(res.body)</code>
<code class="lineno">14</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">e</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="kc">null</code><code class="p">)</code>
<code class="lineno">15</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">length</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="lineno">16</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">_id</code><code class="p">.</code><code class="nx">length</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="mi">24</code><code class="p">)</code>
<code class="lineno">17</code>         <code class="nx">id</code> <code class="o">=</code> <code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">_id</code>
<code class="lineno">18</code>         <code class="nx">done</code><code class="p">()</code>
<code class="lineno">19</code>       <code class="p">})</code>
<code class="lineno">20</code>   <code class="p">})</code>
<code class="lineno">21</code>
<code class="lineno">22</code>   <code class="nx">it</code><code class="p">(</code><code class="s1">'retrieves an object'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno">23</code>     <code class="nx">superagent</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'http://localhost:3000/collections/test/'</code><code class="o">+</code><code class="nx">id</code><code class="p">)</code>
<code class="lineno">24</code>       <code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
<code class="lineno">25</code>         <code class="c1">// console.log(res.body)</code>
<code class="lineno">26</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">e</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="kc">null</code><code class="p">)</code>
<code class="lineno">27</code>         <code class="nx">expect</code><code class="p">(</code><code class="k">typeof</code> <code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="s1">'object'</code><code class="p">)</code>
<code class="lineno">28</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code><code class="p">.</code><code class="nx">length</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="mi">24</code><code class="p">)</code>
<code class="lineno">29</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="nx">id</code><code class="p">)</code>
<code class="lineno">30</code>         <code class="nx">done</code><code class="p">()</code>
<code class="lineno">31</code>       <code class="p">})</code>
<code class="lineno">32</code>   <code class="p">})</code>
<code class="lineno">33</code>
<code class="lineno">34</code>   <code class="nx">it</code><code class="p">(</code><code class="s1">'retrieves a collection'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno">35</code>     <code class="nx">superagent</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'http://localhost:3000/collections/test'</code><code class="p">)</code>
<code class="lineno">36</code>       <code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
<code class="lineno">37</code>         <code class="c1">// console.log(res.body)</code>
<code class="lineno">38</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">e</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="kc">null</code><code class="p">)</code>
<code class="lineno">39</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">length</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">be</code><code class="p">.</code><code class="nx">above</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
<code class="lineno">40</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">item</code><code class="p">){</code><code class="k">return</code> <code class="nx">item</code><code class="p">.</code><code class="nx">_id</code><code class="p">})).</code><code class="nx">to</code><code class="p">.</code><code class="nx">contain</code><code class="p">(</code><code class="nx">id</code><code class="p">)</code>
<code class="lineno">41</code>         <code class="nx">done</code><code class="p">()</code>
<code class="lineno">42</code>       <code class="p">})</code>
<code class="lineno">43</code>   <code class="p">})</code>
<code class="lineno">44</code>
<code class="lineno">45</code>   <code class="nx">it</code><code class="p">(</code><code class="s1">'updates an object'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno">46</code>     <code class="nx">superagent</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="s1">'http://localhost:3000/collections/test/'</code><code class="o">+</code><code class="nx">id</code><code class="p">)</code>
<code class="lineno">47</code>       <code class="p">.</code><code class="nx">send</code><code class="p">({</code><code class="nx">name</code><code class="o">:</code> <code class="s1">'Peter'</code>
<code class="lineno">48</code>         <code class="p">,</code> <code class="nx">email</code><code class="o">:</code> <code class="s1">'peter@yahoo.com'</code><code class="p">})</code>
<code class="lineno">49</code>       <code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
<code class="lineno">50</code>         <code class="c1">// console.log(res.body)</code>
<code class="lineno">51</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">e</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="kc">null</code><code class="p">)</code>
<code class="lineno">52</code>         <code class="nx">expect</code><code class="p">(</code><code class="k">typeof</code> <code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="s1">'object'</code><code class="p">)</code>
<code class="lineno">53</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">msg</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="s1">'success'</code><code class="p">)</code>
<code class="lineno">54</code>         <code class="nx">done</code><code class="p">()</code>
<code class="lineno">55</code>       <code class="p">})</code>
<code class="lineno">56</code>   <code class="p">})</code>
<code class="lineno">57</code>
<code class="lineno">58</code>   <code class="nx">it</code><code class="p">(</code><code class="s1">'checks an updated object'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno">59</code>     <code class="nx">superagent</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'http://localhost:3000/collections/test/'</code><code class="o">+</code><code class="nx">id</code><code class="p">)</code>
<code class="lineno">60</code>       <code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
<code class="lineno">61</code>         <code class="c1">// console.log(res.body)</code>
<code class="lineno">62</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">e</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="kc">null</code><code class="p">)</code>
<code class="lineno">63</code>         <code class="nx">expect</code><code class="p">(</code><code class="k">typeof</code> <code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="s1">'object'</code><code class="p">)</code>
<code class="lineno">64</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code><code class="p">.</code><code class="nx">length</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="mi">24</code><code class="p">)</code>
<code class="lineno">65</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="nx">id</code><code class="p">)</code>
<code class="lineno">66</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">name</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="s1">'Peter'</code><code class="p">)</code>
<code class="lineno">67</code>         <code class="nx">done</code><code class="p">()</code>
<code class="lineno">68</code>       <code class="p">})</code>
<code class="lineno">69</code>   <code class="p">})</code>
<code class="lineno">70</code>   <code class="nx">it</code><code class="p">(</code><code class="s1">'removes an object'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno">71</code>     <code class="nx">superagent</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="s1">'http://localhost:3000/collections/test/'</code><code class="o">+</code><code class="nx">id</code><code class="p">)</code>
<code class="lineno">72</code>       <code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
<code class="lineno">73</code>         <code class="c1">// console.log(res.body)</code>
<code class="lineno">74</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">e</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="kc">null</code><code class="p">)</code>
<code class="lineno">75</code>         <code class="nx">expect</code><code class="p">(</code><code class="k">typeof</code> <code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="s1">'object'</code><code class="p">)</code>
<code class="lineno">76</code>         <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">msg</code><code class="p">).</code><code class="nx">to</code><code class="p">.</code><code class="nx">eql</code><code class="p">(</code><code class="s1">'success'</code><code class="p">)</code>
<code class="lineno">77</code>         <code class="nx">done</code><code class="p">()</code>
<code class="lineno">78</code>       <code class="p">})</code>
<code class="lineno">79</code>   <code class="p">})</code>
<code class="lineno">80</code> <code class="p">})</code>
</pre></div>

</div>

<p>To run the tests, we can use the <code>$ mocha express.test.js</code> command.</p>

<h3 id="leanpub-auto-dependencies-1">
<span class="section-number">3.2 </span>Dependencies</h3>

<p>In this tutorial, we’ll utilize <a href="https://github.com/kissjs/node-mongoskin">Mongoskin</a>, a MongoDB library which is a better alternative to the plain good old <a href="https://github.com/mongodb/node-mongodb-native">native MongoDB driver for Node.js</a>. In addition, Mongoskin is more light-weight than Mongoose and schema-less. For more insight, please check out <a href="https://github.com/kissjs/node-mongoskin#comparation">Mongoskin comparison blurb</a>.</p>

<p><a href="http://expressjs.com/">Express.js</a> is a wrapper for the core Node.js <a href="http://nodejs.org/api/http.html">HTTP module</a> objects. The Express.js framework is build on top of <a href="https://github.com/senchalabs/connect">Connect</a> middleware and provided tons of convenience. Some people compare the framework to Ruby’s Sinatra in terms of how it’s non-opinionated and configurable.</p>

<p>If you’ve create a <code>rest-api</code> folder in the previous section <em>Test Coverage</em>, simply run these commands to install modules for the application:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> npm install express
<code class="lineno">2</code> npm install mongoskin
</pre></div>

</div>

<h3 id="leanpub-auto-implementation">
<span class="section-number">3.3 </span>Implementation</h3>

<p>First things first, so let’s define our dependencies:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">)</code>
<code class="lineno">2</code>   <code class="p">,</code> <code class="nx">mongoskin</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongoskin'</code><code class="p">)</code>
</pre></div>

</div>

<p>After version 3.x, Express streamlines the instantiation of its app instance, in a way that this line will give us a server object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">()</code>
</pre></div>

</div>

<p>To extract params from the body of the requests, we’ll use <code>bodyParser()</code> middleware which looks more like a configuration statement:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">bodyParser</code><code class="p">())</code>
</pre></div>

</div>

<p>Middleware (in <a href="http://expressjs.com/api.html#app.use">this</a> and <a href="http://expressjs.com/api.html#middleware">other forms</a>) is a powerful and convenient pattern in Express.js and <a href="https://github.com/senchalabs/connect">Connect</a> to organize and re-use code.</p>

<p>As with the <code>bodyParser()</code> method that saves us from the hurdles of parsing a body object of HTTP request, Mongoskin makes it possible to connect to the MongoDB database in one effortless line of code:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">mongoskin</code><code class="p">.</code><code class="nx">db</code><code class="p">(</code><code class="s1">'localhost:27017/test'</code><code class="p">,</code> <code class="p">{</code><code class="nx">safe</code><code class="o">:</code><code class="kc">true</code><code class="p">});</code>
</pre></div>

</div>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="https://leanpub.com/site_images/express/leanpub_information.png" alt="information">
</td>
    <td>
      <h3 id="leanpub-auto-note-1">Note</h3>

  <p>If you wish to connect to a remote database, e.g., <a href="https://www.mongohq.com/home">MongoHQ</a> instance, substitute the string with your username, password, host and port values. Here is the format of the URI string: <code>mongodb://[username:password@] host1[:port1][,host2[:port2],... [,hostN[:portN]]] [/[database][?options]]</code></p>

    </td>
  </tr></tbody></table>
<p>The <code>app.param()</code> method is another Express.js middleware. It basically says “<em>do something every time there is this value in the URL pattern of the request handler.</em>” In our case, we select a particular collection when request pattern contains a string <code>collectionName</code> prefixed with a colon (you’ll see it later in the routes):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">param</code><code class="p">(</code><code class="s1">'collectionName'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">,</code> <code class="nx">collectionName</code><code class="p">){</code>
<code class="lineno">2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">collection</code><code class="p">(</code><code class="nx">collectionName</code><code class="p">)</code>
<code class="lineno">3</code>   <code class="k">return</code> <code class="nx">next</code><code class="p">()</code>
<code class="lineno">4</code> <code class="p">})</code>
</pre></div>

</div>

<p>Merely, to be user-friendly, let’s put a root route with a message:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'please select a collection, e.g., /collections/messages'</code><code class="p">)</code>
<code class="lineno">3</code> <code class="p">})</code>
</pre></div>

</div>

<p>Now the real work begins, here is how we retrieve a list of items sorted by <code>_id</code> and which has a limit of 10:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/collections/:collectionName'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">find</code><code class="p">({},{</code>
<code class="lineno">3</code>     <code class="nx">limit</code><code class="o">:</code><code class="mi">10</code><code class="p">,</code> <code class="nx">sort</code><code class="o">:</code> <code class="p">[[</code><code class="s1">'_id'</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">]]</code>
<code class="lineno">4</code>   <code class="p">}).</code><code class="nx">toArray</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">results</code><code class="p">){</code>
<code class="lineno">5</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code>
<code class="lineno">6</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">results</code><code class="p">)</code>
<code class="lineno">7</code>   <code class="p">})</code>
<code class="lineno">8</code> <code class="p">})</code>
</pre></div>

</div>

<p>Have you noticed a <code>:collectionName</code> string in the URL pattern parameter? This and the previous <code>app.param()</code> middleware is what gives us the <code>req.collection</code> object which points to a specified collection in our database.</p>

<p>The object creating endpoint is slightly easier to grasp since we just pass the whole payload to the MongoDB (method a.k.a. free JSON REST API):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/collections/:collectionName'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">insert</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">,</code> <code class="p">{},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">results</code><code class="p">){</code>
<code class="lineno">3</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code>
<code class="lineno">4</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">results</code><code class="p">)</code>
<code class="lineno">5</code>   <code class="p">})</code>
<code class="lineno">6</code> <code class="p">})</code>
</pre></div>

</div>

<p>Single object retrieval functions are faster than <code>find()</code>, but they use different interface (they return object directly instead of a cursor), so please be aware of that. In addition, we’re extracting the ID from <code>:id</code> part of the path with <code>req.params.id</code> Express.js magic:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/collections/:collectionName/:id'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code>
<code class="lineno">3</code>     <code class="nx">_id</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">id</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code>
<code class="lineno">4</code>   <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">result</code><code class="p">){</code>
<code class="lineno">5</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code>
<code class="lineno">6</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">result</code><code class="p">)</code>
<code class="lineno">7</code>   <code class="p">})</code>
<code class="lineno">8</code> <code class="p">})</code>
</pre></div>

</div>

<p>PUT request handler gets more interesting because <code>update()</code> doesn’t return the augmented object; instead, it returns a count of affected objects.</p>

<p>Also <code>{$set:req.body}</code> is a special MongoDB operator (operators tend to start with a dollar sign) that sets values.</p>

<p>The second ` {safe:true, multi:false}` parameter is an object with options that tell MongoDB to wait for the execution before running the callback function and to process only one (first) item.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="s1">'/collections/:collectionName/:id'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">update</code><code class="p">({</code>
<code class="lineno"> 3</code>       <code class="nx">_id</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">id</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code>
<code class="lineno"> 4</code>     <code class="p">},</code> <code class="p">{</code><code class="nx">$set</code><code class="o">:</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">},</code> <code class="p">{</code><code class="nx">safe</code><code class="o">:</code><code class="kc">true</code><code class="p">,</code> <code class="nx">multi</code><code class="o">:</code><code class="kc">false</code><code class="p">},</code>
<code class="lineno"> 5</code>     <code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">result</code><code class="p">){</code>
<code class="lineno"> 6</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code>
<code class="lineno"> 7</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">((</code><code class="nx">result</code><code class="o">===</code><code class="mi">1</code><code class="p">)</code><code class="o">?</code><code class="p">{</code><code class="nx">msg</code><code class="o">:</code><code class="s1">'success'</code><code class="p">}</code><code class="o">:</code><code class="p">{</code><code class="nx">msg</code><code class="o">:</code><code class="s1">'error'</code><code class="p">})</code>
<code class="lineno"> 8</code>     <code class="p">}</code>
<code class="lineno"> 9</code>   <code class="p">);</code>
<code class="lineno">10</code> <code class="p">})</code>
</pre></div>

</div>

<p>Finally, the DELETE method which also outputs a custom JSON message:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="s1">'/collections/:collectionName/:id'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">remove</code><code class="p">({</code>
<code class="lineno"> 3</code>       <code class="nx">_id</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">id</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code>
<code class="lineno"> 4</code>     <code class="p">},</code>
<code class="lineno"> 5</code>     <code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">result</code><code class="p">){</code>
<code class="lineno"> 6</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code>
<code class="lineno"> 7</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">((</code><code class="nx">result</code><code class="o">===</code><code class="mi">1</code><code class="p">)</code><code class="o">?</code><code class="p">{</code><code class="nx">msg</code><code class="o">:</code><code class="s1">'success'</code><code class="p">}</code><code class="o">:</code><code class="p">{</code><code class="nx">msg</code><code class="o">:</code><code class="s1">'error'</code><code class="p">})</code>
<code class="lineno"> 8</code>     <code class="p">}</code>
<code class="lineno"> 9</code>   <code class="p">);</code>
<code class="lineno">10</code> <code class="p">})</code>
</pre></div>

</div>

<p>Note: <em>The <code>delete</code> is an operator in JavaScript, so Express.js uses <code>app.del</code> instead.</em></p>

<p>The last line that actually starts the server on port 3000 in this case:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="mi">3000</code><code class="p">)</code>
</pre></div>

</div>

<p>Just in case something is not working quite well, here is the full code of <strong>rest-api-express/express.js</strong> file :</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">)</code>
<code class="lineno"> 2</code>   <code class="p">,</code> <code class="nx">mongoskin</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongoskin'</code><code class="p">)</code>
<code class="lineno"> 3</code>
<code class="lineno"> 4</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">()</code>
<code class="lineno"> 5</code> <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">bodyParser</code><code class="p">())</code>
<code class="lineno"> 6</code>
<code class="lineno"> 7</code> <code class="kd">var</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">mongoskin</code><code class="p">.</code><code class="nx">db</code><code class="p">(</code><code class="s1">'localhost:27017/test'</code><code class="p">,</code> <code class="p">{</code><code class="nx">safe</code><code class="o">:</code><code class="kc">true</code><code class="p">});</code>
<code class="lineno"> 8</code>
<code class="lineno"> 9</code> <code class="nx">app</code><code class="p">.</code><code class="nx">param</code><code class="p">(</code><code class="s1">'collectionName'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">,</code> <code class="nx">collectionName</code><code class="p">){</code>
<code class="lineno">10</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">collection</code><code class="p">(</code><code class="nx">collectionName</code><code class="p">)</code>
<code class="lineno">11</code>   <code class="k">return</code> <code class="nx">next</code><code class="p">()</code>
<code class="lineno">12</code> <code class="p">})</code>
<code class="lineno">13</code>
<code class="lineno">14</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">15</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'please select a collection, e.g., /collections/messages'</code><code class="p">)</code>
<code class="lineno">16</code> <code class="p">})</code>
<code class="lineno">17</code>
<code class="lineno">18</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/collections/:collectionName'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">19</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">find</code><code class="p">({},{</code><code class="nx">limit</code><code class="o">:</code><code class="mi">10</code><code class="p">,</code> <code class="nx">sort</code><code class="o">:</code> <code class="p">[[</code><code class="s1">'_id'</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">]]}).</code><code class="nx">toArray</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">resu</code><code class="o">\</code>
<code class="lineno">20</code> <code class="nx">lts</code><code class="p">){</code>
<code class="lineno">21</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code>
<code class="lineno">22</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">results</code><code class="p">)</code>
<code class="lineno">23</code>   <code class="p">})</code>
<code class="lineno">24</code> <code class="p">})</code>
<code class="lineno">25</code>
<code class="lineno">26</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/collections/:collectionName'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">27</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">insert</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">,</code> <code class="p">{},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">results</code><code class="p">){</code>
<code class="lineno">28</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code>
<code class="lineno">29</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">results</code><code class="p">)</code>
<code class="lineno">30</code>   <code class="p">})</code>
<code class="lineno">31</code> <code class="p">})</code>
<code class="lineno">32</code>
<code class="lineno">33</code>
<code class="lineno">34</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/collections/:collectionName/:id'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">35</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code><code class="nx">_id</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">id</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">)},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">res</code><code class="o">\</code>
<code class="lineno">36</code> <code class="nx">ult</code><code class="p">){</code>
<code class="lineno">37</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code>
<code class="lineno">38</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">result</code><code class="p">)</code>
<code class="lineno">39</code>   <code class="p">})</code>
<code class="lineno">40</code> <code class="p">})</code>
<code class="lineno">41</code> <code class="nx">app</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="s1">'/collections/:collectionName/:id'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">42</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">update</code><code class="p">({</code><code class="nx">_id</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">id</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">)},</code> <code class="p">{</code><code class="nx">$set</code><code class="o">:</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">},</code><code class="o">\</code>
<code class="lineno">43</code>  <code class="p">{</code><code class="nx">safe</code><code class="o">:</code><code class="kc">true</code><code class="p">,</code> <code class="nx">multi</code><code class="o">:</code><code class="kc">false</code><code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">result</code><code class="p">){</code>
<code class="lineno">44</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code>
<code class="lineno">45</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">((</code><code class="nx">result</code><code class="o">===</code><code class="mi">1</code><code class="p">)</code><code class="o">?</code><code class="p">{</code><code class="nx">msg</code><code class="o">:</code><code class="s1">'success'</code><code class="p">}</code><code class="o">:</code><code class="p">{</code><code class="nx">msg</code><code class="o">:</code><code class="s1">'error'</code><code class="p">})</code>
<code class="lineno">46</code>   <code class="p">})</code>
<code class="lineno">47</code> <code class="p">})</code>
<code class="lineno">48</code> <code class="nx">app</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="s1">'/collections/:collectionName/:id'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">49</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">remove</code><code class="p">({</code><code class="nx">_id</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">collection</code><code class="p">.</code><code class="nx">id</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">)},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">resu</code><code class="o">\</code>
<code class="lineno">50</code> <code class="nx">lt</code><code class="p">){</code>
<code class="lineno">51</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code>
<code class="lineno">52</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">((</code><code class="nx">result</code><code class="o">===</code><code class="mi">1</code><code class="p">)</code><code class="o">?</code><code class="p">{</code><code class="nx">msg</code><code class="o">:</code><code class="s1">'success'</code><code class="p">}</code><code class="o">:</code><code class="p">{</code><code class="nx">msg</code><code class="o">:</code><code class="s1">'error'</code><code class="p">})</code>
<code class="lineno">53</code>   <code class="p">})</code>
<code class="lineno">54</code> <code class="p">})</code>
<code class="lineno">55</code>
<code class="lineno">56</code>
<code class="lineno">57</code>
<code class="lineno">58</code> <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="mi">3000</code><code class="p">)</code>
</pre></div>

</div>

<p>Exit your editor and run this command in your terminal:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>node express.js
</pre></div>

</div>

<p>And in a different window (without closing the first one):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>mocha express.test.js
</pre></div>

</div>

<p>If you really don’t like Mocha and/or BDD, CURL is always there for you. :-)</p>

<p>For example, CURL data to make a POST request:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>curl -d <code class="s2">""</code> http://localhost:3000
</pre></div>

</div>
<p>GET requests also work in the browser, for example <a href="http://localhost:3000/test">http://localhost:3000/test</a>.</p>

<p>In this tutorial, our tests are longer than the app code itself so abandoning test-driven development might be tempting, but believe me, <strong>the good habits of TDD will save you hours and hours</strong> during any serious development when the complexity of the application you are working on is big.</p>

<h3 id="leanpub-auto-conclusion-2">
<span class="section-number">3.4 </span>Conclusion</h3>

<p>The Express.js and Mongoskin libraries are great when you need to build a simple REST API server in a few lines of code. Later, if you need to expand the libraries, they also provide a way to configure and organize your code.</p>

<p>NoSQL databases like MongoDB are good at free-REST APIs where we don’t have to define schemas and can throw any data and it’ll be saved.</p>

<p>The full code for both test and app files: <a href="https://gist.github.com/azat-co/6075685">https://gist.github.com/azat-co/6075685</a>.</p>

<p>If you would like to learn more about Express.js and other JavaScript libraries, take a look at the series <a href="http://webapplog.com/tag/intro-to-express-js/">Intro to Express.js tutorials</a>.</p>

<p>Note: *In this example, I’m using semi-colon less style. Semi-colons in JavaScript are <a href="http://blog.izs.me/post/2353458699/an-open-letter-to-javascript-leaders-regarding">absolutely optional</a> except in two cases: in the for loop and before expressions/statements that start with parenthesis (e.g., <a href="http://en.wikipedia.org/wiki/Immediately-invoked_function_expression">Immediately-Invoked Function Expression</a>).</p>

<h2 id="hackhall">
<span class="section-number">4 </span>HackHall</h2>

<div class="aside sidebarish">
  <h3 id="leanpub-auto-summary-5">Summary</h3>

  <p>The HachHall app is a REST API server with a front-end client that is written in Backbone.js and Underscore. For the purpose of this book, we’ll illustrate how to use Express.js with MongoDB via Mongoose for the back-end REST API server. In addition, the projects utilizes OAuth and sessions, and Mocha for TDD.</p>

</div>

<table class="exercise sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="https://leanpub.com/site_images/express/leanpub_exercise.png" alt="exercise">
</td>
    <td>
      <h3 id="leanpub-auto-example-3">Example</h3>

  <p>The HackHall source code is in the public <a href="http://github.com/azat-co/hackhall">GitHub repository</a>.</p>

    </td>
  </tr></tbody></table>
<p>The live demo is accessible at <a href="http://hackhall.com">hackhall.com</a> either with AngelList or pre-filled email (1@1.com) and password (1).</p>

<h3 id="leanpub-auto-what-is-hackhall">
<span class="section-number">4.1 </span>What is HackHall</h3>

<p>HackHall (ex-Accelerator.IO) is an open-source invite-only social network and collaboration tool for hackers, hipsters, entrepreneurs and pirates (just kidding). HackHall is akin to Reddit, plus Hacker News, plus Facebook Groups with curation.</p>

<p>The HackHall project is in its early stage and roughly a beta. We plan to extend the code base in the future and bring in more people to share skills, wisdom and passion for programming.</p>

<p>In this chapter, we’ll cover the <a href="https://github.com/azat-co/hackhall/releases/tag/1.0">1.0 release</a> which has:</p>

<ul>
<li>OAuth 1.0 with oauth modules and AngelList API</li>
  <li>Email and password authentication</li>
  <li>Mongoose models and schemas</li>
  <li>Express.js structure with routes in modules</li>
  <li>JSON REST API</li>
  <li>Express.js error handling</li>
  <li>Front-end client Backbone.js app (for more info on Backbone.js, download/read online our <a href="http://rpjs.co">Rapid Prototyping with JS</a> tutorials)</li>
  <li>Environmental variables with Foreman’s <code>.env</code>
</li>
  <li>TDD with Mocha</li>
  <li>Basic Makefile setup</li>
</ul>
<h3 id="leanpub-auto-running-hackhall">
<span class="section-number">4.2 </span>Running HackHall</h3>

<p>To get the source code, you can navigate to <code>hackhall</code> folder or clone from GitHub:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>git clone git@github.com:azat-co/hackhall
<code class="lineno">2</code> <code class="nv">$ </code>git checkout 1.0
<code class="lineno">3</code> <code class="nv">$ </code>npm install
</pre></div>

</div>

<p>If you plan to test an AngelList (optional), HackHall is using Heroku and Foreman setup for AngelList API keys storing them in environmental variables, so we need to add <code>.evn</code> file like this (below are fake values):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">ANGELLIST_CLIENT_ID</code><code class="o">=</code>254C0335-5F9A-4607-87C0
<code class="lineno">2</code> <code class="nv">ANGELLIST_CLIENT_SECRET</code><code class="o">=</code>99F5C1AC-C5F7-44E6-81A1-8DF4FC42B8D9
</pre></div>

</div>

<p>The keys are obtainable at <a href="https://angel.co/api">angel.co/api</a> after someone creates and registers his/her AngelList app.</p>

<p>Download and install MongoDB if you don’t have it already. The databases and third-party libraries are out of scope of this book. However, you can find enough materials <a href="http://webapplog.com">online</a> and in <a href="http://rpjs.co">Rapid Prototyping with JS</a>.</p>

<p>To start MongoDB server, open a new terminal window and run:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>mongod
</pre></div>

</div>

<p>Go back to the project folder and run:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>foreman start
</pre></div>

</div>

<p>After MongoDB is running on localhost with default port 27017, it’s possible to seed the database <code>hackhall</code> with default admin user by running <code>seed.js</code> mongo script:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>mongo localhost:27017/hackhall seed.js
</pre></div>

</div>

<p>Feel free to modify <code>seed.js</code> to your liking (beware that it erases all previous data!):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">db</code><code class="p">.</code><code class="nx">dropDatabase</code><code class="p">();</code>
<code class="lineno"> 2</code> <code class="kd">var</code> <code class="nx">seedUser</code> <code class="o">=</code><code class="p">{</code>
<code class="lineno"> 3</code>   <code class="nx">firstName</code><code class="o">:</code><code class="s1">'Azat'</code><code class="p">,</code>
<code class="lineno"> 4</code>   <code class="nx">lastName</code><code class="o">:</code><code class="s2">"Mardanov"</code><code class="p">,</code>
<code class="lineno"> 5</code>   <code class="nx">displayName</code><code class="o">:</code><code class="s2">"Azat Mardanov"</code><code class="p">,</code>
<code class="lineno"> 6</code>   <code class="nx">password</code><code class="o">:</code><code class="s1">'1'</code><code class="p">,</code>
<code class="lineno"> 7</code>   <code class="nx">email</code><code class="o">:</code><code class="s1">'1@1.com'</code><code class="p">,</code>
<code class="lineno"> 8</code>   <code class="nx">role</code><code class="o">:</code><code class="s1">'admin'</code><code class="p">,</code>
<code class="lineno"> 9</code>   <code class="nx">approved</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">10</code>   <code class="nx">admin</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">11</code> <code class="p">};</code>
<code class="lineno">12</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">save</code><code class="p">(</code><code class="nx">seedUser</code><code class="p">);</code>
</pre></div>

</div>

<p>If you open your browser at <a href="http://localhost:5000">http://localhost:5000</a>, you should see the login screen.</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/hackhall-login.png" alt="The HackHall login page running locally."><p class="caption">The HackHall login page running locally.</p>
</div>

<p>Enter username and password to get in (the ones from the <code>seed.js</code> file).</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/hackhall-login-filled.png" alt="The HackHall login page with seed data."><p class="caption">The HackHall login page with seed data.</p>
</div>

<p>After successful authentication, users are redirected to the Posts page:</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/hackhall-posts.png" alt="The HackHall Posts page."><p class="caption">The HackHall Posts page.</p>
</div>

<p>where they can create a post (e.g., a question):</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/hackhall-new-post.png" alt="The HackHall Posts page."><p class="caption">The HackHall Posts page.</p>
</div>

<p>Save the post:</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/hackhall-posts-saved.png" alt="The HackHall Posts page with a saved post."><p class="caption">The HackHall Posts page with a saved post.</p>
</div>

<p>Like posts:</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/hackhall-posts-liked.png" alt="The HackHall Posts page with a liked post."><p class="caption">The HackHall Posts page with a liked post.</p>
</div>

<p>Visit other users’ profiles:</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/hackhall-people.png" alt="The HackHall People page."><p class="caption">The HackHall People page.</p>
</div>

<p>If they have admin rights, users can approve applicants:</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/hackhall-people-manage.png" alt="The HackHall People page with admin rights."><p class="caption">The HackHall People page with admin rights.</p>
</div>

<p>and manage their account on Profile page:</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/hackhall-profile.png" alt="The HackHall Profile page."><p class="caption">The HackHall Profile page.</p>
</div>

<h3 id="leanpub-auto-structure-1">
<span class="section-number">4.3 </span>Structure</h3>

<p>Here are what each of the folders and files have:</p>

<ul>
<li>
<code>/api</code>: app-shared routes</li>
  <li>
<code>/models</code>: Mongoose models</li>
  <li>
<code>/public</code>: Backbone app, static files like front-end JavaScript, CSS, HTML</li>
  <li>
<code>/routes</code>: REST API routes</li>
  <li>
<code>/tests</code>: Mocha tests</li>
  <li>
<code>.gitignore</code>: list of files that git should ignore</li>
  <li>
<code>Makefile</code>: make file to run tests</li>
  <li>
<code>Procfile</code>: Cedar stack file needed for Heroku deployment</li>
  <li>
<code>package.json</code>: NPM dependencies and HackHall meta data</li>
  <li>
<code>readme.md</code>: description</li>
  <li>
<code>server.js</code>: main HackHall server file</li>
</ul>
<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/hackhall-ls.png" alt="Content of the HackHall base folder."><p class="caption">Content of the HackHall base folder.</p>
</div>

<h3 id="leanpub-auto-expressjs-app">
<span class="section-number">4.4 </span>Express.js App</h3>

<p>Let’s jump straight to the <code>server.js</code> file and learn how it’s implemented. Firstly, we declare dependencies:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">),</code>
<code class="lineno">2</code>   <code class="nx">routes</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./routes'</code><code class="p">),</code>
<code class="lineno">3</code>   <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">),</code>
<code class="lineno">4</code>   <code class="nx">util</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'util'</code><code class="p">),</code>
<code class="lineno">5</code>   <code class="nx">oauth</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'oauth'</code><code class="p">),</code>
<code class="lineno">6</code>   <code class="nx">querystring</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'querystring'</code><code class="p">);</code>
</pre></div>

</div>

<p>Then, we initialize app and configure middlewares. The <code>process.env.PORT</code> is populated by Heroku, and in case of a local setup fallsback on 3000.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
<code class="lineno">2</code> <code class="nx">app</code><code class="p">.</code><code class="nx">configure</code><code class="p">(</code><code class="kd">function</code><code class="p">(){</code>
<code class="lineno">3</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'port'</code><code class="p">,</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code>  <code class="p">);</code>
<code class="lineno">4</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">favicon</code><code class="p">());</code>
<code class="lineno">5</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">logger</code><code class="p">(</code><code class="s1">'dev'</code><code class="p">));</code>
<code class="lineno">6</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">bodyParser</code><code class="p">());</code>
<code class="lineno">7</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">methodOverride</code><code class="p">());</code>
</pre></div>

</div>

<p>The values passed to cookieParser and session middlewares are needed for authentication. Obviously, session secrets are supposed to be private:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">cookieParser</code><code class="p">(</code><code class="s1">'asd;lfkajs;ldfkj'</code><code class="p">));</code>
<code class="lineno">2</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">session</code><code class="p">({</code>
<code class="lineno">3</code>     <code class="nx">secret</code><code class="o">:</code> <code class="s1">'&lt;h1&gt;WHEEYEEE&lt;/h1&gt;'</code><code class="p">,</code>
<code class="lineno">4</code>     <code class="nx">key</code><code class="o">:</code> <code class="s1">'sid'</code><code class="p">,</code>
<code class="lineno">5</code>     <code class="nx">cookie</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">6</code>       <code class="nx">secret</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">7</code>       <code class="nx">expires</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno">8</code>     <code class="p">}</code>
<code class="lineno">9</code>   <code class="p">}));</code>
</pre></div>

</div>

<p>This is how we serve our front-end client Backbone.js app and other static files like CSS:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/public'</code><code class="p">));</code>
<code class="lineno">2</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">router</code><code class="p">);</code>
<code class="lineno">3</code> <code class="p">});</code>
</pre></div>

</div>

<p>Error handling is broken down into three functions with <code>clientErrorHandler</code> dedicated to AJAX/XHR requests from the Backbone.js app (responds with JSON):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">configure</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">logErrors</code><code class="p">);</code>
<code class="lineno"> 3</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">clientErrorHandler</code><code class="p">);</code>
<code class="lineno"> 4</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">errorHandler</code><code class="p">);</code>
<code class="lineno"> 5</code> <code class="p">});</code>
<code class="lineno"> 6</code>
<code class="lineno"> 7</code> <code class="kd">function</code> <code class="nx">logErrors</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 8</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'logErrors'</code><code class="p">,</code> <code class="nx">err</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code>
<code class="lineno"> 9</code>   <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">10</code> <code class="p">}</code>
<code class="lineno">11</code>
<code class="lineno">12</code> <code class="kd">function</code> <code class="nx">clientErrorHandler</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">13</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'clientErrors '</code><code class="p">,</code> <code class="nx">err</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code>
<code class="lineno">14</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">500</code><code class="p">,</code> <code class="p">{</code> <code class="nx">error</code><code class="o">:</code> <code class="nx">err</code><code class="p">.</code><code class="nx">toString</code><code class="p">()});</code>
<code class="lineno">15</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">xhr</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">16</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">17</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">500</code><code class="p">,</code> <code class="p">{</code> <code class="nx">error</code><code class="o">:</code> <code class="nx">err</code><code class="p">.</code><code class="nx">toString</code><code class="p">()});</code>
<code class="lineno">18</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">19</code>     <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">20</code>   <code class="p">}</code>
<code class="lineno">21</code> <code class="p">}</code>
<code class="lineno">22</code>
<code class="lineno">23</code> <code class="kd">function</code> <code class="nx">errorHandler</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">24</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'lastErrors '</code><code class="p">,</code> <code class="nx">err</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code>
<code class="lineno">25</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">500</code><code class="p">,</code> <code class="p">{</code><code class="nx">error</code><code class="o">:</code> <code class="nx">err</code><code class="p">.</code><code class="nx">toString</code><code class="p">()});</code>
<code class="lineno">26</code> <code class="p">}</code>
</pre></div>

</div>

<p>In the same way that we determine <code>process.env.PORT</code> and fallback on local setup value 3000, we do a similar thing with MongoDB connection string:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">dbUrl</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">MONGOHQ_URL</code>
<code class="lineno">2</code>   <code class="o">||</code> <code class="s1">'mongodb://@127.0.0.1:27017/hackhall'</code><code class="p">;</code>
<code class="lineno">3</code> <code class="kd">var</code> <code class="nx">mongoose</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongoose'</code><code class="p">);</code>
<code class="lineno">4</code> <code class="kd">var</code> <code class="nx">connection</code> <code class="o">=</code> <code class="nx">mongoose</code><code class="p">.</code><code class="nx">createConnection</code><code class="p">(</code><code class="nx">dbUrl</code><code class="p">);</code>
<code class="lineno">5</code> <code class="nx">connection</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="nx">console</code><code class="p">,</code>
<code class="lineno">6</code>   <code class="s1">'connection error:'</code><code class="p">));</code>
</pre></div>

</div>

<p>Sometime it’s a good idea to log on the connection open event:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">connection</code><code class="p">.</code><code class="nx">once</code><code class="p">(</code><code class="s1">'open'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'connected to database'</code><code class="p">)</code>
<code class="lineno">3</code> <code class="p">});</code>
</pre></div>

</div>

<p>The Mongoose models live in the <code>models</code> folder:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">models</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./models'</code><code class="p">);</code>
</pre></div>

</div>

<p>This middleware will provide access to two collections within our routes methods:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">function</code> <code class="nx">db</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code> <code class="o">=</code> <code class="p">{</code>
<code class="lineno">3</code>     <code class="nx">User</code><code class="o">:</code> <code class="nx">connection</code><code class="p">.</code><code class="nx">model</code><code class="p">(</code><code class="s1">'User'</code><code class="p">,</code> <code class="nx">models</code><code class="p">.</code><code class="nx">User</code><code class="p">,</code> <code class="s1">'users'</code><code class="p">),</code>
<code class="lineno">4</code>     <code class="nx">Post</code><code class="o">:</code> <code class="nx">connection</code><code class="p">.</code><code class="nx">model</code><code class="p">(</code><code class="s1">'Post'</code><code class="p">,</code> <code class="nx">models</code><code class="p">.</code><code class="nx">Post</code><code class="p">,</code> <code class="s1">'posts'</code><code class="p">)</code>
<code class="lineno">5</code>   <code class="p">};</code>
<code class="lineno">6</code>   <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno">7</code> <code class="p">}</code>
</pre></div>

</div>

<p>Just a new name for imported auth functions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">checkUser</code> <code class="o">=</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">checkUser</code><code class="p">;</code>
<code class="lineno">2</code> <code class="nx">checkAdmin</code> <code class="o">=</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">checkAdmin</code><code class="p">;</code>
<code class="lineno">3</code> <code class="nx">checkApplicant</code> <code class="o">=</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">checkApplicant</code><code class="p">;</code>
</pre></div>

</div>

<p>AngelList OAuth routes:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/auth/angellist'</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">auth</code><code class="p">.</code><code class="nx">angelList</code><code class="p">);</code>
<code class="lineno">2</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/auth/angellist/callback'</code><code class="p">,</code>
<code class="lineno">3</code>   <code class="nx">routes</code><code class="p">.</code><code class="nx">auth</code><code class="p">.</code><code class="nx">angelListCallback</code><code class="p">,</code>
<code class="lineno">4</code>   <code class="nx">routes</code><code class="p">.</code><code class="nx">auth</code><code class="p">.</code><code class="nx">angelListLogin</code><code class="p">,</code>
<code class="lineno">5</code>   <code class="nx">db</code><code class="p">,</code>
<code class="lineno">6</code>   <code class="nx">routes</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">findOrAddUser</code><code class="p">);</code>
</pre></div>

</div>

<p>Main application routes including <code>api/profile</code>  return user session if user is logged in:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="c1">//MAIN</code>
<code class="lineno">2</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/api/profile'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">profile</code><code class="p">);</code>
<code class="lineno">3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="s1">'/api/profile'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">delProfile</code><code class="p">);</code>
<code class="lineno">4</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/api/login'</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">login</code><code class="p">);</code>
<code class="lineno">5</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/api/logout'</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">logout</code><code class="p">);</code>
</pre></div>

</div>

<p>The POST requests for creating users and posts:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="c1">//POSTS</code>
<code class="lineno"> 2</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/api/posts'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">getPosts</code><code class="p">);</code>
<code class="lineno"> 3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/api/posts'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">add</code><code class="p">);</code>
<code class="lineno"> 4</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/api/posts/:id'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">getPost</code><code class="p">);</code>
<code class="lineno"> 5</code> <code class="nx">app</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="s1">'/api/posts/:id'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">updatePost</code><code class="p">);</code>
<code class="lineno"> 6</code> <code class="nx">app</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="s1">'/api/posts/:id'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">del</code><code class="p">);</code>
<code class="lineno"> 7</code>
<code class="lineno"> 8</code> <code class="c1">//USERS</code>
<code class="lineno"> 9</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/api/users'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">getUsers</code><code class="p">);</code>
<code class="lineno">10</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/api/users/:id'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code><code class="nx">routes</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">getUser</code><code class="p">);</code>
<code class="lineno">11</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/api/users'</code><code class="p">,</code> <code class="nx">checkAdmin</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">add</code><code class="p">);</code>
<code class="lineno">12</code> <code class="nx">app</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="s1">'/api/users/:id'</code><code class="p">,</code> <code class="nx">checkAdmin</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">update</code><code class="p">);</code>
<code class="lineno">13</code> <code class="nx">app</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="s1">'/api/users/:id'</code><code class="p">,</code> <code class="nx">checkAdmin</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">del</code><code class="p">);</code>
</pre></div>

</div>

<p>These routes are for new members that haven’t been approved yet:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="c1">//APPLICATION</code>
<code class="lineno"> 2</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/api/application'</code><code class="p">,</code>
<code class="lineno"> 3</code>   <code class="nx">checkAdmin</code><code class="p">,</code>
<code class="lineno"> 4</code>   <code class="nx">db</code><code class="p">,</code>
<code class="lineno"> 5</code>   <code class="nx">routes</code><code class="p">.</code><code class="nx">application</code><code class="p">.</code><code class="nx">add</code><code class="p">);</code>
<code class="lineno"> 6</code> <code class="nx">app</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="s1">'/api/application'</code><code class="p">,</code>
<code class="lineno"> 7</code>   <code class="nx">checkApplicant</code><code class="p">,</code>
<code class="lineno"> 8</code>   <code class="nx">db</code><code class="p">,</code>
<code class="lineno"> 9</code>   <code class="nx">routes</code><code class="p">.</code><code class="nx">application</code><code class="p">.</code><code class="nx">update</code><code class="p">);</code>
<code class="lineno">10</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/api/application'</code><code class="p">,</code>
<code class="lineno">11</code>   <code class="nx">checkApplicant</code><code class="p">,</code>
<code class="lineno">12</code>   <code class="nx">db</code><code class="p">,</code>
<code class="lineno">13</code>   <code class="nx">routes</code><code class="p">.</code><code class="nx">application</code><code class="p">.</code><code class="nx">get</code><code class="p">);</code>
</pre></div>

</div>

<p>The catch all else route:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'*'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
<code class="lineno">2</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">404</code><code class="p">);</code>
<code class="lineno">3</code> <code class="p">});</code>
</pre></div>

</div>

<p>The <code>require.main === module</code> is a clever trick to determine if this file is being executed as a stand alone or as an imported module:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">http</code><code class="p">.</code><code class="nx">createServer</code><code class="p">(</code><code class="nx">app</code><code class="p">);</code>
<code class="lineno"> 2</code> <code class="k">if</code> <code class="p">(</code><code class="nx">require</code><code class="p">.</code><code class="nx">main</code> <code class="o">===</code> <code class="nx">module</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 3</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">),</code> <code class="kd">function</code><code class="p">(){</code>
<code class="lineno"> 4</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Express server listening on port '</code>
<code class="lineno"> 5</code>       <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">));</code>
<code class="lineno"> 6</code>   <code class="p">});</code>
<code class="lineno"> 7</code> <code class="p">}</code>
<code class="lineno"> 8</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 9</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Running app as a module'</code><code class="p">)</code>
<code class="lineno">10</code>   <code class="nx">exports</code><code class="p">.</code><code class="nx">app</code> <code class="o">=</code> <code class="nx">app</code><code class="p">;</code>
<code class="lineno">11</code> <code class="p">}</code>
</pre></div>

</div>

<p>The full source code for <code>hackhall/server.js</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">  1</code> <code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">),</code>
<code class="lineno">  2</code>   <code class="nx">routes</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./routes'</code><code class="p">),</code>
<code class="lineno">  3</code>   <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">),</code>
<code class="lineno">  4</code>   <code class="nx">util</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'util'</code><code class="p">),</code>
<code class="lineno">  5</code>   <code class="nx">oauth</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'oauth'</code><code class="p">),</code>
<code class="lineno">  6</code>   <code class="nx">querystring</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'querystring'</code><code class="p">);</code>
<code class="lineno">  7</code>
<code class="lineno">  8</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
<code class="lineno">  9</code> <code class="nx">app</code><code class="p">.</code><code class="nx">configure</code><code class="p">(</code><code class="kd">function</code><code class="p">(){</code>
<code class="lineno"> 10</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'port'</code><code class="p">,</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code>  <code class="p">);</code>
<code class="lineno"> 11</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">favicon</code><code class="p">());</code>
<code class="lineno"> 12</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">logger</code><code class="p">(</code><code class="s1">'dev'</code><code class="p">));</code>
<code class="lineno"> 13</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">bodyParser</code><code class="p">());</code>
<code class="lineno"> 14</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">methodOverride</code><code class="p">());</code>
<code class="lineno"> 15</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">cookieParser</code><code class="p">(</code><code class="s1">'asd;lfkajs;ldfkj'</code><code class="p">));</code>
<code class="lineno"> 16</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">session</code><code class="p">({</code>
<code class="lineno"> 17</code>     <code class="nx">secret</code><code class="o">:</code> <code class="s1">'&lt;h1&gt;WHEEYEEE&lt;/h1&gt;'</code><code class="p">,</code>
<code class="lineno"> 18</code>     <code class="nx">key</code><code class="o">:</code> <code class="s1">'sid'</code><code class="p">,</code>
<code class="lineno"> 19</code>     <code class="nx">cookie</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 20</code>       <code class="nx">secret</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 21</code>       <code class="nx">expires</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno"> 22</code>     <code class="p">}</code>
<code class="lineno"> 23</code>   <code class="p">}));</code>
<code class="lineno"> 24</code>   <code class="c1">// app.use(express.csrf());</code>
<code class="lineno"> 25</code>   <code class="c1">// app.use(function(req, res, next) {</code>
<code class="lineno"> 26</code>     <code class="c1">// res.locals.csrf = req.session._cstf;</code>
<code class="lineno"> 27</code>     <code class="c1">// return next();</code>
<code class="lineno"> 28</code>   <code class="c1">// });</code>
<code class="lineno"> 29</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/public'</code><code class="p">));</code>
<code class="lineno"> 30</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">router</code><code class="p">);</code>
<code class="lineno"> 31</code> <code class="p">});</code>
<code class="lineno"> 32</code>
<code class="lineno"> 33</code> <code class="nx">app</code><code class="p">.</code><code class="nx">configure</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 34</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">logErrors</code><code class="p">);</code>
<code class="lineno"> 35</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">clientErrorHandler</code><code class="p">);</code>
<code class="lineno"> 36</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">errorHandler</code><code class="p">);</code>
<code class="lineno"> 37</code> <code class="p">});</code>
<code class="lineno"> 38</code>
<code class="lineno"> 39</code> <code class="kd">function</code> <code class="nx">logErrors</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 40</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'logErrors'</code><code class="p">,</code> <code class="nx">err</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code>
<code class="lineno"> 41</code>   <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 42</code> <code class="p">}</code>
<code class="lineno"> 43</code>
<code class="lineno"> 44</code> <code class="kd">function</code> <code class="nx">clientErrorHandler</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 45</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'clientErrors '</code><code class="p">,</code> <code class="nx">err</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code>
<code class="lineno"> 46</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">500</code><code class="p">,</code> <code class="p">{</code> <code class="nx">error</code><code class="o">:</code> <code class="nx">err</code><code class="p">.</code><code class="nx">toString</code><code class="p">()});</code>
<code class="lineno"> 47</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">xhr</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 48</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 49</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">500</code><code class="p">,</code> <code class="p">{</code> <code class="nx">error</code><code class="o">:</code> <code class="nx">err</code><code class="p">.</code><code class="nx">toString</code><code class="p">()});</code>
<code class="lineno"> 50</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 51</code>     <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 52</code>   <code class="p">}</code>
<code class="lineno"> 53</code> <code class="p">}</code>
<code class="lineno"> 54</code>
<code class="lineno"> 55</code> <code class="kd">function</code> <code class="nx">errorHandler</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 56</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'lastErrors '</code><code class="p">,</code> <code class="nx">err</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code>
<code class="lineno"> 57</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">500</code><code class="p">,</code> <code class="p">{</code><code class="nx">error</code><code class="o">:</code> <code class="nx">err</code><code class="p">.</code><code class="nx">toString</code><code class="p">()});</code>
<code class="lineno"> 58</code> <code class="p">}</code>
<code class="lineno"> 59</code>
<code class="lineno"> 60</code> <code class="kd">var</code> <code class="nx">dbUrl</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">MONGOHQ_URL</code> <code class="o">||</code> <code class="s1">'mongodb://@127.0.0.1:27017/hackhall'</code><code class="p">;</code>
<code class="lineno"> 61</code> <code class="kd">var</code> <code class="nx">mongoose</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongoose'</code><code class="p">);</code>
<code class="lineno"> 62</code> <code class="kd">var</code> <code class="nx">connection</code> <code class="o">=</code> <code class="nx">mongoose</code><code class="p">.</code><code class="nx">createConnection</code><code class="p">(</code><code class="nx">dbUrl</code><code class="p">);</code>
<code class="lineno"> 63</code> <code class="nx">connection</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="nx">console</code><code class="p">,</code> <code class="s1">'connection error:'</code><code class="p">));</code>
<code class="lineno"> 64</code> <code class="nx">connection</code><code class="p">.</code><code class="nx">once</code><code class="p">(</code><code class="s1">'open'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 65</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'connected to database'</code><code class="p">)</code>
<code class="lineno"> 66</code> <code class="p">});</code>
<code class="lineno"> 67</code>
<code class="lineno"> 68</code> <code class="kd">var</code> <code class="nx">models</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./models'</code><code class="p">);</code>
<code class="lineno"> 69</code> <code class="kd">function</code> <code class="nx">db</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 70</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code> <code class="o">=</code> <code class="p">{</code>
<code class="lineno"> 71</code>     <code class="nx">User</code><code class="o">:</code> <code class="nx">connection</code><code class="p">.</code><code class="nx">model</code><code class="p">(</code><code class="s1">'User'</code><code class="p">,</code> <code class="nx">models</code><code class="p">.</code><code class="nx">User</code><code class="p">,</code> <code class="s1">'users'</code><code class="p">),</code>
<code class="lineno"> 72</code>     <code class="nx">Post</code><code class="o">:</code> <code class="nx">connection</code><code class="p">.</code><code class="nx">model</code><code class="p">(</code><code class="s1">'Post'</code><code class="p">,</code> <code class="nx">models</code><code class="p">.</code><code class="nx">Post</code><code class="p">,</code> <code class="s1">'posts'</code><code class="p">)</code>
<code class="lineno"> 73</code>   <code class="p">};</code>
<code class="lineno"> 74</code>   <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno"> 75</code> <code class="p">}</code>
<code class="lineno"> 76</code> <code class="nx">checkUser</code> <code class="o">=</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">checkUser</code><code class="p">;</code>
<code class="lineno"> 77</code> <code class="nx">checkAdmin</code> <code class="o">=</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">checkAdmin</code><code class="p">;</code>
<code class="lineno"> 78</code> <code class="nx">checkApplicant</code> <code class="o">=</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">checkApplicant</code><code class="p">;</code>
<code class="lineno"> 79</code>
<code class="lineno"> 80</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/auth/angellist'</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">auth</code><code class="p">.</code><code class="nx">angelList</code><code class="p">);</code>
<code class="lineno"> 81</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/auth/angellist/callback'</code><code class="p">,</code>
<code class="lineno"> 82</code>   <code class="nx">routes</code><code class="p">.</code><code class="nx">auth</code><code class="p">.</code><code class="nx">angelListCallback</code><code class="p">,</code>
<code class="lineno"> 83</code>   <code class="nx">routes</code><code class="p">.</code><code class="nx">auth</code><code class="p">.</code><code class="nx">angelListLogin</code><code class="p">,</code>
<code class="lineno"> 84</code>   <code class="nx">db</code><code class="p">,</code>
<code class="lineno"> 85</code>   <code class="nx">routes</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">findOrAddUser</code><code class="p">);</code>
<code class="lineno"> 86</code>
<code class="lineno"> 87</code> <code class="c1">//MAIN</code>
<code class="lineno"> 88</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/api/profile'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">profile</code><code class="p">);</code>
<code class="lineno"> 89</code> <code class="nx">app</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="s1">'/api/profile'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">delProfile</code><code class="p">);</code>
<code class="lineno"> 90</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/api/login'</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">login</code><code class="p">);</code>
<code class="lineno"> 91</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/api/logout'</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">main</code><code class="p">.</code><code class="nx">logout</code><code class="p">);</code>
<code class="lineno"> 92</code>
<code class="lineno"> 93</code> <code class="c1">//POSTS</code>
<code class="lineno"> 94</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/api/posts'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">getPosts</code><code class="p">);</code>
<code class="lineno"> 95</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/api/posts'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">add</code><code class="p">);</code>
<code class="lineno"> 96</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/api/posts/:id'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">getPost</code><code class="p">);</code>
<code class="lineno"> 97</code> <code class="nx">app</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="s1">'/api/posts/:id'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">updatePost</code><code class="p">);</code>
<code class="lineno"> 98</code> <code class="nx">app</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="s1">'/api/posts/:id'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">del</code><code class="p">);</code>
<code class="lineno"> 99</code>
<code class="lineno">100</code> <code class="c1">//USERS</code>
<code class="lineno">101</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/api/users'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">getUsers</code><code class="p">);</code>
<code class="lineno">102</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/api/users/:id'</code><code class="p">,</code> <code class="nx">checkUser</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code><code class="nx">routes</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">getUser</code><code class="p">);</code>
<code class="lineno">103</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/api/users'</code><code class="p">,</code> <code class="nx">checkAdmin</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">add</code><code class="p">);</code>
<code class="lineno">104</code> <code class="nx">app</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="s1">'/api/users/:id'</code><code class="p">,</code> <code class="nx">checkAdmin</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">update</code><code class="p">);</code>
<code class="lineno">105</code> <code class="nx">app</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="s1">'/api/users/:id'</code><code class="p">,</code> <code class="nx">checkAdmin</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">del</code><code class="p">);</code>
<code class="lineno">106</code>
<code class="lineno">107</code> <code class="c1">//APPLICATION </code>
<code class="lineno">108</code> <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/api/application'</code><code class="p">,</code> <code class="nx">checkAdmin</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">application</code><code class="p">.</code><code class="nx">add</code><code class="p">);</code>
<code class="lineno">109</code> <code class="nx">app</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="s1">'/api/application'</code><code class="p">,</code> <code class="nx">checkApplicant</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">application</code><code class="p">.</code><code class="nx">update</code><code class="p">);</code>
<code class="lineno">110</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/api/application'</code><code class="p">,</code> <code class="nx">checkApplicant</code><code class="p">,</code> <code class="nx">db</code><code class="p">,</code> <code class="nx">routes</code><code class="p">.</code><code class="nx">application</code><code class="p">.</code><code class="nx">get</code><code class="p">);</code>
<code class="lineno">111</code>
<code class="lineno">112</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'*'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
<code class="lineno">113</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">404</code><code class="p">);</code>
<code class="lineno">114</code> <code class="p">});</code>
<code class="lineno">115</code>
<code class="lineno">116</code> <code class="nx">http</code><code class="p">.</code><code class="nx">createServer</code><code class="p">(</code><code class="nx">app</code><code class="p">);</code>
<code class="lineno">117</code> <code class="k">if</code> <code class="p">(</code><code class="nx">require</code><code class="p">.</code><code class="nx">main</code> <code class="o">===</code> <code class="nx">module</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">118</code>   <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">),</code> <code class="kd">function</code><code class="p">(){</code>
<code class="lineno">119</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Express server listening on port '</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">));</code>
<code class="lineno">120</code>   <code class="p">});</code>
<code class="lineno">121</code> <code class="p">}</code>
<code class="lineno">122</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">123</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Running app as a module'</code><code class="p">)</code>
<code class="lineno">124</code>   <code class="nx">exports</code><code class="p">.</code><code class="nx">app</code> <code class="o">=</code> <code class="nx">app</code><code class="p">;</code>
<code class="lineno">125</code> <code class="p">}</code>
</pre></div>

</div>

<h3 id="leanpub-auto-routes-1">
<span class="section-number">4.5 </span>Routes</h3>

<p>The HackHall routes reside in <code>hackhall/routes</code> folder and are groped into several modules:</p>

<ul>
<li>
<code>hackhall/routes/index.js</code>: bridge between <code>server.js</code> and other routes in the folder</li>
  <li>
<code>hackhall/routes/auth.js</code>: routes that handle OAuth dance with AngelList API</li>
  <li>
<code>hackhall/routes/main.js</code>: login, logout and other routes</li>
  <li>
<code>hackhall/routes/users.js</code>: routes related to users REST API</li>
  <li>
<code>hackhall/routes/application.js</code>: submission of application to become a user</li>
  <li>
<code>hackhall/routes/posts.js</code>: routes related to posts REST API</li>
</ul>
<h4 id="leanpub-auto-indexjs">
<span class="section-number">4.5.1 </span>index.js</h4>

<p>Let’s peak into <code>hackhall/routes/index.js</code> where we include other modules:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">posts</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./posts'</code><code class="p">);</code>
<code class="lineno">2</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">main</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./main'</code><code class="p">);</code>
<code class="lineno">3</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">users</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./users'</code><code class="p">);</code>
<code class="lineno">4</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">application</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./application'</code><code class="p">);</code>
<code class="lineno">5</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">auth</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./auth'</code><code class="p">);</code>
</pre></div>

</div>

<h4 id="leanpub-auto-authjs">
<span class="section-number">4.5.2 </span>auth.js</h4>

<p>In this module, we’ll handle OAuth <em>dance</em> with AngelList API. To do so, we’ll have to rely on <code>https</code> library:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">https</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'https'</code><code class="p">);</code>
</pre></div>

</div>

<p>The AngelList API client ID and client secret are obtained at <a href="http://angel.co/api">angel.co/api</a> website and stored in environment variables:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">angelListClientId</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">ANGELLIST_CLIENT_ID</code><code class="p">;</code>
<code class="lineno">2</code> <code class="kd">var</code> <code class="nx">angelListClientSecret</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">ANGELLIST_CLIENT_SECRET</code><code class="p">;</code>
</pre></div>

</div>

<p>The method will redirect users to angel.co website for authentication:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">angelList</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'https://angel.co/api/oauth/authorize?client_id='</code> <code class="o">+</code> <code class="nx">angelListClien</code><code class="o">\</code>
<code class="lineno">3</code> <code class="nx">tId</code> <code class="o">+</code> <code class="s1">'&amp;scope=email&amp;response_type=code'</code><code class="p">);</code>
<code class="lineno">4</code> <code class="p">}</code>
</pre></div>

</div>

<p>After users allow our app to access their information, AngelList sends them back to this route for us to make a new (HTTPS) request to retrieve the token:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">angelListCallback</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="kd">var</code> <code class="nx">token</code><code class="p">;</code>
<code class="lineno"> 3</code>   <code class="kd">var</code> <code class="nx">buf</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>
<code class="lineno"> 4</code>   <code class="kd">var</code> <code class="nx">data</code><code class="p">;</code>
<code class="lineno"> 5</code>   <code class="c1">// console.log('/api/oauth/token?client_id='</code>
<code class="lineno"> 6</code>   <code class="c1">//+ angelListClientId</code>
<code class="lineno"> 7</code>   <code class="c1">//+ '&amp;client_secret='</code>
<code class="lineno"> 8</code>   <code class="c1">//+ angelListClientSecret</code>
<code class="lineno"> 9</code>   <code class="c1">//+ '&amp;code='</code>
<code class="lineno">10</code>   <code class="c1">//+ req.query.code</code>
<code class="lineno">11</code>   <code class="c1">//+ '&amp;grant_type=authorization_code');</code>
<code class="lineno">12</code>   <code class="kd">var</code> <code class="nx">angelReq</code> <code class="o">=</code> <code class="nx">https</code><code class="p">.</code><code class="nx">request</code><code class="p">({</code>
<code class="lineno">13</code>       <code class="nx">host</code><code class="o">:</code> <code class="s1">'angel.co'</code><code class="p">,</code>
<code class="lineno">14</code>       <code class="nx">path</code><code class="o">:</code> <code class="s1">'/api/oauth/token?client_id='</code>
<code class="lineno">15</code>         <code class="o">+</code> <code class="nx">angelListClientId</code>
<code class="lineno">16</code>         <code class="o">+</code> <code class="s1">'&amp;client_secret='</code>
<code class="lineno">17</code>         <code class="o">+</code> <code class="nx">angelListClientSecret</code>
<code class="lineno">18</code>         <code class="o">+</code> <code class="s1">'&amp;code='</code>
<code class="lineno">19</code>         <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">code</code>
<code class="lineno">20</code>         <code class="o">+</code> <code class="s1">'&amp;grant_type=authorization_code'</code><code class="p">,</code>
<code class="lineno">21</code>       <code class="nx">port</code><code class="o">:</code> <code class="mi">443</code><code class="p">,</code>
<code class="lineno">22</code>       <code class="nx">method</code><code class="o">:</code> <code class="s1">'POST'</code><code class="p">,</code>
<code class="lineno">23</code>       <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">24</code>         <code class="s1">'content-length'</code><code class="o">:</code> <code class="mi">0</code>
<code class="lineno">25</code>       <code class="p">}</code>
<code class="lineno">26</code>     <code class="p">},</code>
<code class="lineno">27</code>     <code class="kd">function</code><code class="p">(</code><code class="nx">angelRes</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">28</code>       <code class="nx">angelRes</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">buffer</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">29</code>         <code class="nx">buf</code> <code class="o">+=</code> <code class="nx">buffer</code><code class="p">;</code>
<code class="lineno">30</code>       <code class="p">});</code>
<code class="lineno">31</code>       <code class="nx">angelRes</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'end'</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">32</code>         <code class="k">try</code> <code class="p">{</code>
<code class="lineno">33</code>           <code class="nx">data</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">buf</code><code class="p">.</code><code class="nx">toString</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">));</code>
<code class="lineno">34</code>         <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">35</code>           <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">e</code><code class="p">);</code>
<code class="lineno">36</code>         <code class="p">}</code>
<code class="lineno">37</code>         <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">data</code> <code class="o">||</code> <code class="o">!</code><code class="nx">data</code><code class="p">.</code><code class="nx">access_token</code><code class="p">)</code> <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">500</code><code class="p">);</code>
<code class="lineno">38</code>         <code class="nx">token</code> <code class="o">=</code> <code class="nx">data</code><code class="p">.</code><code class="nx">access_token</code><code class="p">;</code>
<code class="lineno">39</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">angelListAccessToken</code> <code class="o">=</code> <code class="nx">token</code><code class="p">;</code>
<code class="lineno">40</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">token</code><code class="p">)</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno">41</code>         <code class="k">else</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">500</code><code class="p">);</code>
<code class="lineno">42</code>       <code class="p">});</code>
<code class="lineno">43</code>     <code class="p">});</code>
<code class="lineno">44</code>   <code class="nx">angelReq</code><code class="p">.</code><code class="nx">end</code><code class="p">();</code>
<code class="lineno">45</code>   <code class="nx">angelReq</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">46</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="nx">e</code><code class="p">);</code>
<code class="lineno">47</code>     <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">);</code>
<code class="lineno">48</code>   <code class="p">});</code>
<code class="lineno">49</code> <code class="p">}</code>
</pre></div>

</div>

<p>Directly call AngleList API with the token from the previous middleware to get user information:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">angelListLogin</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">token</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">angelListAccessToken</code><code class="p">;</code>
<code class="lineno"> 3</code>   <code class="nx">httpsRequest</code> <code class="o">=</code> <code class="nx">https</code><code class="p">.</code><code class="nx">request</code><code class="p">({</code>
<code class="lineno"> 4</code>       <code class="nx">host</code><code class="o">:</code> <code class="s1">'api.angel.co'</code><code class="p">,</code>
<code class="lineno"> 5</code>       <code class="nx">path</code><code class="o">:</code> <code class="s1">'/1/me?access_token='</code> <code class="o">+</code> <code class="nx">token</code><code class="p">,</code>
<code class="lineno"> 6</code>       <code class="nx">port</code><code class="o">:</code> <code class="mi">443</code><code class="p">,</code>
<code class="lineno"> 7</code>       <code class="nx">method</code><code class="o">:</code> <code class="s1">'GET'</code>
<code class="lineno"> 8</code>     <code class="p">},</code>
<code class="lineno"> 9</code>     <code class="kd">function</code><code class="p">(</code><code class="nx">httpsResponse</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">10</code>       <code class="nx">httpsResponse</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">buffer</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">11</code>         <code class="nx">data</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">buffer</code><code class="p">.</code><code class="nx">toString</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">));</code>
<code class="lineno">12</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">13</code>           <code class="nx">req</code><code class="p">.</code><code class="nx">angelProfile</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>
<code class="lineno">14</code>           <code class="nx">next</code><code class="p">();</code>
<code class="lineno">15</code>         <code class="p">}</code>
<code class="lineno">16</code>       <code class="p">});</code>
<code class="lineno">17</code>     <code class="p">}</code>
<code class="lineno">18</code>   <code class="p">);</code>
<code class="lineno">19</code>   <code class="nx">httpsRequest</code><code class="p">.</code><code class="nx">end</code><code class="p">();</code>
<code class="lineno">20</code>   <code class="nx">httpsRequest</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">21</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="nx">e</code><code class="p">);</code>
<code class="lineno">22</code>   <code class="p">});</code>
<code class="lineno">23</code> <code class="p">};</code>
</pre></div>

</div>

<p>The full source code for <code>hackhall/routes/auth.js</code> files:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">https</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'https'</code><code class="p">);</code>
<code class="lineno"> 2</code>
<code class="lineno"> 3</code> <code class="kd">var</code> <code class="nx">angelListClientId</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">ANGELLIST_CLIENT_ID</code><code class="p">;</code>
<code class="lineno"> 4</code> <code class="kd">var</code> <code class="nx">angelListClientSecret</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">ANGELLIST_CLIENT_SECRET</code><code class="p">;</code>
<code class="lineno"> 5</code>
<code class="lineno"> 6</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">angelList</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 7</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'https://angel.co/api/oauth/authorize?client_id='</code> <code class="o">+</code> <code class="nx">angelListClien</code><code class="o">\</code>
<code class="lineno"> 8</code> <code class="nx">tId</code> <code class="o">+</code> <code class="s1">'&amp;scope=email&amp;response_type=code'</code><code class="p">);</code>
<code class="lineno"> 9</code> <code class="p">}</code>
<code class="lineno">10</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">angelListCallback</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">11</code>   <code class="kd">var</code> <code class="nx">token</code><code class="p">;</code>
<code class="lineno">12</code>   <code class="kd">var</code> <code class="nx">buf</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>
<code class="lineno">13</code>   <code class="kd">var</code> <code class="nx">data</code><code class="p">;</code>
<code class="lineno">14</code>   <code class="c1">// console.log('/api/oauth/token?client_id=' + angelListClientId + '&amp;client_sec\</code>
<code class="lineno">15</code> <code class="nx">ret</code><code class="o">=</code><code class="s1">' + angelListClientSecret + '</code><code class="o">&amp;</code><code class="nx">code</code><code class="o">=</code><code class="s1">' + req.query.code + '</code><code class="o">&amp;</code><code class="nx">grant_type</code><code class="o">=</code><code class="nx">authoriz</code><code class="o">\</code>
<code class="lineno">16</code> <code class="nx">ation_code</code><code class="s1">');</code>
<code class="lineno">17</code> <code class="s1">  var angelReq = https.request({</code>
<code class="lineno">18</code> <code class="s1">      host: '</code><code class="nx">angel</code><code class="p">.</code><code class="nx">co</code><code class="s1">',</code>
<code class="lineno">19</code> <code class="s1">      path: '</code><code class="o">/</code><code class="nx">api</code><code class="o">/</code><code class="nx">oauth</code><code class="o">/</code><code class="nx">token</code><code class="o">?</code><code class="nx">client_id</code><code class="o">=</code><code class="s1">' + angelListClientId + '</code><code class="o">&amp;</code><code class="nx">client_secret</code><code class="o">=</code><code class="s1">'\</code>
<code class="lineno">20</code> <code class="s1"> + angelListClientSecret + '</code><code class="o">&amp;</code><code class="nx">code</code><code class="o">=</code><code class="s1">' + req.query.code + '</code><code class="o">&amp;</code><code class="nx">grant_type</code><code class="o">=</code><code class="nx">authorization</code><code class="o">\</code>
<code class="lineno">21</code> <code class="nx">_code</code><code class="s1">',</code>
<code class="lineno">22</code> <code class="s1">      port: 443,</code>
<code class="lineno">23</code> <code class="s1">      method: '</code><code class="nx">POST</code><code class="s1">',</code>
<code class="lineno">24</code> <code class="s1">      headers: {</code>
<code class="lineno">25</code> <code class="s1">        '</code><code class="nx">content</code><code class="o">-</code><code class="nx">length</code><code class="s1">': 0</code>
<code class="lineno">26</code> <code class="s1">      }</code>
<code class="lineno">27</code> <code class="s1">    },</code>
<code class="lineno">28</code> <code class="s1">    function(angelRes) {</code>
<code class="lineno">29</code>
<code class="lineno">30</code> <code class="s1">      angelRes.on('</code><code class="nx">data</code><code class="s1">', function(buffer) {</code>
<code class="lineno">31</code> <code class="s1">        buf += buffer;</code>
<code class="lineno">32</code> <code class="s1">      });</code>
<code class="lineno">33</code> <code class="s1">      angelRes.on('</code><code class="nx">end</code><code class="s1">', function() {</code>
<code class="lineno">34</code> <code class="s1">        try {</code>
<code class="lineno">35</code> <code class="s1">          data = JSON.parse(buf.toString('</code><code class="nx">utf</code><code class="o">-</code><code class="mi">8</code><code class="s1">'));</code>
<code class="lineno">36</code> <code class="s1">        } catch (e) {</code>
<code class="lineno">37</code> <code class="s1">          if (e) return res.send(e);</code>
<code class="lineno">38</code> <code class="s1">        }</code>
<code class="lineno">39</code> <code class="s1">        if (!data || !data.access_token) return res.send(500);</code>
<code class="lineno">40</code> <code class="s1">        token = data.access_token;</code>
<code class="lineno">41</code> <code class="s1">        req.session.angelListAccessToken = token;</code>
<code class="lineno">42</code> <code class="s1">        if (token) next();</code>
<code class="lineno">43</code> <code class="s1">        else res.send(500);</code>
<code class="lineno">44</code> <code class="s1">      });</code>
<code class="lineno">45</code> <code class="s1">    });</code>
<code class="lineno">46</code> <code class="s1">  angelReq.end();</code>
<code class="lineno">47</code> <code class="s1">  angelReq.on('</code><code class="nx">error</code><code class="s1">', function(e) {</code>
<code class="lineno">48</code> <code class="s1">    console.error(e);</code>
<code class="lineno">49</code> <code class="s1">    next(e);</code>
<code class="lineno">50</code> <code class="s1">  });</code>
<code class="lineno">51</code> <code class="s1">}</code>
<code class="lineno">52</code> <code class="s1">exports.angelListLogin = function(req, res, next) {</code>
<code class="lineno">53</code> <code class="s1">  token = req.session.angelListAccessToken;</code>
<code class="lineno">54</code> <code class="s1">  httpsRequest = https.request({</code>
<code class="lineno">55</code> <code class="s1">      host: '</code><code class="nx">api</code><code class="p">.</code><code class="nx">angel</code><code class="p">.</code><code class="nx">co</code><code class="s1">',</code>
<code class="lineno">56</code> <code class="s1">      path: '</code><code class="o">/</code><code class="mi">1</code><code class="o">/</code><code class="nx">me</code><code class="o">?</code><code class="nx">access_token</code><code class="o">=</code><code class="s1">' + token,</code>
<code class="lineno">57</code> <code class="s1">      port: 443,</code>
<code class="lineno">58</code> <code class="s1">      method: '</code><code class="nx">GET</code><code class="s1">'</code>
<code class="lineno">59</code> <code class="s1">    },</code>
<code class="lineno">60</code> <code class="s1">    function(httpsResponse) {</code>
<code class="lineno">61</code> <code class="s1">      httpsResponse.on('</code><code class="nx">data</code><code class="s1">', function(buffer) {</code>
<code class="lineno">62</code> <code class="s1">        data = JSON.parse(buffer.toString('</code><code class="nx">utf</code><code class="o">-</code><code class="mi">8</code><code class="s1">'));</code>
<code class="lineno">63</code> <code class="s1">        if (data) {</code>
<code class="lineno">64</code> <code class="s1">          req.angelProfile = data;</code>
<code class="lineno">65</code> <code class="s1">          next();</code>
<code class="lineno">66</code> <code class="s1">        }</code>
<code class="lineno">67</code> <code class="s1">      });</code>
<code class="lineno">68</code> <code class="s1">    }</code>
<code class="lineno">69</code> <code class="s1">  );</code>
<code class="lineno">70</code> <code class="s1">  httpsRequest.end();</code>
<code class="lineno">71</code> <code class="s1">  httpsRequest.on('</code><code class="nx">error</code><code class="err">'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">72</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="nx">e</code><code class="p">);</code>
<code class="lineno">73</code>   <code class="p">});</code>
<code class="lineno">74</code> <code class="p">};</code>
</pre></div>

</div>

<h4 id="leanpub-auto-mainjs">
<span class="section-number">4.5.3 </span>main.js</h4>

<p>The  <code>hackhall/routes/main.js</code> file might be interesting as well.</p>

<p>The <code>checkAdmin()</code> function performs authentication for admin privileges. If the session object doesn’t carry proper flag, we call Express.js <code>next()</code> function with an error object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">checkAdmin</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">request</code><code class="p">,</code> <code class="nx">response</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">request</code><code class="p">.</code><code class="nx">session</code>
<code class="lineno"> 3</code>     <code class="o">&amp;&amp;</code> <code class="nx">request</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code>
<code class="lineno"> 4</code>     <code class="o">&amp;&amp;</code> <code class="nx">request</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code>
<code class="lineno"> 5</code>     <code class="o">&amp;&amp;</code> <code class="nx">request</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">admin</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 6</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Access ADMIN: '</code> <code class="o">+</code> <code class="nx">request</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code>
<code class="lineno"> 7</code>     <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno"> 8</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 9</code>     <code class="nx">next</code><code class="p">(</code><code class="s1">'User is not an administrator.'</code><code class="p">);</code>
<code class="lineno">10</code>   <code class="p">}</code>
<code class="lineno">11</code> <code class="p">};</code>
</pre></div>

</div>

<p>Similarly, we can check only for the user without checking for admin rights:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">checkUser</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code>
<code class="lineno">3</code>     <code class="o">&amp;&amp;</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">approved</code> <code class="o">||</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">admin</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno">4</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Access USER: '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code>
<code class="lineno">5</code>     <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno">6</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">7</code>     <code class="nx">next</code><code class="p">(</code><code class="s1">'User is not logged in.'</code><code class="p">);</code>
<code class="lineno">8</code>   <code class="p">}</code>
<code class="lineno">9</code> <code class="p">};</code>
</pre></div>

</div>

<p>Application is just an unapproved user object, and we can also check for that:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">checkApplicant</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code>
<code class="lineno">3</code>     <code class="o">&amp;&amp;</code> <code class="p">(</code><code class="o">!</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">approved</code> <code class="o">||</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">admin</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno">4</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Access USER: '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code>
<code class="lineno">5</code>     <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno">6</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">7</code>     <code class="nx">next</code><code class="p">(</code><code class="s1">'User is not logged in.'</code><code class="p">);</code>
<code class="lineno">8</code>   <code class="p">}</code>
<code class="lineno">9</code> <code class="p">};</code>
</pre></div>

</div>

<p>In the login function, we search for email and password matches in the database. On success, we store the user object in the session and proceed; otherwise the request fails:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">login</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code>
<code class="lineno"> 3</code>       <code class="nx">email</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">email</code><code class="p">,</code>
<code class="lineno"> 4</code>       <code class="nx">password</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">password</code>
<code class="lineno"> 5</code>     <code class="p">},</code>
<code class="lineno"> 6</code>     <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 7</code>       <code class="nx">safe</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 8</code>     <code class="p">},</code>
<code class="lineno"> 9</code>     <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">user</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">10</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">11</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">user</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">12</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">13</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code> <code class="o">=</code> <code class="nx">user</code><code class="p">.</code><code class="nx">_id</code><code class="p">.</code><code class="nx">toHexString</code><code class="p">();</code>
<code class="lineno">14</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code> <code class="o">=</code> <code class="nx">user</code><code class="p">;</code>
<code class="lineno">15</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">user</code><code class="p">.</code><code class="nx">admin</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">16</code>           <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">admin</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">17</code>         <code class="p">}</code>
<code class="lineno">18</code>         <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Login USER: '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code>
<code class="lineno">19</code>         <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">20</code>           <code class="nx">msg</code><code class="o">:</code> <code class="s1">'Authorized'</code>
<code class="lineno">21</code>         <code class="p">});</code>
<code class="lineno">22</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">23</code>         <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'User is not found.'</code><code class="p">));</code>
<code class="lineno">24</code>       <code class="p">}</code>
<code class="lineno">25</code>     <code class="p">});</code>
<code class="lineno">26</code> <code class="p">};</code>
</pre></div>

</div>

<p>The logging out process removes any session information:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">logout</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Logout USER: '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code>
<code class="lineno"> 3</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">destroy</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 5</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">({</code>
<code class="lineno"> 6</code>         <code class="nx">msg</code><code class="o">:</code> <code class="s1">'Logged out'</code>
<code class="lineno"> 7</code>       <code class="p">});</code>
<code class="lineno"> 8</code>     <code class="p">}</code>
<code class="lineno"> 9</code>   <code class="p">});</code>
<code class="lineno">10</code> <code class="p">};</code>
</pre></div>

</div>

<p>This route is used for both the Profile page as well as by Backbone.js for user authentication:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">profile</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">findById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">,</code> <code class="s1">'firstName lastName'</code>
<code class="lineno"> 3</code>       <code class="o">+</code> <code class="s1">'displayName headline photoUrl admin'</code>
<code class="lineno"> 4</code>       <code class="o">+</code> <code class="s1">'approved banned role angelUrl twitterUrl'</code>
<code class="lineno"> 5</code>       <code class="o">+</code> <code class="s1">'facebookUrl linkedinUrl githubUrl'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 6</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 7</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">obj</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'User is not found'</code><code class="p">));</code>
<code class="lineno"> 8</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno"> 9</code>       <code class="nx">author</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">10</code>         <code class="nx">id</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code>
<code class="lineno">11</code>         <code class="nx">name</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">displayName</code>
<code class="lineno">12</code>       <code class="p">}</code>
<code class="lineno">13</code>     <code class="p">},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">14</code>       <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">15</code>         <code class="s1">'created'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno">16</code>       <code class="p">}</code>
<code class="lineno">17</code>     <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">18</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">19</code>       <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">own</code> <code class="o">=</code> <code class="nx">list</code> <code class="o">||</code> <code class="p">[];</code>
<code class="lineno">20</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno">21</code>         <code class="nx">likes</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code>
<code class="lineno">22</code>       <code class="p">},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">23</code>         <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">24</code>           <code class="s1">'created'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno">25</code>         <code class="p">}</code>
</pre></div>

</div>

<p>This logic finds Posts and Comments made by the user:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code>       <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 3</code>         <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">likes</code> <code class="o">=</code> <code class="nx">list</code> <code class="o">||</code> <code class="p">[];</code>
<code class="lineno"> 4</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno"> 5</code>           <code class="nx">watches</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code>
<code class="lineno"> 6</code>         <code class="p">},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 7</code>           <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 8</code>             <code class="s1">'created'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno"> 9</code>           <code class="p">}</code>
<code class="lineno">10</code>         <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">11</code>           <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">12</code>           <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">watches</code> <code class="o">=</code> <code class="nx">list</code> <code class="o">||</code> <code class="p">[];</code>
<code class="lineno">13</code>           <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno">14</code>             <code class="s1">'comments.author.id'</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code>
<code class="lineno">15</code>           <code class="p">},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">16</code>             <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">17</code>               <code class="s1">'created'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno">18</code>             <code class="p">}</code>
<code class="lineno">19</code>           <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">20</code>             <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">21</code>             <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">comments</code> <code class="o">=</code> <code class="p">[];</code>
<code class="lineno">22</code>             <code class="nx">list</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">value</code><code class="p">,</code> <code class="nx">key</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">23</code>               <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">comments</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code>
<code class="lineno">24</code>                 <code class="nx">value</code><code class="p">.</code><code class="nx">comments</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code>
<code class="lineno">25</code>                   <code class="kd">function</code><code class="p">(</code><code class="nx">el</code><code class="p">,</code> <code class="nx">i</code><code class="p">,</code> <code class="nx">arr</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">26</code>                     <code class="k">return</code> <code class="p">(</code><code class="nx">el</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">toString</code><code class="p">()</code> <code class="o">==</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code>
<code class="lineno">27</code>                   <code class="p">}</code>
<code class="lineno">28</code>                 <code class="p">)</code>
<code class="lineno">29</code>               <code class="p">);</code>
<code class="lineno">30</code>             <code class="p">});</code>
<code class="lineno">31</code>             <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">32</code>           <code class="p">});</code>
<code class="lineno">33</code>         <code class="p">});</code>
<code class="lineno">34</code>       <code class="p">});</code>
<code class="lineno">35</code>     <code class="p">});</code>
<code class="lineno">36</code>   <code class="p">});</code>
<code class="lineno">37</code> <code class="p">};</code>
</pre></div>

</div>

<p>It’s important to allow users to delete their profiles:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">delProfile</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'del profile'</code><code class="p">);</code>
<code class="lineno"> 3</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code>
<code class="lineno"> 4</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">findByIdAndRemove</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="p">{},</code>
<code class="lineno"> 5</code>     <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 6</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 7</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">destroy</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 8</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 9</code>           <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code>
<code class="lineno">10</code>         <code class="p">}</code>
<code class="lineno">11</code>       <code class="p">});</code>
<code class="lineno">12</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">13</code>     <code class="p">}</code>
<code class="lineno">14</code>   <code class="p">);</code>
<code class="lineno">15</code> <code class="p">};</code>
</pre></div>

</div>

<p>The full source code of <code>hackhall/routes/main.js</code> files:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">  1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">checkAdmin</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">request</code><code class="p">,</code> <code class="nx">response</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">  2</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">request</code><code class="p">.</code><code class="nx">session</code> <code class="o">&amp;&amp;</code> <code class="nx">request</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code> <code class="o">&amp;&amp;</code> <code class="nx">request</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code> <code class="o">&amp;&amp;</code> <code class="nx">reques</code><code class="o">\</code>
<code class="lineno">  3</code> <code class="nx">t</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">admin</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">  4</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Access ADMIN: '</code> <code class="o">+</code> <code class="nx">request</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code>
<code class="lineno">  5</code>     <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno">  6</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">  7</code>     <code class="nx">next</code><code class="p">(</code><code class="s1">'User is not an administrator.'</code><code class="p">);</code>
<code class="lineno">  8</code>   <code class="p">}</code>
<code class="lineno">  9</code> <code class="p">};</code>
<code class="lineno"> 10</code>
<code class="lineno"> 11</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">checkUser</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 12</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code> <code class="o">&amp;&amp;</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="o">\</code>
<code class="lineno"> 13</code> <code class="nx">approved</code> <code class="o">||</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">admin</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno"> 14</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Access USER: '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code>
<code class="lineno"> 15</code>     <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno"> 16</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 17</code>     <code class="nx">next</code><code class="p">(</code><code class="s1">'User is not logged in.'</code><code class="p">);</code>
<code class="lineno"> 18</code>   <code class="p">}</code>
<code class="lineno"> 19</code> <code class="p">};</code>
<code class="lineno"> 20</code>
<code class="lineno"> 21</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">checkApplicant</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 22</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code> <code class="o">&amp;&amp;</code> <code class="p">(</code><code class="o">!</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="o">\</code>
<code class="lineno"> 23</code> <code class="p">.</code><code class="nx">approved</code> <code class="o">||</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">admin</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno"> 24</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Access USER: '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code>
<code class="lineno"> 25</code>     <code class="k">return</code> <code class="nx">next</code><code class="p">();</code>
<code class="lineno"> 26</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 27</code>     <code class="nx">next</code><code class="p">(</code><code class="s1">'User is not logged in.'</code><code class="p">);</code>
<code class="lineno"> 28</code>   <code class="p">}</code>
<code class="lineno"> 29</code> <code class="p">};</code>
<code class="lineno"> 30</code>
<code class="lineno"> 31</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">login</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 32</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code>
<code class="lineno"> 33</code>       <code class="nx">email</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">email</code><code class="p">,</code>
<code class="lineno"> 34</code>       <code class="nx">password</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">password</code>
<code class="lineno"> 35</code>     <code class="p">},</code>
<code class="lineno"> 36</code>     <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 37</code>       <code class="nx">safe</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 38</code>     <code class="p">},</code>
<code class="lineno"> 39</code>     <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">user</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 40</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 41</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">user</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 42</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno"> 43</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code> <code class="o">=</code> <code class="nx">user</code><code class="p">.</code><code class="nx">_id</code><code class="p">.</code><code class="nx">toHexString</code><code class="p">();</code>
<code class="lineno"> 44</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code> <code class="o">=</code> <code class="nx">user</code><code class="p">;</code>
<code class="lineno"> 45</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">user</code><code class="p">.</code><code class="nx">admin</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 46</code>           <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">admin</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno"> 47</code>         <code class="p">}</code>
<code class="lineno"> 48</code>         <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Login USER: '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code>
<code class="lineno"> 49</code>         <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 50</code>           <code class="nx">msg</code><code class="o">:</code> <code class="s1">'Authorized'</code>
<code class="lineno"> 51</code>         <code class="p">});</code>
<code class="lineno"> 52</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 53</code>         <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'User is not found.'</code><code class="p">));</code>
<code class="lineno"> 54</code>       <code class="p">}</code>
<code class="lineno"> 55</code>     <code class="p">});</code>
<code class="lineno"> 56</code> <code class="p">};</code>
<code class="lineno"> 57</code>
<code class="lineno"> 58</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">logout</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 59</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="s1">'Logout USER: '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code>
<code class="lineno"> 60</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">destroy</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 61</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 62</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">({</code>
<code class="lineno"> 63</code>         <code class="nx">msg</code><code class="o">:</code> <code class="s1">'Logged out'</code>
<code class="lineno"> 64</code>       <code class="p">});</code>
<code class="lineno"> 65</code>     <code class="p">}</code>
<code class="lineno"> 66</code>   <code class="p">});</code>
<code class="lineno"> 67</code> <code class="p">};</code>
<code class="lineno"> 68</code>
<code class="lineno"> 69</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">profile</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 70</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">findById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">,</code> <code class="s1">'firstName lastName displayName headli\</code>
<code class="lineno"> 71</code> <code class="s1">ne photoUrl admin approved banned role angelUrl twitterUrl facebookUrl linkedinUr\</code>
<code class="lineno"> 72</code> <code class="s1">l githubUrl'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 73</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 74</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">obj</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'User is not found'</code><code class="p">));</code>
<code class="lineno"> 75</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno"> 76</code>       <code class="nx">author</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 77</code>         <code class="nx">id</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code>
<code class="lineno"> 78</code>         <code class="nx">name</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">displayName</code>
<code class="lineno"> 79</code>       <code class="p">}</code>
<code class="lineno"> 80</code>     <code class="p">},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 81</code>       <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 82</code>         <code class="s1">'created'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno"> 83</code>       <code class="p">}</code>
<code class="lineno"> 84</code>     <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 85</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 86</code>       <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">own</code> <code class="o">=</code> <code class="nx">list</code> <code class="o">||</code> <code class="p">[];</code>
<code class="lineno"> 87</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno"> 88</code>         <code class="nx">likes</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code>
<code class="lineno"> 89</code>       <code class="p">},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 90</code>         <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 91</code>           <code class="s1">'created'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno"> 92</code>         <code class="p">}</code>
<code class="lineno"> 93</code>       <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 94</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 95</code>         <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">likes</code> <code class="o">=</code> <code class="nx">list</code> <code class="o">||</code> <code class="p">[];</code>
<code class="lineno"> 96</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno"> 97</code>           <code class="nx">watches</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code>
<code class="lineno"> 98</code>         <code class="p">},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 99</code>           <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">100</code>             <code class="s1">'created'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno">101</code>           <code class="p">}</code>
<code class="lineno">102</code>         <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">103</code>           <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">104</code>           <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">watches</code> <code class="o">=</code> <code class="nx">list</code> <code class="o">||</code> <code class="p">[];</code>
<code class="lineno">105</code>           <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno">106</code>             <code class="s1">'comments.author.id'</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code>
<code class="lineno">107</code>           <code class="p">},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">108</code>             <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">109</code>               <code class="s1">'created'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno">110</code>             <code class="p">}</code>
<code class="lineno">111</code>           <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">112</code>             <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">113</code>             <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">comments</code> <code class="o">=</code> <code class="p">[];</code>
<code class="lineno">114</code>             <code class="nx">list</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">value</code><code class="p">,</code> <code class="nx">key</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">115</code>               <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">comments</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">value</code><code class="p">.</code><code class="nx">comments</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">el</code><code class="p">,</code> <code class="nx">i</code><code class="p">,</code> <code class="nx">arr</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">116</code>                 <code class="k">return</code> <code class="p">(</code><code class="nx">el</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">toString</code><code class="p">()</code> <code class="o">==</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code>
<code class="lineno">117</code>               <code class="p">}));</code>
<code class="lineno">118</code>             <code class="p">});</code>
<code class="lineno">119</code>             <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">120</code>           <code class="p">});</code>
<code class="lineno">121</code>         <code class="p">});</code>
<code class="lineno">122</code>       <code class="p">});</code>
<code class="lineno">123</code>     <code class="p">});</code>
<code class="lineno">124</code>   <code class="p">});</code>
<code class="lineno">125</code> <code class="p">};</code>
<code class="lineno">126</code>
<code class="lineno">127</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">delProfile</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">128</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'del profile'</code><code class="p">);</code>
<code class="lineno">129</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code>
<code class="lineno">130</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">findByIdAndRemove</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="p">{},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">131</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">132</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">destroy</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">133</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">134</code>         <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code>
<code class="lineno">135</code>       <code class="p">}</code>
<code class="lineno">136</code>     <code class="p">});</code>
<code class="lineno">137</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">138</code>   <code class="p">});</code>
<code class="lineno">139</code> <code class="p">};</code>
</pre></div>

</div>

<h4 id="leanpub-auto-usersjs">
<span class="section-number">4.5.4 </span>users.js</h4>

<p>The full source code for <code>hackhall/routes/users.js</code> files:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">  1</code> <code class="nx">objectId</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongodb'</code><code class="p">).</code><code class="nx">ObjectID</code><code class="p">;</code>
<code class="lineno">  2</code>
<code class="lineno">  3</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">getUsers</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">  4</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">  5</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">find</code><code class="p">({},</code> <code class="s1">'firstName lastName displayName headline photoUrl admin \</code>
<code class="lineno">  6</code> <code class="s1">approved banned role angelUrl twitterUrl facebookUrl linkedinUrl githubUrl'</code><code class="p">,</code> <code class="nx">func</code><code class="o">\</code>
<code class="lineno">  7</code> <code class="nx">tion</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">  8</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">  9</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">list</code><code class="p">);</code>
<code class="lineno"> 10</code>     <code class="p">});</code>
<code class="lineno"> 11</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 12</code>     <code class="nx">next</code><code class="p">(</code><code class="s1">'User is not recognized.'</code><code class="p">)</code>
<code class="lineno"> 13</code>   <code class="p">}</code>
<code class="lineno"> 14</code> <code class="p">}</code>
<code class="lineno"> 15</code>
<code class="lineno"> 16</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">getUser</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 17</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">findById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code> <code class="s1">'firstName lastName displayName headline ph\</code>
<code class="lineno"> 18</code> <code class="s1">otoUrl admin approved banned role angelUrl twitterUrl facebookUrl linkedinUrl git\</code>
<code class="lineno"> 19</code> <code class="s1">hubUrl'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 20</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 21</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">obj</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'User is not found'</code><code class="p">));</code>
<code class="lineno"> 22</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno"> 23</code>       <code class="nx">author</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 24</code>         <code class="nx">id</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code>
<code class="lineno"> 25</code>         <code class="nx">name</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">displayName</code>
<code class="lineno"> 26</code>       <code class="p">}</code>
<code class="lineno"> 27</code>     <code class="p">},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 28</code>       <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 29</code>         <code class="s1">'created'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno"> 30</code>       <code class="p">}</code>
<code class="lineno"> 31</code>     <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 32</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 33</code>       <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">own</code> <code class="o">=</code> <code class="nx">list</code> <code class="o">||</code> <code class="p">[];</code>
<code class="lineno"> 34</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno"> 35</code>         <code class="nx">likes</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code>
<code class="lineno"> 36</code>       <code class="p">},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 37</code>         <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 38</code>           <code class="s1">'created'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno"> 39</code>         <code class="p">}</code>
<code class="lineno"> 40</code>       <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 41</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 42</code>         <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">likes</code> <code class="o">=</code> <code class="nx">list</code> <code class="o">||</code> <code class="p">[];</code>
<code class="lineno"> 43</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno"> 44</code>           <code class="nx">watches</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code>
<code class="lineno"> 45</code>         <code class="p">},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 46</code>           <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 47</code>             <code class="s1">'created'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno"> 48</code>           <code class="p">}</code>
<code class="lineno"> 49</code>         <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 50</code>           <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 51</code>           <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">watches</code> <code class="o">=</code> <code class="nx">list</code> <code class="o">||</code> <code class="p">[];</code>
<code class="lineno"> 52</code>           <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code>
<code class="lineno"> 53</code>             <code class="s1">'comments.author.id'</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code>
<code class="lineno"> 54</code>           <code class="p">},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 55</code>             <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 56</code>               <code class="s1">'created'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno"> 57</code>             <code class="p">}</code>
<code class="lineno"> 58</code>           <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 59</code>             <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 60</code>             <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">comments</code> <code class="o">=</code> <code class="p">[];</code>
<code class="lineno"> 61</code>             <code class="nx">list</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">value</code><code class="p">,</code> <code class="nx">key</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 62</code>               <code class="nx">obj</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">comments</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">value</code><code class="p">.</code><code class="nx">comments</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">el</code><code class="p">,</code> <code class="nx">i</code><code class="p">,</code> <code class="nx">arr</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 63</code>                 <code class="k">return</code> <code class="p">(</code><code class="nx">el</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">toString</code><code class="p">()</code> <code class="o">==</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code>
<code class="lineno"> 64</code>               <code class="p">}));</code>
<code class="lineno"> 65</code>             <code class="p">});</code>
<code class="lineno"> 66</code>             <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno"> 67</code>           <code class="p">});</code>
<code class="lineno"> 68</code>         <code class="p">});</code>
<code class="lineno"> 69</code>       <code class="p">});</code>
<code class="lineno"> 70</code>     <code class="p">});</code>
<code class="lineno"> 71</code>   <code class="p">});</code>
<code class="lineno"> 72</code> <code class="p">};</code>
<code class="lineno"> 73</code>
<code class="lineno"> 74</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">add</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 75</code>   <code class="kd">var</code> <code class="nx">user</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">);</code>
<code class="lineno"> 76</code>   <code class="nx">user</code><code class="p">.</code><code class="nx">save</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 77</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 78</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="nx">user</code><code class="p">);</code>
<code class="lineno"> 79</code>   <code class="p">});</code>
<code class="lineno"> 80</code> <code class="p">};</code>
<code class="lineno"> 81</code>
<code class="lineno"> 82</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">update</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 83</code>   <code class="kd">var</code> <code class="nx">obj</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">;</code>
<code class="lineno"> 84</code>   <code class="nx">obj</code><code class="p">.</code><code class="nx">updated</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">();</code>
<code class="lineno"> 85</code>   <code class="k">delete</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code><code class="p">;</code>
<code class="lineno"> 86</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">findByIdAndUpdate</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 87</code>     <code class="nx">$set</code><code class="o">:</code> <code class="nx">obj</code>
<code class="lineno"> 88</code>   <code class="p">},</code> <code class="p">{</code>
<code class="lineno"> 89</code>     <code class="k">new</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 90</code>   <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 91</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 92</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno"> 93</code>   <code class="p">});</code>
<code class="lineno"> 94</code> <code class="p">};</code>
<code class="lineno"> 95</code>
<code class="lineno"> 96</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">del</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 97</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">findByIdAndRemove</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 98</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 99</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">100</code>   <code class="p">});</code>
<code class="lineno">101</code> <code class="p">};</code>
<code class="lineno">102</code>
<code class="lineno">103</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">findOrAddUser</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">104</code>   <code class="nx">data</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">angelProfile</code><code class="p">;</code>
<code class="lineno">105</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code>
<code class="lineno">106</code>     <code class="nx">angelListId</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">id</code>
<code class="lineno">107</code>   <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">108</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'angelListLogin4'</code><code class="p">);</code>
<code class="lineno">109</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">110</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">warn</code><code class="p">(</code><code class="nx">obj</code><code class="p">);</code>
<code class="lineno">111</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">112</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">create</code><code class="p">({</code>
<code class="lineno">113</code>         <code class="nx">angelListId</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code>
<code class="lineno">114</code>         <code class="nx">angelToken</code><code class="o">:</code> <code class="nx">token</code><code class="p">,</code>
<code class="lineno">115</code>         <code class="nx">angelListProfile</code><code class="o">:</code> <code class="nx">data</code><code class="p">,</code>
<code class="lineno">116</code>         <code class="nx">email</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">email</code><code class="p">,</code>
<code class="lineno">117</code>         <code class="nx">firstName</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s1">' '</code><code class="p">)[</code><code class="mi">0</code><code class="p">],</code>
<code class="lineno">118</code>         <code class="nx">lastName</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s1">' '</code><code class="p">)[</code><code class="mi">1</code><code class="p">],</code>
<code class="lineno">119</code>         <code class="nx">displayName</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code>
<code class="lineno">120</code>         <code class="nx">headline</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">bio</code><code class="p">,</code>
<code class="lineno">121</code>         <code class="nx">photoUrl</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">image</code><code class="p">,</code>
<code class="lineno">122</code>         <code class="nx">angelUrl</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">angellist_url</code><code class="p">,</code>
<code class="lineno">123</code>         <code class="nx">twitterUrl</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">twitter_url</code><code class="p">,</code>
<code class="lineno">124</code>         <code class="nx">facebookUrl</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">facebook_url</code><code class="p">,</code>
<code class="lineno">125</code>         <code class="nx">linkedinUrl</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">linkedin_url</code><code class="p">,</code>
<code class="lineno">126</code>         <code class="nx">githubUrl</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">github_url</code>
<code class="lineno">127</code>       <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code> <code class="c1">//remember the scope of variables!</code>
<code class="lineno">128</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">129</code>         <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">obj</code><code class="p">);</code>
<code class="lineno">130</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">131</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code><code class="p">;</code>
<code class="lineno">132</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">;</code>
<code class="lineno">133</code>         <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">admin</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code> <code class="c1">//assing regular user role by default         \</code>
<code class="lineno">134</code>
<code class="lineno">135</code>         <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/#application'</code><code class="p">);</code>
<code class="lineno">136</code>         <code class="c1">// }</code>
<code class="lineno">137</code>       <code class="p">});</code>
<code class="lineno">138</code>     <code class="p">}</code> <code class="k">else</code> <code class="p">{</code> <code class="c1">//user is in the database</code>
<code class="lineno">139</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">140</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">_id</code><code class="p">;</code>
<code class="lineno">141</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">;</code>
<code class="lineno">142</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">admin</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">admin</code><code class="p">;</code> <code class="c1">//false; //assing regular user role by defau\</code>
<code class="lineno">143</code> <code class="nx">lt</code>
<code class="lineno">144</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">approved</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">145</code>         <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/#posts'</code><code class="p">);</code>
<code class="lineno">146</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">147</code>         <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/#application'</code><code class="p">);</code>
<code class="lineno">148</code>       <code class="p">}</code>
<code class="lineno">149</code>     <code class="p">}</code>
<code class="lineno">150</code>   <code class="p">})</code>
<code class="lineno">151</code> <code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-applicationsjs">
<span class="section-number">4.5.5 </span>applications.js</h4>

<p>In the current version, submitting and approving an application won’t trigger an email notification. Therefore, users have to comeback to the website to check their status.</p>

<p>Merely add a user object (with approved=false by default) to the database:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">add</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">create</code><code class="p">({</code>
<code class="lineno"> 3</code>     <code class="nx">firstName</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">firstName</code><code class="p">,</code>
<code class="lineno"> 4</code>     <code class="nx">lastName</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">lastName</code><code class="p">,</code>
<code class="lineno"> 5</code>     <code class="nx">displayName</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">displayName</code><code class="p">,</code>
<code class="lineno"> 6</code>     <code class="nx">headline</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">headline</code><code class="p">,</code>
<code class="lineno"> 7</code>     <code class="nx">photoUrl</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">photoUrl</code><code class="p">,</code>
<code class="lineno"> 8</code>     <code class="nx">password</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">password</code><code class="p">,</code>
<code class="lineno"> 9</code>     <code class="nx">email</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">email</code><code class="p">,</code>
<code class="lineno">10</code>     <code class="nx">angelList</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">11</code>       <code class="nx">blah</code><code class="o">:</code> <code class="s1">'blah'</code>
<code class="lineno">12</code>     <code class="p">},</code>
<code class="lineno">13</code>     <code class="nx">angelUrl</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">angelUrl</code><code class="p">,</code>
<code class="lineno">14</code>     <code class="nx">twitterUrl</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">twitterUrl</code><code class="p">,</code>
<code class="lineno">15</code>     <code class="nx">facebookUrl</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">facebookUrl</code><code class="p">,</code>
<code class="lineno">16</code>     <code class="nx">linkedinUrl</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">linkedinUrl</code><code class="p">,</code>
<code class="lineno">17</code>     <code class="nx">githubUrl</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">githubUrl</code>
<code class="lineno">18</code>   <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">19</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">20</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">obj</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="s1">'Cannot create.'</code><code class="p">)</code>
<code class="lineno">21</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">22</code>   <code class="p">})</code>
<code class="lineno">23</code> <code class="p">};</code>
</pre></div>

</div>

<p>Let the users update information in their applications:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">update</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">{};</code>
<code class="lineno"> 3</code>   <code class="nb">Object</code><code class="p">.</code><code class="nx">keys</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">).</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">k</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">[</code><code class="nx">k</code><code class="p">])</code> <code class="p">{</code>
<code class="lineno"> 5</code>       <code class="nx">data</code><code class="p">[</code><code class="nx">k</code><code class="p">]</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">[</code><code class="nx">k</code><code class="p">];</code>
<code class="lineno"> 6</code>     <code class="p">}</code>
<code class="lineno"> 7</code>   <code class="p">});</code>
<code class="lineno"> 8</code>   <code class="k">delete</code> <code class="nx">data</code><code class="p">.</code><code class="nx">_id</code><code class="p">;</code>
<code class="lineno"> 9</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">findByIdAndUpdate</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">10</code>     <code class="nx">$set</code><code class="o">:</code> <code class="nx">data</code>
<code class="lineno">11</code>   <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">12</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">13</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">obj</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="s1">'Cannot save.'</code><code class="p">)</code>
<code class="lineno">14</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">15</code>   <code class="p">});</code>
<code class="lineno">16</code> <code class="p">};</code>
</pre></div>

</div>

<p>Select a particular object with the <code>get()</code> function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">get</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">User</code><code class="p">.</code><code class="nx">findById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code>
<code class="lineno"> 3</code>     <code class="s1">'firstName lastName photoUrl headline displayName'</code>
<code class="lineno"> 4</code>       <code class="o">+</code> <code class="s1">'angelUrl facebookUrl twitterUrl linkedinUrl'</code>
<code class="lineno"> 5</code>       <code class="o">+</code> <code class="s1">'githubUrl'</code><code class="p">,</code> <code class="p">{},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 6</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 7</code>       <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">obj</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="s1">'cannot find'</code><code class="p">);</code>
<code class="lineno"> 8</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno"> 9</code>     <code class="p">})</code>
<code class="lineno">10</code> <code class="p">};</code>
</pre></div>

</div>

<p>The full source code of <code>hackhall/routes/applications.js</code> files:</p>

<p>&lt;&lt;(hackhall/routes/applications.js)</p>

<h4 id="leanpub-auto-postsjs">
<span class="section-number">4.5.6 </span>posts.js</h4>

<p>The last routes module that we bisect is <code>hackhall/routes/posts.js</code>. It takes care of adding, editing and removing posts, as well as commenting, watching and liking.</p>

<p>We use object ID for conversion from HEX strings to proper objects:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">objectId</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongodb'</code><code class="p">).</code><code class="nx">ObjectID</code><code class="p">;</code>
</pre></div>

</div>

<p>The coloring is nice for logging but of course optional. We accomplish it with escape sequences:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">red</code><code class="p">,</code> <code class="nx">blue</code><code class="p">,</code> <code class="nx">reset</code><code class="p">;</code>
<code class="lineno">2</code> <code class="nx">red</code>   <code class="o">=</code> <code class="s1">'\u001b[31m'</code><code class="p">;</code>
<code class="lineno">3</code> <code class="nx">blue</code>  <code class="o">=</code> <code class="s1">'\u001b[34m'</code><code class="p">;</code>
<code class="lineno">4</code> <code class="nx">reset</code> <code class="o">=</code> <code class="s1">'\u001b[0m'</code><code class="p">;</code>
<code class="lineno">5</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">red</code> <code class="o">+</code> <code class="s1">'This is red'</code> <code class="o">+</code> <code class="nx">reset</code> <code class="o">+</code> <code class="s1">' while '</code> <code class="o">+</code> <code class="nx">blue</code> <code class="o">+</code> <code class="s1">' this is blue'</code> <code class="o">+</code> <code class="nx">re</code><code class="o">\</code>
<code class="lineno">6</code> <code class="nx">set</code><code class="p">);</code>
</pre></div>

</div>

<p>The default values for the pagination of posts:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">LIMIT</code> <code class="o">=</code> <code class="mi">10</code><code class="p">;</code>
<code class="lineno">2</code> <code class="kd">var</code> <code class="nx">SKIP</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
</pre></div>

</div>

<p>The <code>add()</code> function handles creation of new posts:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">add</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">create</code><code class="p">({</code>
<code class="lineno"> 4</code>       <code class="nx">title</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">title</code><code class="p">,</code>
<code class="lineno"> 5</code>       <code class="nx">text</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">text</code> <code class="o">||</code> <code class="kc">null</code><code class="p">,</code>
<code class="lineno"> 6</code>       <code class="nx">url</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">url</code> <code class="o">||</code> <code class="kc">null</code><code class="p">,</code>
<code class="lineno"> 7</code>       <code class="nx">author</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 8</code>         <code class="nx">id</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code>
<code class="lineno"> 9</code>         <code class="nx">name</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">displayName</code>
<code class="lineno">10</code>       <code class="p">}</code>
<code class="lineno">11</code>     <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">docs</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">12</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">13</code>         <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">14</code>         <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">15</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">16</code>         <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">docs</code><code class="p">);</code>
<code class="lineno">17</code>       <code class="p">}</code>
<code class="lineno">18</code>
<code class="lineno">19</code>     <code class="p">});</code>
<code class="lineno">20</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">21</code>     <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'No data'</code><code class="p">));</code>
<code class="lineno">22</code>   <code class="p">}</code>
<code class="lineno">23</code> <code class="p">};</code>
</pre></div>

</div>

<p>To retrieve the list of posts:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">getPosts</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="kd">var</code> <code class="nx">limit</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">limit</code> <code class="o">||</code> <code class="nx">LIMIT</code><code class="p">;</code>
<code class="lineno"> 3</code>   <code class="kd">var</code> <code class="nx">skip</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">skip</code> <code class="o">||</code> <code class="nx">SKIP</code><code class="p">;</code>
<code class="lineno"> 4</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 5</code>     <code class="nx">limit</code><code class="o">:</code> <code class="nx">limit</code><code class="p">,</code>
<code class="lineno"> 6</code>     <code class="nx">skip</code><code class="o">:</code> <code class="nx">skip</code><code class="p">,</code>
<code class="lineno"> 7</code>     <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 8</code>       <code class="s1">'_id'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno"> 9</code>     <code class="p">}</code>
<code class="lineno">10</code>   <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">11</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">obj</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="s1">'There are not posts.'</code><code class="p">);</code>
<code class="lineno">12</code>     <code class="nx">obj</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">item</code><code class="p">,</code> <code class="nx">i</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">13</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">admin</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">14</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">admin</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">15</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">16</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">admin</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno">17</code>       <code class="p">}</code>
<code class="lineno">18</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">item</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code> <code class="o">==</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">19</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">own</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">20</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">21</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">own</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno">22</code>       <code class="p">}</code>
<code class="lineno">23</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">item</code><code class="p">.</code><code class="nx">likes</code>
<code class="lineno">24</code>         <code class="o">&amp;&amp;</code> <code class="nx">item</code><code class="p">.</code><code class="nx">likes</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">)</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">25</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">like</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">26</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">27</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">like</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno">28</code>       <code class="p">}</code>
<code class="lineno">29</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">item</code><code class="p">.</code><code class="nx">watches</code>
<code class="lineno">30</code>         <code class="o">&amp;&amp;</code> <code class="nx">item</code><code class="p">.</code><code class="nx">watches</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">)</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">31</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">watch</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">32</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">33</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">watch</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno">34</code>       <code class="p">}</code>
<code class="lineno">35</code>     <code class="p">});</code>
<code class="lineno">36</code>     <code class="kd">var</code> <code class="nx">body</code> <code class="o">=</code> <code class="p">{};</code>
<code class="lineno">37</code>     <code class="nx">body</code><code class="p">.</code><code class="nx">limit</code> <code class="o">=</code> <code class="nx">limit</code><code class="p">;</code>
<code class="lineno">38</code>     <code class="nx">body</code><code class="p">.</code><code class="nx">skip</code> <code class="o">=</code> <code class="nx">skip</code><code class="p">;</code>
<code class="lineno">39</code>     <code class="nx">body</code><code class="p">.</code><code class="nx">posts</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">;</code>
<code class="lineno">40</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">count</code><code class="p">({},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">total</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">41</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">42</code>       <code class="nx">body</code><code class="p">.</code><code class="nx">total</code> <code class="o">=</code> <code class="nx">total</code><code class="p">;</code>
<code class="lineno">43</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">body</code><code class="p">);</code>
<code class="lineno">44</code>     <code class="p">});</code>
<code class="lineno">45</code>   <code class="p">});</code>
<code class="lineno">46</code> <code class="p">};</code>
</pre></div>

</div>

<p>For the individual post page, we need the <code>getPost()</code> method:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">getPost</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">findById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 4</code>       <code class="nx">title</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 5</code>       <code class="nx">text</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 6</code>       <code class="nx">url</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 7</code>       <code class="nx">author</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 8</code>       <code class="nx">comments</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 9</code>       <code class="nx">watches</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">10</code>       <code class="nx">likes</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">11</code>     <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">12</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">13</code>       <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">14</code>         <code class="nx">next</code><code class="p">(</code><code class="s1">'Nothing is found.'</code><code class="p">);</code>
<code class="lineno">15</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">16</code>         <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">17</code>       <code class="p">}</code>
<code class="lineno">18</code>     <code class="p">});</code>
<code class="lineno">19</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">20</code>     <code class="nx">next</code><code class="p">(</code><code class="s1">'No post id'</code><code class="p">);</code>
<code class="lineno">21</code>   <code class="p">}</code>
<code class="lineno">22</code> <code class="p">};</code>
</pre></div>

</div>

<p>The <code>del()</code> function removes specific posts from the database. The <code>findById()</code> and <code>remove()</code> methods from Mongoose are used in this snippet. However, the same thing can be accomplished with just <code>remove()</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">del</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">findById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 4</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">admin</code> <code class="o">||</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code> <code class="o">===</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 5</code>       <code class="nx">obj</code><code class="p">.</code><code class="nx">remove</code><code class="p">();</code>
<code class="lineno"> 6</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno"> 7</code>     <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 8</code>       <code class="nx">next</code><code class="p">(</code><code class="s1">'User is not authorized to delete post.'</code><code class="p">);</code>
<code class="lineno"> 9</code>     <code class="p">}</code>
<code class="lineno">10</code>   <code class="p">})</code>
<code class="lineno">11</code> <code class="p">};</code>
</pre></div>

</div>

<p>To like the post, we update the post item by prepending <code>post.likes</code> array with the ID of the user:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">function</code> <code class="nx">likePost</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">findByIdAndUpdate</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="nx">$push</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 4</code>       <code class="nx">likes</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code>
<code class="lineno"> 5</code>     <code class="p">}</code>
<code class="lineno"> 6</code>   <code class="p">},</code> <code class="p">{},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 7</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 8</code>       <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 9</code>     <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">10</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">11</code>     <code class="p">}</code>
<code class="lineno">12</code>   <code class="p">});</code>
<code class="lineno">13</code> <code class="p">};</code>
</pre></div>

</div>

<p>Likewise, when a user performs the watch action, the system adds a new ID to the <code>post.watches</code> array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">function</code> <code class="nx">watchPost</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">findByIdAndUpdate</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="nx">$push</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 4</code>       <code class="nx">watches</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code>
<code class="lineno"> 5</code>     <code class="p">}</code>
<code class="lineno"> 6</code>   <code class="p">},</code> <code class="p">{},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 7</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 8</code>     <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 9</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">10</code>     <code class="p">}</code>
<code class="lineno">11</code>   <code class="p">});</code>
<code class="lineno">12</code> <code class="p">};</code>
</pre></div>

</div>

<p>The <code>updatePost()</code> is what calls like or watch functions based on the action flag sent with request. In addition, the <code>updatePost()</code> processes the changes to the post and comments:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">updatePost</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="kd">var</code> <code class="nx">anyAction</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno"> 3</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">action</code> <code class="o">==</code> <code class="s1">'like'</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 5</code>       <code class="nx">anyAction</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno"> 6</code>       <code class="nx">likePost</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">);</code>
<code class="lineno"> 7</code>     <code class="p">}</code>
<code class="lineno"> 8</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">action</code> <code class="o">==</code> <code class="s1">'watch'</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 9</code>       <code class="nx">anyAction</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">10</code>       <code class="nx">watchPost</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">);</code>
<code class="lineno">11</code>     <code class="p">}</code>
<code class="lineno">12</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">action</code> <code class="o">==</code> <code class="s1">'comment'</code>
<code class="lineno">13</code>       <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">comment</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">14</code>       <code class="nx">anyAction</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">15</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">findByIdAndUpdate</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">16</code>         <code class="nx">$push</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">17</code>           <code class="nx">comments</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">18</code>             <code class="nx">author</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">19</code>               <code class="nx">id</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">,</code>
<code class="lineno">20</code>               <code class="nx">name</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">displayName</code>
<code class="lineno">21</code>             <code class="p">},</code>
<code class="lineno">22</code>             <code class="nx">text</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">comment</code>
<code class="lineno">23</code>           <code class="p">}</code>
<code class="lineno">24</code>         <code class="p">}</code>
<code class="lineno">25</code>       <code class="p">},</code> <code class="p">{</code>
<code class="lineno">26</code>         <code class="nx">safe</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">27</code>         <code class="k">new</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">28</code>       <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">29</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">err</code><code class="p">;</code>
<code class="lineno">30</code>         <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">31</code>       <code class="p">});</code>
<code class="lineno">32</code>     <code class="p">}</code>
<code class="lineno">33</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code>
<code class="lineno">34</code>       <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">action</code> <code class="o">!=</code> <code class="s1">'comment'</code> <code class="o">&amp;&amp;</code>
<code class="lineno">35</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">action</code> <code class="o">!=</code> <code class="s1">'watch'</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code> <code class="o">!=</code> <code class="s1">'like'</code> <code class="o">&amp;&amp;</code>
<code class="lineno">36</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code> <code class="o">&amp;&amp;</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code> <code class="o">==</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">_id</code>
<code class="lineno">37</code>       <code class="o">||</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">admin</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno">38</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">findById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">doc</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">39</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">40</code>         <code class="nx">doc</code><code class="p">.</code><code class="nx">title</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">title</code><code class="p">;</code>
<code class="lineno">41</code>         <code class="nx">doc</code><code class="p">.</code><code class="nx">text</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">text</code> <code class="o">||</code> <code class="kc">null</code><code class="p">;</code>
<code class="lineno">42</code>         <code class="nx">doc</code><code class="p">.</code><code class="nx">url</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">url</code> <code class="o">||</code> <code class="kc">null</code><code class="p">;</code>
<code class="lineno">43</code>         <code class="nx">doc</code><code class="p">.</code><code class="nx">save</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">44</code>           <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">);</code>
<code class="lineno">45</code>           <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">d</code><code class="p">);</code>
<code class="lineno">46</code>         <code class="p">});</code>
<code class="lineno">47</code>       <code class="p">})</code>
<code class="lineno">48</code>     <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">49</code>       <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">anyAction</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="s1">'Something went wrong.'</code><code class="p">);</code>
<code class="lineno">50</code>     <code class="p">}</code>
<code class="lineno">51</code>
<code class="lineno">52</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">53</code>     <code class="nx">next</code><code class="p">(</code><code class="s1">'No post ID.'</code><code class="p">);</code>
<code class="lineno">54</code>   <code class="p">}</code>
<code class="lineno">55</code> <code class="p">};</code>
</pre></div>

</div>

<p>The full source code for the <code>hackhall/routes/posts.js</code> file:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">  1</code> <code class="nx">objectId</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongodb'</code><code class="p">).</code><code class="nx">ObjectID</code><code class="p">;</code>
<code class="lineno">  2</code> <code class="kd">var</code> <code class="nx">red</code><code class="p">,</code> <code class="nx">blue</code><code class="p">,</code> <code class="nx">reset</code><code class="p">;</code>
<code class="lineno">  3</code> <code class="nx">red</code> <code class="o">=</code> <code class="s1">'\u001b[31m'</code><code class="p">;</code>
<code class="lineno">  4</code> <code class="nx">blue</code> <code class="o">=</code> <code class="s1">'\u001b[34m'</code><code class="p">;</code>
<code class="lineno">  5</code> <code class="nx">reset</code> <code class="o">=</code> <code class="s1">'\u001b[0m'</code><code class="p">;</code>
<code class="lineno">  6</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">red</code> <code class="o">+</code> <code class="s1">'This is red'</code> <code class="o">+</code> <code class="nx">reset</code> <code class="o">+</code> <code class="s1">' while '</code> <code class="o">+</code> <code class="nx">blue</code> <code class="o">+</code> <code class="s1">' this is blue'</code> <code class="o">+</code> <code class="nx">re</code><code class="o">\</code>
<code class="lineno">  7</code> <code class="nx">set</code><code class="p">);</code>
<code class="lineno">  8</code>
<code class="lineno">  9</code> <code class="kd">var</code> <code class="nx">LIMIT</code> <code class="o">=</code> <code class="mi">10</code><code class="p">;</code>
<code class="lineno"> 10</code> <code class="kd">var</code> <code class="nx">SKIP</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="lineno"> 11</code>
<code class="lineno"> 12</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">add</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 13</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 14</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">create</code><code class="p">({</code>
<code class="lineno"> 15</code>       <code class="nx">title</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">title</code><code class="p">,</code>
<code class="lineno"> 16</code>       <code class="nx">text</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">text</code> <code class="o">||</code> <code class="kc">null</code><code class="p">,</code>
<code class="lineno"> 17</code>       <code class="nx">url</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">url</code> <code class="o">||</code> <code class="kc">null</code><code class="p">,</code>
<code class="lineno"> 18</code>       <code class="nx">author</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 19</code>         <code class="nx">id</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code>
<code class="lineno"> 20</code>         <code class="nx">name</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">displayName</code>
<code class="lineno"> 21</code>       <code class="p">}</code>
<code class="lineno"> 22</code>     <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">docs</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 23</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 24</code>         <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 25</code>         <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 26</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 27</code>         <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">docs</code><code class="p">);</code>
<code class="lineno"> 28</code>       <code class="p">}</code>
<code class="lineno"> 29</code>
<code class="lineno"> 30</code>     <code class="p">});</code>
<code class="lineno"> 31</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 32</code>     <code class="nx">next</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'No data'</code><code class="p">));</code>
<code class="lineno"> 33</code>   <code class="p">}</code>
<code class="lineno"> 34</code> <code class="p">};</code>
<code class="lineno"> 35</code>
<code class="lineno"> 36</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">getPosts</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 37</code>   <code class="kd">var</code> <code class="nx">limit</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">limit</code> <code class="o">||</code> <code class="nx">LIMIT</code><code class="p">;</code>
<code class="lineno"> 38</code>   <code class="kd">var</code> <code class="nx">skip</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">skip</code> <code class="o">||</code> <code class="nx">SKIP</code><code class="p">;</code>
<code class="lineno"> 39</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">find</code><code class="p">({},</code> <code class="kc">null</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 40</code>     <code class="nx">limit</code><code class="o">:</code> <code class="nx">limit</code><code class="p">,</code>
<code class="lineno"> 41</code>     <code class="nx">skip</code><code class="o">:</code> <code class="nx">skip</code><code class="p">,</code>
<code class="lineno"> 42</code>     <code class="nx">sort</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 43</code>       <code class="s1">'_id'</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
<code class="lineno"> 44</code>     <code class="p">}</code>
<code class="lineno"> 45</code>   <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 46</code>     <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">obj</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="s1">'There are not posts.'</code><code class="p">);</code>
<code class="lineno"> 47</code>     <code class="nx">obj</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">item</code><code class="p">,</code> <code class="nx">i</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 48</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">admin</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 49</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">admin</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno"> 50</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 51</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">admin</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno"> 52</code>       <code class="p">}</code>
<code class="lineno"> 53</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">item</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code> <code class="o">==</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 54</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">own</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno"> 55</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 56</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">own</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno"> 57</code>       <code class="p">}</code>
<code class="lineno"> 58</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">item</code><code class="p">.</code><code class="nx">likes</code> <code class="o">&amp;&amp;</code> <code class="nx">item</code><code class="p">.</code><code class="nx">likes</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">)</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 59</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">like</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno"> 60</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 61</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">like</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno"> 62</code>       <code class="p">}</code>
<code class="lineno"> 63</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">item</code><code class="p">.</code><code class="nx">watches</code> <code class="o">&amp;&amp;</code> <code class="nx">item</code><code class="p">.</code><code class="nx">watches</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">)</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 64</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">watch</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno"> 65</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 66</code>         <code class="nx">item</code><code class="p">.</code><code class="nx">watch</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno"> 67</code>       <code class="p">}</code>
<code class="lineno"> 68</code>     <code class="p">});</code>
<code class="lineno"> 69</code>     <code class="kd">var</code> <code class="nx">body</code> <code class="o">=</code> <code class="p">{};</code>
<code class="lineno"> 70</code>     <code class="nx">body</code><code class="p">.</code><code class="nx">limit</code> <code class="o">=</code> <code class="nx">limit</code><code class="p">;</code>
<code class="lineno"> 71</code>     <code class="nx">body</code><code class="p">.</code><code class="nx">skip</code> <code class="o">=</code> <code class="nx">skip</code><code class="p">;</code>
<code class="lineno"> 72</code>     <code class="nx">body</code><code class="p">.</code><code class="nx">posts</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">;</code>
<code class="lineno"> 73</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">count</code><code class="p">({},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">total</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 74</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 75</code>       <code class="nx">body</code><code class="p">.</code><code class="nx">total</code> <code class="o">=</code> <code class="nx">total</code><code class="p">;</code>
<code class="lineno"> 76</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">body</code><code class="p">);</code>
<code class="lineno"> 77</code>     <code class="p">});</code>
<code class="lineno"> 78</code>   <code class="p">});</code>
<code class="lineno"> 79</code> <code class="p">};</code>
<code class="lineno"> 80</code>
<code class="lineno"> 81</code>
<code class="lineno"> 82</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">getPost</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 83</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 84</code>     <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">findById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 85</code>       <code class="nx">title</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 86</code>       <code class="nx">text</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 87</code>       <code class="nx">url</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 88</code>       <code class="nx">author</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 89</code>       <code class="nx">comments</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 90</code>       <code class="nx">watches</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 91</code>       <code class="nx">likes</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 92</code>     <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 93</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno"> 94</code>       <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 95</code>         <code class="nx">next</code><code class="p">(</code><code class="s1">'Nothing is found.'</code><code class="p">);</code>
<code class="lineno"> 96</code>       <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 97</code>         <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno"> 98</code>       <code class="p">}</code>
<code class="lineno"> 99</code>     <code class="p">});</code>
<code class="lineno">100</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">101</code>     <code class="nx">next</code><code class="p">(</code><code class="s1">'No post id'</code><code class="p">);</code>
<code class="lineno">102</code>   <code class="p">}</code>
<code class="lineno">103</code> <code class="p">};</code>
<code class="lineno">104</code>
<code class="lineno">105</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">del</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">106</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">findById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">107</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">108</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">admin</code> <code class="o">||</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code> <code class="o">===</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">109</code>       <code class="nx">obj</code><code class="p">.</code><code class="nx">remove</code><code class="p">();</code>
<code class="lineno">110</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">111</code>     <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">112</code>       <code class="nx">next</code><code class="p">(</code><code class="s1">'User is not authorized to delete post.'</code><code class="p">);</code>
<code class="lineno">113</code>     <code class="p">}</code>
<code class="lineno">114</code>   <code class="p">})</code>
<code class="lineno">115</code> <code class="p">};</code>
<code class="lineno">116</code>
<code class="lineno">117</code> <code class="kd">function</code> <code class="nx">likePost</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">118</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">findByIdAndUpdate</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">119</code>     <code class="nx">$push</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">120</code>       <code class="nx">likes</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code>
<code class="lineno">121</code>     <code class="p">}</code>
<code class="lineno">122</code>   <code class="p">},</code> <code class="p">{},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">123</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">124</code>       <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">125</code>     <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">126</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">127</code>     <code class="p">}</code>
<code class="lineno">128</code>   <code class="p">});</code>
<code class="lineno">129</code> <code class="p">};</code>
<code class="lineno">130</code>
<code class="lineno">131</code> <code class="kd">function</code> <code class="nx">watchPost</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">132</code>   <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">findByIdAndUpdate</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">133</code>     <code class="nx">$push</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">134</code>       <code class="nx">watches</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code>
<code class="lineno">135</code>     <code class="p">}</code>
<code class="lineno">136</code>   <code class="p">},</code> <code class="p">{},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">137</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">138</code>     <code class="k">else</code> <code class="p">{</code>
<code class="lineno">139</code>       <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">140</code>     <code class="p">}</code>
<code class="lineno">141</code>   <code class="p">});</code>
<code class="lineno">142</code> <code class="p">};</code>
<code class="lineno">143</code>
<code class="lineno">144</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">updatePost</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">145</code>   <code class="kd">var</code> <code class="nx">anyAction</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno">146</code>   <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">147</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">action</code> <code class="o">==</code> <code class="s1">'like'</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">148</code>       <code class="nx">anyAction</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">149</code>       <code class="nx">likePost</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">);</code>
<code class="lineno">150</code>     <code class="p">}</code>
<code class="lineno">151</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">action</code> <code class="o">==</code> <code class="s1">'watch'</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">152</code>       <code class="nx">anyAction</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">153</code>       <code class="nx">watchPost</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">);</code>
<code class="lineno">154</code>     <code class="p">}</code>
<code class="lineno">155</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">action</code> <code class="o">==</code> <code class="s1">'comment'</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">comment</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">param</code><code class="o">\</code>
<code class="lineno">156</code> <code class="nx">s</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">157</code>       <code class="nx">anyAction</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">158</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">findByIdAndUpdate</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">159</code>         <code class="nx">$push</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">160</code>           <code class="nx">comments</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">161</code>             <code class="nx">author</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">162</code>               <code class="nx">id</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code><code class="p">,</code>
<code class="lineno">163</code>               <code class="nx">name</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">displayName</code>
<code class="lineno">164</code>             <code class="p">},</code>
<code class="lineno">165</code>             <code class="nx">text</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">comment</code>
<code class="lineno">166</code>           <code class="p">}</code>
<code class="lineno">167</code>         <code class="p">}</code>
<code class="lineno">168</code>       <code class="p">},</code> <code class="p">{</code>
<code class="lineno">169</code>         <code class="nx">safe</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">170</code>         <code class="k">new</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">171</code>       <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">172</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">err</code><code class="p">;</code>
<code class="lineno">173</code>         <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
<code class="lineno">174</code>       <code class="p">});</code>
<code class="lineno">175</code>     <code class="p">}</code>
<code class="lineno">176</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">auth</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userId</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">action</code> <code class="o">!=</code> <code class="o">\</code>
<code class="lineno">177</code> <code class="s1">'comment'</code> <code class="o">&amp;&amp;</code>
<code class="lineno">178</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">action</code> <code class="o">!=</code> <code class="s1">'watch'</code> <code class="o">&amp;&amp;</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code> <code class="o">!=</code> <code class="s1">'like'</code> <code class="o">&amp;&amp;</code>
<code class="lineno">179</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code> <code class="o">&amp;&amp;</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code> <code class="o">==</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">_id</code> <code class="o">||</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="o">\</code>
<code class="lineno">180</code> <code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">admin</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno">181</code>       <code class="nx">req</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Post</code><code class="p">.</code><code class="nx">findById</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">doc</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">182</code>         <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
<code class="lineno">183</code>         <code class="nx">doc</code><code class="p">.</code><code class="nx">title</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">title</code><code class="p">;</code>
<code class="lineno">184</code>         <code class="nx">doc</code><code class="p">.</code><code class="nx">text</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">text</code> <code class="o">||</code> <code class="kc">null</code><code class="p">;</code>
<code class="lineno">185</code>         <code class="nx">doc</code><code class="p">.</code><code class="nx">url</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">url</code> <code class="o">||</code> <code class="kc">null</code><code class="p">;</code>
<code class="lineno">186</code>         <code class="nx">doc</code><code class="p">.</code><code class="nx">save</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">187</code>           <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="nx">e</code><code class="p">);</code>
<code class="lineno">188</code>           <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="nx">d</code><code class="p">);</code>
<code class="lineno">189</code>         <code class="p">});</code>
<code class="lineno">190</code>       <code class="p">})</code>
<code class="lineno">191</code>     <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">192</code>       <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">anyAction</code><code class="p">)</code> <code class="nx">next</code><code class="p">(</code><code class="s1">'Something went wrong.'</code><code class="p">);</code>
<code class="lineno">193</code>     <code class="p">}</code>
<code class="lineno">194</code>
<code class="lineno">195</code>   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">196</code>     <code class="nx">next</code><code class="p">(</code><code class="s1">'No post ID.'</code><code class="p">);</code>
<code class="lineno">197</code>   <code class="p">}</code>
<code class="lineno">198</code> <code class="p">};</code>
</pre></div>

</div>

<h3 id="leanpub-auto-mogoose-models">
<span class="section-number">4.6 </span>Mogoose Models</h3>

<p>Ideally, in a big application, we would break down each model into a separate file. Right now in the HackHall app, we have them all in <code>hackhall/models/index.js</code>.</p>

<p>As always, our dependencies look better at the top:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">mongoose</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongoose'</code><code class="p">);</code>
<code class="lineno">2</code> <code class="kd">var</code> <code class="nx">Schema</code> <code class="o">=</code> <code class="nx">mongoose</code><code class="p">.</code><code class="nx">Schema</code><code class="p">;</code>
<code class="lineno">3</code> <code class="kd">var</code> <code class="nx">roles</code> <code class="o">=</code> <code class="s1">'user staff mentor investor founder'</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s1">' '</code><code class="p">);</code>
</pre></div>

</div>

<p>The Post model represents post with its likes, comments and watches.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">Post</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Schema</code> <code class="p">({</code>
<code class="lineno"> 2</code>   <code class="nx">title</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 4</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 5</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 6</code>     <code class="c1">// match: /^([[:alpha:][:space:][:punct:]]{1,100})$/</code>
<code class="lineno"> 7</code>     <code class="nx">match</code><code class="o">:</code> <code class="sr">/^([\w ,.!?]{1,100})$/</code>
<code class="lineno"> 8</code>   <code class="p">},</code>
<code class="lineno"> 9</code>   <code class="nx">url</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">10</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">11</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">12</code>     <code class="nx">max</code><code class="o">:</code> <code class="mi">1000</code>
<code class="lineno">13</code>   <code class="p">},</code>
<code class="lineno">14</code>   <code class="nx">text</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">15</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">16</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">17</code>     <code class="nx">max</code><code class="o">:</code> <code class="mi">2000</code>
<code class="lineno">18</code>   <code class="p">},</code>
<code class="lineno">19</code>   <code class="nx">comments</code><code class="o">:</code> <code class="p">[{</code>
<code class="lineno">20</code>     <code class="nx">text</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">21</code>       <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">22</code>       <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">23</code>       <code class="nx">max</code><code class="o">:</code><code class="mi">2000</code>
<code class="lineno">24</code>     <code class="p">},</code>
<code class="lineno">25</code>     <code class="nx">author</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">26</code>       <code class="nx">id</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">27</code>         <code class="nx">type</code><code class="o">:</code> <code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">ObjectId</code><code class="p">,</code>
<code class="lineno">28</code>         <code class="nx">ref</code><code class="o">:</code> <code class="s1">'User'</code>
<code class="lineno">29</code>       <code class="p">},</code>
<code class="lineno">30</code>       <code class="nx">name</code><code class="o">:</code> <code class="nb">String</code>
<code class="lineno">31</code>     <code class="p">}</code>
<code class="lineno">32</code>   <code class="p">}],</code>
<code class="lineno">33</code>   <code class="nx">watches</code><code class="o">:</code> <code class="p">[{</code>
<code class="lineno">34</code>     <code class="nx">type</code><code class="o">:</code> <code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">ObjectId</code><code class="p">,</code>
<code class="lineno">35</code>     <code class="nx">ref</code><code class="o">:</code> <code class="s1">'User'</code>
<code class="lineno">36</code>   <code class="p">}],</code>
<code class="lineno">37</code>   <code class="nx">likes</code><code class="o">:</code> <code class="p">[{</code>
<code class="lineno">38</code>     <code class="nx">type</code><code class="o">:</code> <code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">ObjectId</code><code class="p">,</code>
<code class="lineno">39</code>     <code class="nx">ref</code><code class="o">:</code> <code class="s1">'User'</code>
<code class="lineno">40</code>   <code class="p">}],</code>
<code class="lineno">41</code>   <code class="nx">author</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">42</code>     <code class="nx">id</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">43</code>       <code class="nx">type</code><code class="o">:</code> <code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">ObjectId</code><code class="p">,</code>
<code class="lineno">44</code>       <code class="nx">ref</code><code class="o">:</code> <code class="s1">'User'</code><code class="p">,</code>
<code class="lineno">45</code>       <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">46</code>     <code class="p">},</code>
<code class="lineno">47</code>     <code class="nx">name</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">48</code>       <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">49</code>       <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">50</code>     <code class="p">}</code>
<code class="lineno">51</code>   <code class="p">},</code>
<code class="lineno">52</code>   <code class="nx">created</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">53</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Date</code><code class="p">,</code>
<code class="lineno">54</code>     <code class="k">default</code><code class="o">:</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">,</code>
<code class="lineno">55</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">56</code>   <code class="p">},</code>
<code class="lineno">57</code>   <code class="nx">updated</code><code class="o">:</code>  <code class="p">{</code>
<code class="lineno">58</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Date</code><code class="p">,</code>
<code class="lineno">59</code>     <code class="k">default</code><code class="o">:</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">,</code>
<code class="lineno">60</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">61</code>   <code class="p">},</code>
<code class="lineno">62</code>   <code class="nx">own</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno">63</code>   <code class="nx">like</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno">64</code>   <code class="nx">watch</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno">65</code>   <code class="nx">admin</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno">66</code>   <code class="nx">action</code><code class="o">:</code> <code class="nb">String</code>
<code class="lineno">67</code> <code class="p">});</code>
</pre></div>

</div>

<p>The User model can also serve as an application object (when <code>approved=false</code>):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">User</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Schema</code><code class="p">({</code>
<code class="lineno"> 2</code>   <code class="nx">angelListId</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 3</code>   <code class="nx">angelListProfile</code><code class="o">:</code> <code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">Mixed</code><code class="p">,</code>
<code class="lineno"> 4</code>   <code class="nx">angelToken</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 5</code>     <code class="nx">firstName</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 6</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 7</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 8</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 9</code>   <code class="p">},</code>
<code class="lineno">10</code>   <code class="nx">lastName</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">11</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">12</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">13</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">14</code>   <code class="p">},</code>
<code class="lineno">15</code>   <code class="nx">displayName</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">16</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">17</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">18</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">19</code>   <code class="p">},</code>
<code class="lineno">20</code>     <code class="nx">password</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">21</code>     <code class="nx">email</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">22</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">23</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">24</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">25</code>   <code class="p">},</code>
<code class="lineno">26</code>   <code class="nx">role</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">27</code>     <code class="nx">type</code><code class="o">:</code><code class="nb">String</code><code class="p">,</code>
<code class="lineno">28</code>     <code class="kr">enum</code><code class="o">:</code> <code class="nx">roles</code><code class="p">,</code>
<code class="lineno">29</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">30</code>     <code class="k">default</code><code class="o">:</code> <code class="nx">roles</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>
<code class="lineno">31</code>   <code class="p">},</code>
<code class="lineno">32</code>   <code class="nx">approved</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">33</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno">34</code>     <code class="k">default</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno">35</code>   <code class="p">},</code>
<code class="lineno">36</code>   <code class="nx">banned</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">37</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno">38</code>     <code class="k">default</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno">39</code>   <code class="p">},</code>
<code class="lineno">40</code>   <code class="nx">admin</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">41</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno">42</code>     <code class="k">default</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno">43</code>   <code class="p">},</code>
<code class="lineno">44</code>   <code class="nx">headline</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">45</code>   <code class="nx">photoUrl</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">46</code>   <code class="nx">angelList</code><code class="o">:</code> <code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">Mixed</code><code class="p">,</code>
<code class="lineno">47</code>   <code class="nx">created</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">48</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Date</code><code class="p">,</code>
<code class="lineno">49</code>     <code class="k">default</code><code class="o">:</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code>
<code class="lineno">50</code>   <code class="p">},</code>
<code class="lineno">51</code>   <code class="nx">updated</code><code class="o">:</code>  <code class="p">{</code>
<code class="lineno">52</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Date</code><code class="p">,</code> <code class="k">default</code><code class="o">:</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code>
<code class="lineno">53</code>   <code class="p">},</code>
<code class="lineno">54</code>   <code class="nx">angelUrl</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">55</code>   <code class="nx">twitterUrl</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">56</code>   <code class="nx">facebookUrl</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">57</code>   <code class="nx">linkedinUrl</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">58</code>   <code class="nx">githubUrl</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">59</code>   <code class="nx">own</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno">60</code>   <code class="nx">posts</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">61</code>     <code class="nx">own</code><code class="o">:</code> <code class="p">[</code><code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">Mixed</code><code class="p">],</code>
<code class="lineno">62</code>     <code class="nx">likes</code><code class="o">:</code> <code class="p">[</code><code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">Mixed</code><code class="p">],</code>
<code class="lineno">63</code>     <code class="nx">watches</code><code class="o">:</code> <code class="p">[</code><code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">Mixed</code><code class="p">],</code>
<code class="lineno">64</code>     <code class="nx">comments</code><code class="o">:</code> <code class="p">[</code><code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">Mixed</code><code class="p">]</code>
<code class="lineno">65</code>   <code class="p">}</code>
<code class="lineno">66</code> <code class="p">});</code>
</pre></div>

</div>

<p>The full source code for <code>hackhall/models/index.js</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">  1</code> <code class="kd">var</code> <code class="nx">mongoose</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongoose'</code><code class="p">);</code>
<code class="lineno">  2</code> <code class="kd">var</code> <code class="nx">Schema</code> <code class="o">=</code> <code class="nx">mongoose</code><code class="p">.</code><code class="nx">Schema</code><code class="p">;</code>
<code class="lineno">  3</code> <code class="kd">var</code> <code class="nx">roles</code> <code class="o">=</code> <code class="s1">'user staff mentor investor founder'</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s1">' '</code><code class="p">);</code>
<code class="lineno">  4</code>
<code class="lineno">  5</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">Post</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Schema</code> <code class="p">({</code>
<code class="lineno">  6</code>   <code class="nx">title</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">  7</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">  8</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">  9</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 10</code>     <code class="c1">// match: /^([[:alpha:][:space:][:punct:]]{1,100})$/</code>
<code class="lineno"> 11</code>     <code class="nx">match</code><code class="o">:</code> <code class="sr">/^([\w ,.!?]{1,100})$/</code>
<code class="lineno"> 12</code>   <code class="p">},</code>
<code class="lineno"> 13</code>   <code class="nx">url</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 14</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 15</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 16</code>     <code class="nx">max</code><code class="o">:</code> <code class="mi">1000</code>
<code class="lineno"> 17</code>   <code class="p">},</code>
<code class="lineno"> 18</code>   <code class="nx">text</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 19</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 20</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 21</code>     <code class="nx">max</code><code class="o">:</code> <code class="mi">2000</code>
<code class="lineno"> 22</code>   <code class="p">},</code>
<code class="lineno"> 23</code>   <code class="nx">comments</code><code class="o">:</code> <code class="p">[{</code>
<code class="lineno"> 24</code>     <code class="nx">text</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 25</code>       <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 26</code>       <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 27</code>       <code class="nx">max</code><code class="o">:</code><code class="mi">2000</code>
<code class="lineno"> 28</code>     <code class="p">},</code>
<code class="lineno"> 29</code>     <code class="nx">author</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 30</code>       <code class="nx">id</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 31</code>         <code class="nx">type</code><code class="o">:</code> <code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">ObjectId</code><code class="p">,</code>
<code class="lineno"> 32</code>         <code class="nx">ref</code><code class="o">:</code> <code class="s1">'User'</code>
<code class="lineno"> 33</code>       <code class="p">},</code>
<code class="lineno"> 34</code>       <code class="nx">name</code><code class="o">:</code> <code class="nb">String</code>
<code class="lineno"> 35</code>     <code class="p">}</code>
<code class="lineno"> 36</code>   <code class="p">}],</code>
<code class="lineno"> 37</code>   <code class="nx">watches</code><code class="o">:</code> <code class="p">[{</code>
<code class="lineno"> 38</code>     <code class="nx">type</code><code class="o">:</code> <code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">ObjectId</code><code class="p">,</code>
<code class="lineno"> 39</code>     <code class="nx">ref</code><code class="o">:</code> <code class="s1">'User'</code>
<code class="lineno"> 40</code>   <code class="p">}],</code>
<code class="lineno"> 41</code>   <code class="nx">likes</code><code class="o">:</code> <code class="p">[{</code>
<code class="lineno"> 42</code>     <code class="nx">type</code><code class="o">:</code> <code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">ObjectId</code><code class="p">,</code>
<code class="lineno"> 43</code>     <code class="nx">ref</code><code class="o">:</code> <code class="s1">'User'</code>
<code class="lineno"> 44</code>   <code class="p">}],</code>
<code class="lineno"> 45</code>   <code class="nx">author</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 46</code>     <code class="nx">id</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 47</code>       <code class="nx">type</code><code class="o">:</code> <code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">ObjectId</code><code class="p">,</code>
<code class="lineno"> 48</code>       <code class="nx">ref</code><code class="o">:</code> <code class="s1">'User'</code><code class="p">,</code>
<code class="lineno"> 49</code>       <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 50</code>     <code class="p">},</code>
<code class="lineno"> 51</code>     <code class="nx">name</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 52</code>       <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 53</code>       <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 54</code>     <code class="p">}</code>
<code class="lineno"> 55</code>   <code class="p">},</code>
<code class="lineno"> 56</code>   <code class="nx">created</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 57</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Date</code><code class="p">,</code>
<code class="lineno"> 58</code>     <code class="k">default</code><code class="o">:</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">,</code>
<code class="lineno"> 59</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 60</code>   <code class="p">},</code>
<code class="lineno"> 61</code>   <code class="nx">updated</code><code class="o">:</code>  <code class="p">{</code>
<code class="lineno"> 62</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Date</code><code class="p">,</code>
<code class="lineno"> 63</code>     <code class="k">default</code><code class="o">:</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">,</code>
<code class="lineno"> 64</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 65</code>   <code class="p">},</code>
<code class="lineno"> 66</code>   <code class="nx">own</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno"> 67</code>   <code class="nx">like</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno"> 68</code>   <code class="nx">watch</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno"> 69</code>   <code class="nx">admin</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno"> 70</code>   <code class="nx">action</code><code class="o">:</code> <code class="nb">String</code>
<code class="lineno"> 71</code> <code class="p">});</code>
<code class="lineno"> 72</code>
<code class="lineno"> 73</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">User</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Schema</code><code class="p">({</code>
<code class="lineno"> 74</code>   <code class="nx">angelListId</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 75</code>   <code class="nx">angelListProfile</code><code class="o">:</code> <code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">Mixed</code><code class="p">,</code>
<code class="lineno"> 76</code>   <code class="nx">angelToken</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 77</code>     <code class="nx">firstName</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 78</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 79</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 80</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 81</code>   <code class="p">},</code>
<code class="lineno"> 82</code>   <code class="nx">lastName</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 83</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 84</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 85</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 86</code>   <code class="p">},</code>
<code class="lineno"> 87</code>   <code class="nx">displayName</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 88</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 89</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 90</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 91</code>   <code class="p">},</code>
<code class="lineno"> 92</code>     <code class="nx">password</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 93</code>     <code class="nx">email</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 94</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno"> 95</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 96</code>     <code class="nx">trim</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno"> 97</code>   <code class="p">},</code>
<code class="lineno"> 98</code>   <code class="nx">role</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 99</code>     <code class="nx">type</code><code class="o">:</code><code class="nb">String</code><code class="p">,</code>
<code class="lineno">100</code>     <code class="kr">enum</code><code class="o">:</code> <code class="nx">roles</code><code class="p">,</code>
<code class="lineno">101</code>     <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">102</code>     <code class="k">default</code><code class="o">:</code> <code class="nx">roles</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>
<code class="lineno">103</code>   <code class="p">},</code>
<code class="lineno">104</code>   <code class="nx">approved</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">105</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno">106</code>     <code class="k">default</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno">107</code>   <code class="p">},</code>
<code class="lineno">108</code>   <code class="nx">banned</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">109</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno">110</code>     <code class="k">default</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno">111</code>   <code class="p">},</code>
<code class="lineno">112</code>   <code class="nx">admin</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">113</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno">114</code>     <code class="k">default</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno">115</code>   <code class="p">},</code>
<code class="lineno">116</code>   <code class="nx">headline</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">117</code>   <code class="nx">photoUrl</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">118</code>   <code class="nx">angelList</code><code class="o">:</code> <code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">Mixed</code><code class="p">,</code>
<code class="lineno">119</code>   <code class="nx">created</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">120</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Date</code><code class="p">,</code>
<code class="lineno">121</code>     <code class="k">default</code><code class="o">:</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code>
<code class="lineno">122</code>   <code class="p">},</code>
<code class="lineno">123</code>   <code class="nx">updated</code><code class="o">:</code>  <code class="p">{</code>
<code class="lineno">124</code>     <code class="nx">type</code><code class="o">:</code> <code class="nb">Date</code><code class="p">,</code> <code class="k">default</code><code class="o">:</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code>
<code class="lineno">125</code>   <code class="p">},</code>
<code class="lineno">126</code>   <code class="nx">angelUrl</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">127</code>   <code class="nx">twitterUrl</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">128</code>   <code class="nx">facebookUrl</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">129</code>   <code class="nx">linkedinUrl</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">130</code>   <code class="nx">githubUrl</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="lineno">131</code>   <code class="nx">own</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
<code class="lineno">132</code>   <code class="nx">posts</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">133</code>     <code class="nx">own</code><code class="o">:</code> <code class="p">[</code><code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">Mixed</code><code class="p">],</code>
<code class="lineno">134</code>     <code class="nx">likes</code><code class="o">:</code> <code class="p">[</code><code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">Mixed</code><code class="p">],</code>
<code class="lineno">135</code>     <code class="nx">watches</code><code class="o">:</code> <code class="p">[</code><code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">Mixed</code><code class="p">],</code>
<code class="lineno">136</code>     <code class="nx">comments</code><code class="o">:</code> <code class="p">[</code><code class="nx">Schema</code><code class="p">.</code><code class="nx">Types</code><code class="p">.</code><code class="nx">Mixed</code><code class="p">]</code>
<code class="lineno">137</code>   <code class="p">}</code>
<code class="lineno">138</code> <code class="p">});</code>
</pre></div>

</div>

<h3 id="leanpub-auto-mocha-tests">
<span class="section-number">4.7 </span>Mocha Tests</h3>

<p>One of the benefits of using REST API server architecture is that each route and the application as a whole become very testable. The assurance of the passed tests is a wonderful supplement during development â€” the so called test-driven development approach.</p>

<p>To run tests, we utilize Makefile:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="n">REPORTER</code> <code class="o">=</code> <code class="n">list</code>
<code class="lineno"> 2</code> <code class="n">MOCHA_OPTS</code> <code class="o">=</code> <code class="o">--</code><code class="n">ui</code> <code class="n">tdd</code> <code class="o">--</code><code class="n">ignore</code><code class="o">-</code><code class="n">leaks</code>
<code class="lineno"> 3</code>
<code class="lineno"> 4</code> <code class="nl">test:</code>
<code class="lineno"> 5</code>  <code class="n">clear</code>
<code class="lineno"> 6</code>  <code class="n">echo</code> <code class="n">Starting</code> <code class="n">test</code> <code class="o">*********************************************************</code>
<code class="lineno"> 7</code>  <code class="p">.</code><code class="o">/</code><code class="n">node_modules</code><code class="o">/</code><code class="n">mocha</code><code class="o">/</code><code class="n">bin</code><code class="o">/</code><code class="n">mocha</code> \
<code class="lineno"> 8</code>  <code class="o">--</code><code class="n">reporter</code> <code class="err">$</code><code class="p">(</code><code class="n">REPORTER</code><code class="p">)</code> \
<code class="lineno"> 9</code>  <code class="err">$</code><code class="p">(</code><code class="n">MOCHA_OPTS</code><code class="p">)</code> \
<code class="lineno">10</code>  <code class="n">tests</code><code class="o">/*</code><code class="p">.</code><code class="n">js</code>
<code class="lineno">11</code>  <code class="n">echo</code> <code class="n">Ending</code> <code class="n">test</code>
<code class="lineno">12</code>
<code class="lineno">13</code> <code class="n">test</code><code class="o">-</code><code class="n">w</code><code class="o">:</code>
<code class="lineno">14</code>  <code class="p">.</code><code class="o">/</code><code class="n">node_modules</code><code class="o">/</code><code class="n">mocha</code><code class="o">/</code><code class="n">bin</code><code class="o">/</code><code class="n">mocha</code> \
<code class="lineno">15</code>  <code class="o">--</code><code class="n">reporter</code> <code class="err">$</code><code class="p">(</code><code class="n">REPORTER</code><code class="p">)</code> \
<code class="lineno">16</code>  <code class="o">--</code><code class="n">growl</code> \
<code class="lineno">17</code>  <code class="o">--</code><code class="n">watch</code> \
<code class="lineno">18</code>  <code class="err">$</code><code class="p">(</code><code class="n">MOCHA_OPTS</code><code class="p">)</code> \
<code class="lineno">19</code>  <code class="n">tests</code><code class="o">/*</code><code class="p">.</code><code class="n">js</code>
<code class="lineno">20</code>
<code class="lineno">21</code> <code class="nl">users:</code>
<code class="lineno">22</code>  <code class="n">mocha</code> <code class="n">tests</code><code class="o">/</code><code class="n">users</code><code class="p">.</code><code class="n">js</code> <code class="o">--</code><code class="n">ui</code> <code class="n">tdd</code> <code class="o">--</code><code class="n">reporter</code> <code class="n">list</code> <code class="o">--</code><code class="n">ignore</code><code class="o">-</code><code class="n">leaks</code>
<code class="lineno">23</code>
<code class="lineno">24</code> <code class="nl">posts:</code>
<code class="lineno">25</code>  <code class="n">clear</code>
<code class="lineno">26</code>  <code class="n">echo</code> <code class="n">Starting</code> <code class="n">test</code> <code class="o">*********************************************************</code>
<code class="lineno">27</code>  <code class="p">.</code><code class="o">/</code><code class="n">node_modules</code><code class="o">/</code><code class="n">mocha</code><code class="o">/</code><code class="n">bin</code><code class="o">/</code><code class="n">mocha</code> \
<code class="lineno">28</code>  <code class="o">--</code><code class="n">reporter</code> <code class="err">$</code><code class="p">(</code><code class="n">REPORTER</code><code class="p">)</code> \
<code class="lineno">29</code>  <code class="err">$</code><code class="p">(</code><code class="n">MOCHA_OPTS</code><code class="p">)</code> \
<code class="lineno">30</code>  <code class="n">tests</code><code class="o">/</code><code class="n">posts</code><code class="p">.</code><code class="n">js</code>
<code class="lineno">31</code>  <code class="n">echo</code> <code class="n">Ending</code> <code class="n">test</code>
<code class="lineno">32</code>
<code class="lineno">33</code> <code class="nl">application:</code>
<code class="lineno">34</code>  <code class="n">mocha</code> <code class="n">tests</code><code class="o">/</code><code class="n">application</code><code class="p">.</code><code class="n">js</code> <code class="o">--</code><code class="n">ui</code> <code class="n">tdd</code> <code class="o">--</code><code class="n">reporter</code> <code class="n">list</code> <code class="o">--</code><code class="n">ignore</code><code class="o">-</code><code class="n">leaks</code>
<code class="lineno">35</code>
<code class="lineno">36</code> <code class="p">.</code><code class="n">PHONY</code><code class="o">:</code> <code class="n">test</code> <code class="n">test</code><code class="o">-</code><code class="n">w</code> <code class="n">posts</code> <code class="n">application</code>
</pre></div>

</div>

<p>Therefore, we can start tests with: <code>$ make</code> command.</p>

<p>All the 20 tests should pass:</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/hackhall-mocha.png" alt="The results of running Mocha tests."><p class="caption">The results of running Mocha tests.</p>
</div>

<p>The HackHall tests live in <code>tests</code> folder and consist of:</p>

<ul>
<li>
<code>hackhall/tests/application.js</code>: functional tests for unapproved users information</li>
  <li>
<code>hackhall/tests/posts.js</code>: functional tests for posts</li>
  <li>
<code>hackhall/tests/users.js</code>: functional tests for users</li>
</ul>
<p>Test use a library called <a href="https://npmjs.org/package/superagent">superagent</a>(<a href="https://github.com/visionmedia/superagent">GitHub</a>).</p>

<p>The full content for <code>hackhall/tests/application.js</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">  1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code> <code class="p">(</code><code class="s1">'../server'</code><code class="p">).</code><code class="nx">app</code><code class="p">,</code>
<code class="lineno">  2</code>   <code class="nx">assert</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'assert'</code><code class="p">),</code>
<code class="lineno">  3</code>   <code class="nx">request</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'superagent'</code><code class="p">);</code>
<code class="lineno">  4</code>
<code class="lineno">  5</code> <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">),</code> <code class="kd">function</code><code class="p">(){</code>
<code class="lineno">  6</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Express server listening on port '</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">));</code>
<code class="lineno">  7</code> <code class="p">});</code>
<code class="lineno">  8</code>
<code class="lineno">  9</code> <code class="kd">var</code> <code class="nx">user1</code> <code class="o">=</code> <code class="nx">request</code><code class="p">.</code><code class="nx">agent</code><code class="p">();</code>
<code class="lineno"> 10</code> <code class="kd">var</code> <code class="nx">port</code> <code class="o">=</code> <code class="s1">'http://localhost:'</code><code class="o">+</code><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">);</code>
<code class="lineno"> 11</code> <code class="kd">var</code> <code class="nx">userId</code><code class="p">;</code>
<code class="lineno"> 12</code>
<code class="lineno"> 13</code> <code class="nx">suite</code><code class="p">(</code><code class="s1">'APPLICATION API'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(){</code>
<code class="lineno"> 14</code>   <code class="nx">suiteSetup</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno"> 15</code>     <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 16</code>   <code class="p">});</code>
<code class="lineno"> 17</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'log in as admin'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno"> 18</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/login'</code><code class="p">).</code><code class="nx">send</code><code class="p">({</code><code class="nx">email</code><code class="o">:</code><code class="s1">'1@1.com'</code><code class="p">,</code><code class="nx">password</code><code class="o">:</code><code class="s1">'1'</code><code class="p">}).</code><code class="nx">end</code><code class="p">(</code><code class="nx">functi</code><code class="o">\</code>
<code class="lineno"> 19</code> <code class="nx">on</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno"> 20</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code><code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 21</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 22</code>     <code class="p">});</code>
<code class="lineno"> 23</code>   <code class="p">});</code>
<code class="lineno"> 24</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'get profile for admin'</code><code class="p">,</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno"> 25</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/profile'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno"> 26</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code><code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 27</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 28</code>     <code class="p">});</code>
<code class="lineno"> 29</code>   <code class="p">});</code>
<code class="lineno"> 30</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'submit applicaton for user 3@3.com'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno"> 31</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/application'</code><code class="p">).</code><code class="nx">send</code><code class="p">({</code>
<code class="lineno"> 32</code>         <code class="nx">firstName</code><code class="o">:</code> <code class="s1">'Dummy'</code><code class="p">,</code>
<code class="lineno"> 33</code>       <code class="nx">lastName</code><code class="o">:</code> <code class="s1">'Application'</code><code class="p">,</code>
<code class="lineno"> 34</code>       <code class="nx">displayName</code><code class="o">:</code> <code class="s1">'Dummy Application'</code><code class="p">,</code>
<code class="lineno"> 35</code>         <code class="nx">password</code><code class="o">:</code> <code class="s1">'3'</code><code class="p">,</code>
<code class="lineno"> 36</code>         <code class="nx">email</code><code class="o">:</code> <code class="s1">'3@3.com'</code><code class="p">,</code>
<code class="lineno"> 37</code>       <code class="nx">headline</code><code class="o">:</code> <code class="s1">'Dummy Appliation'</code><code class="p">,</code>
<code class="lineno"> 38</code>       <code class="nx">photoUrl</code><code class="o">:</code> <code class="s1">'/img/user.png'</code><code class="p">,</code>
<code class="lineno"> 39</code>       <code class="nx">angelList</code><code class="o">:</code> <code class="p">{</code><code class="nx">blah</code><code class="o">:</code><code class="s1">'blah'</code><code class="p">},</code>
<code class="lineno"> 40</code>       <code class="nx">angelUrl</code><code class="o">:</code> <code class="s1">'http://angel.co.com/someuser'</code><code class="p">,</code>
<code class="lineno"> 41</code>       <code class="nx">twitterUrl</code><code class="o">:</code> <code class="s1">'http://twitter.com/someuser'</code><code class="p">,</code>
<code class="lineno"> 42</code>       <code class="nx">facebookUrl</code><code class="o">:</code> <code class="s1">'http://facebook.com/someuser'</code><code class="p">,</code>
<code class="lineno"> 43</code>       <code class="nx">linkedinUrl</code><code class="o">:</code> <code class="s1">'http://linkedin.com/someuser'</code><code class="p">,</code>
<code class="lineno"> 44</code>       <code class="nx">githubUrl</code><code class="o">:</code> <code class="s1">'http://github.com/someuser'</code>
<code class="lineno"> 45</code>     <code class="p">}).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno"> 46</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code><code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 47</code>       <code class="nx">userId</code> <code class="o">=</code> <code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code><code class="p">;</code>
<code class="lineno"> 48</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 49</code>     <code class="p">});</code>
<code class="lineno"> 50</code>
<code class="lineno"> 51</code>   <code class="p">});</code>
<code class="lineno"> 52</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'logout admin'</code><code class="p">,</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno"> 53</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/logout'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno"> 54</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code><code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 55</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 56</code>     <code class="p">});</code>
<code class="lineno"> 57</code>   <code class="p">});</code>
<code class="lineno"> 58</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'get profile again after logging out'</code><code class="p">,</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno"> 59</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/profile'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno"> 60</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code><code class="mi">500</code><code class="p">);</code>
<code class="lineno"> 61</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 62</code>     <code class="p">});</code>
<code class="lineno"> 63</code>   <code class="p">});</code>
<code class="lineno"> 64</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'log in as user3 - unapproved'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno"> 65</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/login'</code><code class="p">).</code><code class="nx">send</code><code class="p">({</code><code class="nx">email</code><code class="o">:</code><code class="s1">'3@3.com'</code><code class="p">,</code><code class="nx">password</code><code class="o">:</code><code class="s1">'3'</code><code class="p">}).</code><code class="nx">end</code><code class="p">(</code><code class="nx">functi</code><code class="o">\</code>
<code class="lineno"> 66</code> <code class="nx">on</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno"> 67</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code><code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 68</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 69</code>     <code class="p">});</code>
<code class="lineno"> 70</code>   <code class="p">});</code>
<code class="lineno"> 71</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'get user application'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno"> 72</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/application/'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno"> 73</code>       <code class="c1">// console.log(res.body)</code>
<code class="lineno"> 74</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 75</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 76</code>     <code class="p">});</code>
<code class="lineno"> 77</code>   <code class="p">});</code>
<code class="lineno"> 78</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'update user application'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno"> 79</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/application/'</code><code class="p">).</code><code class="nx">send</code><code class="p">({</code>
<code class="lineno"> 80</code>       <code class="nx">firstName</code><code class="o">:</code> <code class="s1">'boo'</code><code class="p">}).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno"> 81</code>       <code class="c1">// console.log(res.body)</code>
<code class="lineno"> 82</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 83</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 84</code>     <code class="p">});</code>
<code class="lineno"> 85</code>   <code class="p">});</code>
<code class="lineno"> 86</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'get user application'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno"> 87</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/application/'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno"> 88</code>       <code class="c1">// console.log(res.body)</code>
<code class="lineno"> 89</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 90</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 91</code>     <code class="p">});</code>
<code class="lineno"> 92</code>   <code class="p">});</code>
<code class="lineno"> 93</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'check for posts - fail (unapproved?)'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno"> 94</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/posts/'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno"> 95</code>       <code class="c1">// console.log(res.body)</code>
<code class="lineno"> 96</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">500</code><code class="p">);</code>
<code class="lineno"> 97</code>
<code class="lineno"> 98</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 99</code>     <code class="p">});</code>
<code class="lineno">100</code>   <code class="p">});</code>
<code class="lineno">101</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'logout user'</code><code class="p">,</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno">102</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/logout'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno">103</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code><code class="mi">200</code><code class="p">);</code>
<code class="lineno">104</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">105</code>     <code class="p">});</code>
<code class="lineno">106</code>   <code class="p">});</code>
<code class="lineno">107</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'log in as admin'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno">108</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/login'</code><code class="p">).</code><code class="nx">send</code><code class="p">({</code><code class="nx">email</code><code class="o">:</code><code class="s1">'1@1.com'</code><code class="p">,</code><code class="nx">password</code><code class="o">:</code><code class="s1">'1'</code><code class="p">}).</code><code class="nx">end</code><code class="p">(</code><code class="nx">functi</code><code class="o">\</code>
<code class="lineno">109</code> <code class="nx">on</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno">110</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code><code class="mi">200</code><code class="p">);</code>
<code class="lineno">111</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">112</code>     <code class="p">});</code>
<code class="lineno">113</code>   <code class="p">});</code>
<code class="lineno">114</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'delete user3'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno">115</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/users/'</code><code class="o">+</code><code class="nx">userId</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno">116</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">117</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">118</code>     <code class="p">});</code>
<code class="lineno">119</code>   <code class="p">});</code>
<code class="lineno">120</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'logout admin'</code><code class="p">,</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno">121</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/logout'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno">122</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code><code class="mi">200</code><code class="p">);</code>
<code class="lineno">123</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">124</code>     <code class="p">});</code>
<code class="lineno">125</code>   <code class="p">});</code>
<code class="lineno">126</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'log in as user - should fail'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno">127</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/login'</code><code class="p">).</code><code class="nx">send</code><code class="p">({</code><code class="nx">email</code><code class="o">:</code><code class="s1">'3@3.com'</code><code class="p">,</code><code class="nx">password</code><code class="o">:</code><code class="s1">'3'</code><code class="p">}).</code><code class="nx">end</code><code class="p">(</code><code class="nx">functi</code><code class="o">\</code>
<code class="lineno">128</code> <code class="nx">on</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno">129</code>       <code class="c1">// console.log(res.body)</code>
<code class="lineno">130</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code><code class="mi">500</code><code class="p">);</code>
<code class="lineno">131</code>
<code class="lineno">132</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">133</code>     <code class="p">});</code>
<code class="lineno">134</code>   <code class="p">});</code>
<code class="lineno">135</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'check for posts - must fail'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno">136</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code><code class="o">+</code><code class="s1">'/api/posts/'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">){</code>
<code class="lineno">137</code>       <code class="c1">// console.log(res.body)</code>
<code class="lineno">138</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">500</code><code class="p">);</code>
<code class="lineno">139</code>
<code class="lineno">140</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">141</code>     <code class="p">});</code>
<code class="lineno">142</code>   <code class="p">});</code>
<code class="lineno">143</code>   <code class="nx">suiteTeardown</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">){</code>
<code class="lineno">144</code>     <code class="nx">done</code><code class="p">();</code>
<code class="lineno">145</code>   <code class="p">});</code>
<code class="lineno">146</code>
<code class="lineno">147</code> <code class="p">});</code>
</pre></div>

</div>

<p>The full content for <code>hackhall/tests/posts.js</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'../server'</code><code class="p">).</code><code class="nx">app</code><code class="p">,</code>
<code class="lineno"> 2</code>   <code class="nx">assert</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'assert'</code><code class="p">),</code>
<code class="lineno"> 3</code>   <code class="nx">request</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'superagent'</code><code class="p">);</code>
<code class="lineno"> 4</code>
<code class="lineno"> 5</code> <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">),</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 6</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Express server listening on port '</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">));</code>
<code class="lineno"> 7</code> <code class="p">});</code>
<code class="lineno"> 8</code>
<code class="lineno"> 9</code> <code class="kd">var</code> <code class="nx">user1</code> <code class="o">=</code> <code class="nx">request</code><code class="p">.</code><code class="nx">agent</code><code class="p">();</code>
<code class="lineno">10</code> <code class="kd">var</code> <code class="nx">port</code> <code class="o">=</code> <code class="s1">'http://localhost:'</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">);</code>
<code class="lineno">11</code> <code class="kd">var</code> <code class="nx">postId</code><code class="p">;</code>
<code class="lineno">12</code>
<code class="lineno">13</code> <code class="nx">suite</code><code class="p">(</code><code class="s1">'POSTS API'</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">14</code>   <code class="nx">suiteSetup</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">15</code>     <code class="nx">done</code><code class="p">();</code>
<code class="lineno">16</code>   <code class="p">});</code>
<code class="lineno">17</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'log in'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">18</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/login'</code><code class="p">).</code><code class="nx">send</code><code class="p">({</code>
<code class="lineno">19</code>       <code class="nx">email</code><code class="o">:</code> <code class="s1">'1@1.com'</code><code class="p">,</code>
<code class="lineno">20</code>       <code class="nx">password</code><code class="o">:</code> <code class="s1">'1'</code>
<code class="lineno">21</code>     <code class="p">}).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">22</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">23</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">24</code>     <code class="p">});</code>
<code class="lineno">25</code>   <code class="p">});</code>
<code class="lineno">26</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'add post'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">27</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/posts'</code><code class="p">).</code><code class="nx">send</code><code class="p">({</code>
<code class="lineno">28</code>       <code class="nx">title</code><code class="o">:</code> <code class="s1">'Yo Test Title'</code><code class="p">,</code>
<code class="lineno">29</code>       <code class="nx">text</code><code class="o">:</code> <code class="s1">'Yo Test text'</code><code class="p">,</code>
<code class="lineno">30</code>       <code class="nx">url</code><code class="o">:</code> <code class="s1">''</code>
<code class="lineno">31</code>     <code class="p">}).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">32</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">33</code>       <code class="nx">postId</code> <code class="o">=</code> <code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code><code class="p">;</code>
<code class="lineno">34</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">35</code>     <code class="p">});</code>
<code class="lineno">36</code>
<code class="lineno">37</code>   <code class="p">});</code>
<code class="lineno">38</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'get profile'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">39</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/profile'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">40</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">41</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">42</code>     <code class="p">});</code>
<code class="lineno">43</code>   <code class="p">});</code>
<code class="lineno">44</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'post get'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">45</code>     <code class="c1">// console.log('000'+postId);</code>
<code class="lineno">46</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/posts/'</code> <code class="o">+</code> <code class="nx">postId</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">47</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">48</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="nx">postId</code><code class="p">);</code>
<code class="lineno">49</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">50</code>     <code class="p">});</code>
<code class="lineno">51</code>   <code class="p">});</code>
<code class="lineno">52</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'delete post'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">53</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/posts/'</code> <code class="o">+</code> <code class="nx">postId</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">54</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">55</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">56</code>     <code class="p">});</code>
<code class="lineno">57</code>   <code class="p">});</code>
<code class="lineno">58</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'check for deleted post'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">59</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/posts/'</code> <code class="o">+</code> <code class="nx">postId</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">60</code>       <code class="c1">// console.log(res.body)</code>
<code class="lineno">61</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">500</code><code class="p">);</code>
<code class="lineno">62</code>
<code class="lineno">63</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">64</code>     <code class="p">});</code>
<code class="lineno">65</code>   <code class="p">});</code>
<code class="lineno">66</code>   <code class="nx">suiteTeardown</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">67</code>     <code class="nx">done</code><code class="p">();</code>
<code class="lineno">68</code>   <code class="p">});</code>
<code class="lineno">69</code>
<code class="lineno">70</code> <code class="p">});</code>
</pre></div>

</div>

<p>The full content for <code>hackhall/tests/users.js</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">  1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'../server'</code><code class="p">).</code><code class="nx">app</code><code class="p">,</code>
<code class="lineno">  2</code>   <code class="nx">assert</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'assert'</code><code class="p">),</code>
<code class="lineno">  3</code>   <code class="nx">request</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'superagent'</code><code class="p">);</code>
<code class="lineno">  4</code> <code class="c1">// http = require('support/http');</code>
<code class="lineno">  5</code>
<code class="lineno">  6</code> <code class="kd">var</code> <code class="nx">user1</code> <code class="o">=</code> <code class="nx">request</code><code class="p">.</code><code class="nx">agent</code><code class="p">();</code>
<code class="lineno">  7</code> <code class="kd">var</code> <code class="nx">port</code> <code class="o">=</code> <code class="s1">'http://localhost:'</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">);</code>
<code class="lineno">  8</code>
<code class="lineno">  9</code>
<code class="lineno"> 10</code> <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">),</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 11</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Express server listening on port '</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">));</code>
<code class="lineno"> 12</code> <code class="p">});</code>
<code class="lineno"> 13</code>
<code class="lineno"> 14</code> <code class="nx">suite</code><code class="p">(</code><code class="s1">'Test root'</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 15</code>   <code class="nx">setup</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 16</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'setup'</code><code class="p">);</code>
<code class="lineno"> 17</code>
<code class="lineno"> 18</code>     <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 19</code>   <code class="p">});</code>
<code class="lineno"> 20</code>
<code class="lineno"> 21</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'check /'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 22</code>     <code class="nx">request</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'http://localhost:3000'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 23</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 24</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 25</code>     <code class="p">});</code>
<code class="lineno"> 26</code>   <code class="p">});</code>
<code class="lineno"> 27</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'check /api/profile'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 28</code>     <code class="nx">request</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'http://localhost:'</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'/api/profile'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="nx">funct</code><code class="o">\</code>
<code class="lineno"> 29</code> <code class="nx">ion</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 30</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">500</code><code class="p">);</code>
<code class="lineno"> 31</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 32</code>     <code class="p">});</code>
<code class="lineno"> 33</code>   <code class="p">});</code>
<code class="lineno"> 34</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'check /api/users'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 35</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'http://localhost:'</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'/api/users'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="o">\</code>
<code class="lineno"> 36</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 37</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">500</code><code class="p">);</code>
<code class="lineno"> 38</code>       <code class="c1">// console.log(res.text.length);</code>
<code class="lineno"> 39</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 40</code>     <code class="p">});</code>
<code class="lineno"> 41</code>     <code class="c1">// done();</code>
<code class="lineno"> 42</code>   <code class="p">});</code>
<code class="lineno"> 43</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'check /api/posts'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 44</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'http://localhost:'</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'/api/posts'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="o">\</code>
<code class="lineno"> 45</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 46</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">500</code><code class="p">);</code>
<code class="lineno"> 47</code>       <code class="c1">// console.log(res.text.length);</code>
<code class="lineno"> 48</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 49</code>     <code class="p">});</code>
<code class="lineno"> 50</code>     <code class="c1">// done();</code>
<code class="lineno"> 51</code>   <code class="p">});</code>
<code class="lineno"> 52</code>   <code class="nx">teardown</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 53</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'teardown'</code><code class="p">);</code>
<code class="lineno"> 54</code>     <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 55</code>   <code class="p">});</code>
<code class="lineno"> 56</code>
<code class="lineno"> 57</code> <code class="p">});</code>
<code class="lineno"> 58</code>
<code class="lineno"> 59</code> <code class="nx">suite</code><code class="p">(</code><code class="s1">'Test log in'</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 60</code>   <code class="nx">setup</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 61</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'setup'</code><code class="p">);</code>
<code class="lineno"> 62</code>
<code class="lineno"> 63</code>     <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 64</code>   <code class="p">});</code>
<code class="lineno"> 65</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'login'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 66</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'http://localhost:3000/api/login'</code><code class="p">).</code><code class="nx">send</code><code class="p">({</code>
<code class="lineno"> 67</code>       <code class="nx">email</code><code class="o">:</code> <code class="s1">'1@1.com'</code><code class="p">,</code>
<code class="lineno"> 68</code>       <code class="nx">password</code><code class="o">:</code> <code class="s1">'1'</code>
<code class="lineno"> 69</code>     <code class="p">}).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 70</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 71</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 72</code>     <code class="p">});</code>
<code class="lineno"> 73</code>
<code class="lineno"> 74</code>   <code class="p">});</code>
<code class="lineno"> 75</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'check /api/profile'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 76</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'http://localhost:'</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'/api/profile'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="nx">functio</code><code class="o">\</code>
<code class="lineno"> 77</code> <code class="nx">n</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 78</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 79</code>       <code class="c1">// console.log(res.text.length);</code>
<code class="lineno"> 80</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 81</code>     <code class="p">});</code>
<code class="lineno"> 82</code>     <code class="c1">// done();</code>
<code class="lineno"> 83</code>   <code class="p">});</code>
<code class="lineno"> 84</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'check /api/users'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 85</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'http://localhost:'</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'/api/users'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="o">\</code>
<code class="lineno"> 86</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 87</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 88</code>       <code class="c1">// console.log(res.text);</code>
<code class="lineno"> 89</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 90</code>     <code class="p">});</code>
<code class="lineno"> 91</code>     <code class="c1">// done();</code>
<code class="lineno"> 92</code>   <code class="p">});</code>
<code class="lineno"> 93</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'check /api/posts'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 94</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'http://localhost:'</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'/api/posts'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="o">\</code>
<code class="lineno"> 95</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 96</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno"> 97</code>       <code class="c1">// console.log(res.text.length);</code>
<code class="lineno"> 98</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno"> 99</code>     <code class="p">});</code>
<code class="lineno">100</code>     <code class="c1">// done();</code>
<code class="lineno">101</code>   <code class="p">});</code>
<code class="lineno">102</code>
<code class="lineno">103</code>   <code class="nx">teardown</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">104</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'teardown'</code><code class="p">);</code>
<code class="lineno">105</code>     <code class="nx">done</code><code class="p">();</code>
<code class="lineno">106</code>   <code class="p">});</code>
<code class="lineno">107</code>
<code class="lineno">108</code> <code class="p">});</code>
<code class="lineno">109</code> <code class="nx">suite</code><code class="p">(</code><code class="s1">'User control'</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">110</code>   <code class="kd">var</code> <code class="nx">user2</code> <code class="o">=</code> <code class="p">{</code>
<code class="lineno">111</code>     <code class="nx">firstName</code><code class="o">:</code> <code class="s1">'Bob'</code><code class="p">,</code>
<code class="lineno">112</code>     <code class="nx">lastName</code><code class="o">:</code> <code class="s1">'Dilan'</code><code class="p">,</code>
<code class="lineno">113</code>     <code class="nx">displayName</code><code class="o">:</code> <code class="s1">'Bob Dilan'</code><code class="p">,</code>
<code class="lineno">114</code>     <code class="nx">email</code><code class="o">:</code> <code class="s1">'2@2.com'</code>
<code class="lineno">115</code>   <code class="p">};</code>
<code class="lineno">116</code>   <code class="nx">suiteSetup</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">117</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'http://localhost:3000/api/login'</code><code class="p">).</code><code class="nx">send</code><code class="p">({</code>
<code class="lineno">118</code>       <code class="nx">email</code><code class="o">:</code> <code class="s1">'1@1.com'</code><code class="p">,</code>
<code class="lineno">119</code>       <code class="nx">password</code><code class="o">:</code> <code class="s1">'1'</code>
<code class="lineno">120</code>     <code class="p">}).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">121</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">122</code>       <code class="c1">// done();</code>
<code class="lineno">123</code>     <code class="p">});</code>
<code class="lineno">124</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'http://localhost:'</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'/api/profile'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="nx">functio</code><code class="o">\</code>
<code class="lineno">125</code> <code class="nx">n</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">126</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">127</code>       <code class="c1">// console.log(res.text.length);</code>
<code class="lineno">128</code>       <code class="c1">// done();</code>
<code class="lineno">129</code>     <code class="p">});</code>
<code class="lineno">130</code>
<code class="lineno">131</code>     <code class="nx">done</code><code class="p">();</code>
<code class="lineno">132</code>   <code class="p">})</code>
<code class="lineno">133</code>
<code class="lineno">134</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'new user POST /api/users'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">135</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/users'</code><code class="p">)</code>
<code class="lineno">136</code>       <code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">user2</code><code class="p">)</code>
<code class="lineno">137</code>       <code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">138</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">139</code>         <code class="c1">// console.log(res.text.length);</code>
<code class="lineno">140</code>         <code class="nx">user2</code> <code class="o">=</code> <code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">;</code>
<code class="lineno">141</code>         <code class="c1">// console.log(user2)</code>
<code class="lineno">142</code>         <code class="nx">done</code><code class="p">();</code>
<code class="lineno">143</code>       <code class="p">})</code>
<code class="lineno">144</code>   <code class="p">});</code>
<code class="lineno">145</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'get user list and check for new user GET /api/users'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">146</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'http://localhost:'</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'/api/users'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="o">\</code>
<code class="lineno">147</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">148</code>       <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">149</code>       <code class="c1">// console.log(res.body)</code>
<code class="lineno">150</code>       <code class="kd">var</code> <code class="nx">user3</code> <code class="o">=</code> <code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">el</code><code class="p">,</code> <code class="nx">i</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">151</code>         <code class="k">return</code> <code class="p">(</code><code class="nx">el</code><code class="p">.</code><code class="nx">_id</code> <code class="o">==</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code><code class="p">);</code>
<code class="lineno">152</code>       <code class="p">});</code>
<code class="lineno">153</code>       <code class="nx">assert</code><code class="p">(</code><code class="nx">user3</code><code class="p">.</code><code class="nx">length</code> <code class="o">===</code> <code class="mi">1</code><code class="p">);</code>
<code class="lineno">154</code>       <code class="c1">// assert(res.body.indexOf(user2)&gt;-1);</code>
<code class="lineno">155</code>       <code class="c1">// console.log(res.body.length)</code>
<code class="lineno">156</code>       <code class="nx">done</code><code class="p">();</code>
<code class="lineno">157</code>     <code class="p">})</code>
<code class="lineno">158</code>   <code class="p">});</code>
<code class="lineno">159</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'Approve User: PUT /api/users/'</code> <code class="o">+</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">160</code>     <code class="nx">assert</code><code class="p">(</code><code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code> <code class="o">!=</code> <code class="s1">''</code><code class="p">);</code>
<code class="lineno">161</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/users/'</code> <code class="o">+</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code><code class="p">)</code>
<code class="lineno">162</code>       <code class="p">.</code><code class="nx">send</code><code class="p">({</code>
<code class="lineno">163</code>         <code class="nx">approved</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">164</code>       <code class="p">})</code>
<code class="lineno">165</code>       <code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">166</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">167</code>         <code class="c1">// console.log(res.text.length);</code>
<code class="lineno">168</code>         <code class="nx">assert</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">approved</code><code class="p">);</code>
<code class="lineno">169</code>         <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/users/'</code> <code class="o">+</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">170</code>           <code class="nx">assert</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">171</code>           <code class="nx">assert</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">approved</code><code class="p">);</code>
<code class="lineno">172</code>           <code class="nx">done</code><code class="p">();</code>
<code class="lineno">173</code>         <code class="p">})</code>
<code class="lineno">174</code>
<code class="lineno">175</code>       <code class="p">})</code>
<code class="lineno">176</code>   <code class="p">});</code>
<code class="lineno">177</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'Banned User: PUT /api/users/'</code> <code class="o">+</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">178</code>     <code class="nx">assert</code><code class="p">(</code><code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code> <code class="o">!=</code> <code class="s1">''</code><code class="p">);</code>
<code class="lineno">179</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/users/'</code> <code class="o">+</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code><code class="p">)</code>
<code class="lineno">180</code>       <code class="p">.</code><code class="nx">send</code><code class="p">({</code>
<code class="lineno">181</code>         <code class="nx">banned</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">182</code>       <code class="p">})</code>
<code class="lineno">183</code>       <code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">184</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">185</code>         <code class="c1">// console.log(res.text.length);</code>
<code class="lineno">186</code>         <code class="nx">assert</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">banned</code><code class="p">);</code>
<code class="lineno">187</code>         <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/users/'</code> <code class="o">+</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">188</code>           <code class="nx">assert</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">189</code>           <code class="nx">assert</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">banned</code><code class="p">);</code>
<code class="lineno">190</code>           <code class="nx">done</code><code class="p">();</code>
<code class="lineno">191</code>         <code class="p">})</code>
<code class="lineno">192</code>
<code class="lineno">193</code>       <code class="p">})</code>
<code class="lineno">194</code>   <code class="p">});</code>
<code class="lineno">195</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'Promote User: PUT /api/users/'</code> <code class="o">+</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">196</code>     <code class="nx">assert</code><code class="p">(</code><code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code> <code class="o">!=</code> <code class="s1">''</code><code class="p">);</code>
<code class="lineno">197</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/users/'</code> <code class="o">+</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code><code class="p">)</code>
<code class="lineno">198</code>       <code class="p">.</code><code class="nx">send</code><code class="p">({</code>
<code class="lineno">199</code>         <code class="nx">admin</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">200</code>       <code class="p">})</code>
<code class="lineno">201</code>       <code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">202</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">203</code>         <code class="c1">// console.log(res.text.length);</code>
<code class="lineno">204</code>         <code class="nx">assert</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">admin</code><code class="p">);</code>
<code class="lineno">205</code>         <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/users/'</code> <code class="o">+</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">206</code>           <code class="nx">assert</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">207</code>           <code class="nx">assert</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">admin</code><code class="p">);</code>
<code class="lineno">208</code>           <code class="nx">done</code><code class="p">();</code>
<code class="lineno">209</code>         <code class="p">})</code>
<code class="lineno">210</code>
<code class="lineno">211</code>       <code class="p">})</code>
<code class="lineno">212</code>   <code class="p">});</code>
<code class="lineno">213</code>   <code class="nx">test</code><code class="p">(</code><code class="s1">'Delete User: DELETE /api/users/:id'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">214</code>     <code class="nx">assert</code><code class="p">(</code><code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code> <code class="o">!=</code> <code class="s1">''</code><code class="p">);</code>
<code class="lineno">215</code>     <code class="nx">user1</code><code class="p">.</code><code class="nx">del</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/users/'</code> <code class="o">+</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code><code class="p">)</code>
<code class="lineno">216</code>       <code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">217</code>         <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">218</code>         <code class="c1">// console.log('id:' + user2._id)</code>
<code class="lineno">219</code>         <code class="nx">user1</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">port</code> <code class="o">+</code> <code class="s1">'/api/users'</code><code class="p">).</code><code class="nx">end</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">220</code>           <code class="nx">assert</code><code class="p">.</code><code class="nx">equal</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="lineno">221</code>           <code class="kd">var</code> <code class="nx">user3</code> <code class="o">=</code> <code class="nx">res</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">el</code><code class="p">,</code> <code class="nx">i</code><code class="p">,</code> <code class="nx">list</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">222</code>             <code class="k">return</code> <code class="p">(</code><code class="nx">el</code><code class="p">.</code><code class="nx">_id</code> <code class="o">===</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">_id</code><code class="p">);</code>
<code class="lineno">223</code>           <code class="p">});</code>
<code class="lineno">224</code>           <code class="c1">// console.log('***');</code>
<code class="lineno">225</code>           <code class="c1">// console.warn(user3);</code>
<code class="lineno">226</code>           <code class="nx">assert</code><code class="p">(</code><code class="nx">user3</code><code class="p">.</code><code class="nx">length</code> <code class="o">===</code> <code class="mi">0</code><code class="p">);</code>
<code class="lineno">227</code>           <code class="nx">done</code><code class="p">();</code>
<code class="lineno">228</code>         <code class="p">});</code>
<code class="lineno">229</code>       <code class="p">});</code>
<code class="lineno">230</code>
<code class="lineno">231</code>
<code class="lineno">232</code>   <code class="p">});</code>
<code class="lineno">233</code> <code class="p">});</code>
<code class="lineno">234</code> <code class="c1">// app.close();   </code>
<code class="lineno">235</code> <code class="c1">// console.log(app)</code>
</pre></div>

</div>

<table class="warning sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="https://leanpub.com/site_images/express/leanpub_warning.png" alt="warning">
</td>
    <td>
      <h3 id="leanpub-auto-warning">Warning</h3>

  <p>Please don’t store plain passwords/keys in the database. Any serious production app should at least <a href="https://crackstation.net/hashing-security.htm">salt the passwords</a> before storing them.</p>

    </td>
  </tr></tbody></table>
<h3 id="leanpub-auto-conclusion-3">
<span class="section-number">4.8 </span>Conclusion</h3>

<p>HackHall is still in development, but there are important real production applications components, such as REST API architecture, OAuth, Mongoose and its models, MVC structure of Express.js apps, access to environment variables, etc.</p>

<!-- begin backmatter -->
<h2 id="leanpub-auto-expressworks">ExpressWorks</h2>

<div class="aside sidebarish">
  <h3 id="leanpub-auto-summary-6">Summary</h3>

  <p>ExpressWorks is an automated workshop that will walk you through building of Express.js servers, processing of GET, POST and PUT requests, extracting of query string, payload and URL parameters.</p>

</div>

<h3 id="leanpub-auto-what-is-expressworks">What is ExpressWorks?</h3>

<p>ExpressWorks is the Express.js workshop based on <a href="https://github.com/rvagg/workshopper">workshopper</a> and inspired by <a href="https://github.com/substack/stream-adventure">stream-adventure</a> by <a href="https://twitter.com/substack">@substack</a> and <a href="https://twitter.com/maxogden">@maxogden</a>.</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/hello-world.png" alt="Hello World Express.js app"><p class="caption">Hello World Express.js app</p>
</div>

<h3 id="leanpub-auto-installation-recommended">Installation (recommended)</h3>

<p>Recommended global installation:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>npm install -g expressworks
<code class="lineno">2</code> <code class="nv">$ </code>expressworks
</pre></div>

</div>

<p>If you see errors, try:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>sudo npm install -g expressworks
</pre></div>

</div>

<h3 id="leanpub-auto-local-installation-advanced">Local Installation (advanced)</h3>

<p>Run&amp;install locally:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nv">$ </code>npm install expressworks
<code class="lineno">2</code> <code class="nv">$ </code><code class="nb">cd </code>expressworks
<code class="lineno">3</code> <code class="nv">$ </code>npm install
<code class="lineno">4</code> <code class="nv">$ </code>node expressworks
</pre></div>

</div>

<h3 id="leanpub-auto-usage">Usage</h3>

<p>ExpressWorks understands these commands:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="n">Usage</code>
<code class="lineno"> 2</code>
<code class="lineno"> 3</code>   <code class="n">expressworks</code>
<code class="lineno"> 4</code>     <code class="n">Show</code> <code class="n">a</code> <code class="n">menu</code> <code class="n">to</code> <code class="n">interactively</code> <code class="n">select</code> <code class="n">a</code> <code class="n">workshop</code><code class="p">.</code>
<code class="lineno"> 5</code>   <code class="n">expressworks</code> <code class="n">list</code>
<code class="lineno"> 6</code>     <code class="n">Show</code> <code class="n">a</code> <code class="n">newline</code><code class="o">-</code><code class="n">separated</code> <code class="n">list</code> <code class="n">of</code> <code class="n">all</code> <code class="n">the</code> <code class="n">workshops</code><code class="p">.</code>
<code class="lineno"> 7</code>   <code class="n">expressworks</code> <code class="n">select</code> <code class="n">NAME</code>
<code class="lineno"> 8</code>     <code class="n">Select</code> <code class="n">a</code> <code class="n">workshop</code><code class="p">.</code>
<code class="lineno"> 9</code>   <code class="n">expressworks</code> <code class="n">current</code>
<code class="lineno">10</code>     <code class="n">Show</code> <code class="n">the</code> <code class="n">currently</code> <code class="n">selected</code> <code class="n">workshop</code><code class="p">.</code>
<code class="lineno">11</code>   <code class="n">expressworks</code> <code class="n">run</code> <code class="n">program</code><code class="p">.</code><code class="n">js</code>
<code class="lineno">12</code>     <code class="n">Run</code> <code class="n">your</code> <code class="n">program</code> <code class="n">against</code> <code class="n">the</code> <code class="n">selected</code> <code class="n">input</code><code class="p">.</code>
<code class="lineno">13</code>   <code class="n">expressworks</code> <code class="n">verify</code> <code class="n">program</code><code class="p">.</code><code class="n">js</code>
<code class="lineno">14</code>     <code class="n">Verify</code> <code class="n">your</code> <code class="n">program</code> <code class="n">against</code> <code class="n">the</code> <code class="n">expected</code> <code class="n">output</code><code class="p">.</code>
</pre></div>

</div>

<h3 id="leanpub-auto-reset">Reset</h3>

<p>If you want to reset the list of completed tasks, clean the <code>~/.config/expressworks/completed.json</code> file.</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/finished.png" alt="Hello World Express.js app"><p class="caption">Hello World Express.js app</p>
</div>

<h3 id="leanpub-auto-steps">Steps</h3>

<h4 id="leanpub-auto-hello-world">Hello World</h4>

<p>Create an Express.js app that runs on localhost:3000, and outputs “Hello World!” when somebody goes to root ‘/home’.</p>

<p><code>process.argv[2]</code> will be provided by expressworks to you, this is the port number.</p>

<h4 id="leanpub-auto-jade">Jade</h4>

<p>Create an Express.js app with a home page (/home) rendered by jade template engine, that shows current date (toDateString).</p>

<h4 id="leanpub-auto-good-old-form">Good Old Form</h4>

<p>Write a route (‘/form’) that processes HTML form input (<code>&lt;form&gt;&lt;input name="str"/&gt;&lt;/form&gt;</code>) and prints backwards the str value.</p>

<h4 id="leanpub-auto-static">Static</h4>

<p>Apply static middleware to server index.html file without any routes. The index.html file is provided and usable via <code>process.argv[3]</code> value of the path to it. However, you can use you’re own file with this content:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   <code class="nt">&lt;html&gt;</code>
<code class="lineno">2</code>     <code class="nt">&lt;head&gt;</code>
<code class="lineno">3</code>       <code class="nt">&lt;link</code> <code class="na">rel=</code><code class="s">"stylesheet"</code> <code class="na">type=</code><code class="s">"text/css"</code> <code class="na">href=</code><code class="s">"/main.css"</code><code class="nt">/&gt;</code>
<code class="lineno">4</code>     <code class="nt">&lt;/head&gt;</code>
<code class="lineno">5</code>     <code class="nt">&lt;body&gt;</code>
<code class="lineno">6</code>       <code class="nt">&lt;p&gt;</code>I am red!<code class="nt">&lt;/p&gt;</code>
<code class="lineno">7</code>     <code class="nt">&lt;/body&gt;</code>
<code class="lineno">8</code>   <code class="nt">&lt;/html&gt;</code>
</pre></div>

</div>

<h4 id="leanpub-auto-stylish-css">Stylish CSS</h4>

<p>Style your HTML from previous example with some Stylus middleware. The path to main.styl file is provided in <code>process.argv[3]</code> or you can create your own file/folder from these:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   <code class="nt">p</code>
<code class="lineno">2</code>     <code class="nt">color</code> <code class="nt">red</code>
</pre></div>

</div>

<p>The index.html file:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   <code class="nt">&lt;html&gt;</code>
<code class="lineno">2</code>     <code class="nt">&lt;head&gt;</code>
<code class="lineno">3</code>       <code class="nt">&lt;title&gt;</code>expressworks<code class="nt">&lt;/title&gt;</code>
<code class="lineno">4</code>       <code class="nt">&lt;link</code> <code class="na">rel=</code><code class="s">"stylesheet"</code> <code class="na">type=</code><code class="s">"text/css"</code> <code class="na">href=</code><code class="s">"/main.css"</code><code class="nt">/&gt;</code>
<code class="lineno">5</code>     <code class="nt">&lt;/head&gt;</code>
<code class="lineno">6</code>     <code class="nt">&lt;body&gt;</code>
<code class="lineno">7</code>       <code class="nt">&lt;p&gt;</code>I am red!<code class="nt">&lt;/p&gt;</code>
<code class="lineno">8</code>     <code class="nt">&lt;/body&gt;</code>
<code class="lineno">9</code>   <code class="nt">&lt;/html&gt;</code>
</pre></div>

</div>

<h4 id="leanpub-auto-param-pam-pam">Param Pam Pam</h4>

<p>Create an Express.js server that processes PUT <code>/message/:id</code> requests, e.g., PUT <code>/message/526aa677a8ceb64569c9d4fb</code>.</p>

<p>As the response of this request return id SHA1 hashed with a date:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code>   <code class="nx">require</code><code class="p">(</code><code class="s1">'crypto'</code><code class="p">)</code>
<code class="lineno">2</code>     <code class="p">.</code><code class="nx">createHash</code><code class="p">(</code><code class="s1">'sha1'</code><code class="p">)</code>
<code class="lineno">3</code>     <code class="p">.</code><code class="nx">update</code><code class="p">(</code><code class="k">new</code> <code class="nb">Date</code><code class="p">().</code><code class="nx">toDateString</code><code class="p">().</code><code class="nx">toString</code><code class="p">()</code> <code class="o">+</code> <code class="nx">id</code><code class="p">)</code>
<code class="lineno">4</code>     <code class="p">.</code><code class="nx">digest</code><code class="p">(</code><code class="s1">'hex'</code><code class="p">)</code>
</pre></div>

</div>

<h4 id="leanpub-auto-whats-in-query">What’s in Query</h4>

<p>Write a route that extracts data from query string in the GET <code>/search</code> URL route, e.g., <code>?results=recent&amp;include_tabs=true</code>, and then transforms outputs it back to the user in JSON format.</p>

<h4 id="leanpub-auto-json-me">JSON Me</h4>

<p>Write a server that reads a file (file name is passed in <code>process.argv[3]</code>), parses it to JSON and outputs the content to the user with <code>res.json(object)</code>.</p>

<h2 id="related-reading-and-resources">Related Reading and Resources</h2>

<div class="aside sidebarish">
  <h3 id="leanpub-auto-summary-7">Summary</h3>

  <p>In this short chapter, we’ll provide a list of the most useful Node.js resources for further learning.</p>

</div>

<h3 id="leanpub-auto-other-nodejs-frameworks">Other Node.js Frameworks</h3>

<p>The Express.js framework is no doubt the most mature, popular, robust, tested and used project for Node.js web services. As of this writing, Express.js is also the most starred NPM repository with 2x more stars that request and async libraries. There are plenty of real production apps that rely on Express 2.x and 3.x including <a href="http://storify.com">Storify</a> (acquired by <a href="http://livefyre.com">LiveFyre</a>), <a href="http://docusign.com">DocuSign</a>, new <a href="http://new.myspace.com">MySpace</a>, <a href="https://www.learnboost.com/">LearnBoost</a>, <a href="http://geekli.st/">Geekli.st</a>, <a href="http://klout.com/">Klout</a>, <a href="http://getprismatic.com/">Prismatic</a>, <a href="http://segment.io/">Segment.io</a> and <a href="http://expressjs.com/applications.html">more</a>.</p>

<div class="image-with-caption center">
  <img src="https://leanpub.com/site_images/express/express-npm.png" alt="Express.js is also the most starred NPM repository."><p class="caption">Express.js is also the most starred NPM repository.</p>
</div>

<p>Nevertheless, there are plenty of alternatives for which we created our analog of <a href="http://todomvc.com">todomvc.com</a> collection: <a href="http://nodeframework.com">nodeframework.com</a>. By the way, some of the more comprehensive frameworks depend on Express.js (i.e., <a href="https://github.com/balderdashy/sails/blob/v0.9.0/package.json#L32">SailsJS</a>). So it’s great that our readers know Express.js by now!</p>

<h3 id="leanpub-auto-nodejs-books">Node.js Books</h3>

<p>For more core Node.js overview and/or other components of the Node.js stack, such as databases and websockets, please consider these resources:</p>

<ul>
<li>
<a href="http://www.apress.com/9781430258605">Pro Node.js</a> (Colin J. Ihrig)  — ISBN: 978-1-4302-5860-5, comprehensive low-level book on Node.js sans any non-core modules</li>
  <li>
<a href="http://www.manning.com/cantelon/">Node.js in Action</a> (TJ Holowaychuk et al)  — ISBN: 9781617290572 not published yet (est. end of 2013), the book about Express.js from the creators of the framework</li>
  <li>
<a href="http://shop.oreilly.com/product/0636920024606.do">Learning Node</a> (Shelley Powers) — ISBN: 978-1-4493-2307-3 book covers Express, MongoDB, Mongoose and Socket.IO</li>
  <li>
<a href="http://my.safaribooksonline.com/9781849517188">Node Cookbook</a> (David Mark Clements) — ISBN: 978-1-84951-718-8 book covers databases and websockets</li>
  <li>
<a href="http://shop.oreilly.com/product/0636920015956">Node: Up and Running</a> (Tom Hughes-Croucher et al) brief overview of Node.js</li>
  <li>
<a href="http://www.amazon.com/Smashing-Node-js-JavaScript-Everywhere-Magazine/dp/1119962595">Smashing Node.js</a> (Guillermo Rauch)  covers Express.js, Jade, Stylus from the creator of Mongoose ORM for MongoDB</li>
</ul>
<h3 id="leanpub-auto-javascript-classics">JavaScript Classics</h3>

<p>For deeper understanding of the most misunderstood and the most popular programming language, please make sure to read these proven classics:</p>

<ul>
<li>
<a href="http://eloquentjavascript.net/">Eloquent JavaScript</a>: programming fundamentals in the JavaScript coating</li>
  <li>
<a href="http://www.amazon.com/dp/0596517742">JavaScript: The Good Parts</a>: tricky part of the language</li>
</ul>
</div>


</div>
         </div>
       </div>
     </div>
     </section>
     <section id="marketing-footer" class="sec-wrap">
     	<div class="container">
         <div class="row">
        	<div class="span8 offset2">
                <form class="hero-form tweet-form">
                   <div class="row-fluid">
                    	<div class="span3 text-center">
                    		<img src="assets/img/title-page-small.png" width="128" height="177" alt="book cover" />
                        </div>
                        <div class="span9">
                        <fieldset>
                            <div class="control-group text-center">
                              <label style="cursor: default">Get the Professional package for $29.99</label>
                              <a href="http://gum.co/express" onclick="_gaq.push(['_trackEvent', 'BuyLinks', 'Professional', 'Buy now (botttom)']);" class="gumroad-button0 btn btn-info btn-large btn-block">Buy now</a>
                              <p class="text-small-alt">Other options start at $9.99 only. <a href="#packages" onclick="_gaq.push(['_trackEvent', 'NavLinks', 'Packages', 'Jump to other packages']);">Jump to the other packages.</a></p>
                            </div><!--/control-group-->
                        </fieldset>
                        </div><!--/span9-->
                   </div><!--/row-fluid-->
                </form>
            </div><!--/span8-->
        </div><!--/row-->
	    </div><!--/container-->
    </section><!--/inside-->
	<footer>
    	<div class="container">
            <div class="row">
                <div class="span12">
                    <p class="text-center">Express.js Guide: The Comprehensive Book on Express.js &copy; 2013 <a href="http://azat.co">Azat Mardanov</a>. All rights reserved.</p>
                </div><!--/span12-->
            </div><!--/row-->
        </div><!--/container-->
    </footer>
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <!-- Magnific Popup JS -->
    <script src="assets/js/plugins/magnificPopup/magnific-popup.min.js"></script>
    <!-- Quotes Rotator JS -->
    <script src="assets/js/plugins/QuotesRotator/js/jquery.cbpQTRotator.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36472155-3', 'expressjsguide.com');
  ga('send', 'pageview');

</script>

<script>

//Share on Facebook
var shareOnFacebook = function() {
  window.open(
    'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
    'facebook-share-dialog',
    'width=626,height=436'
  );
  return false;
}

var shareOnTwitter = function() {
  window.open(
    'http://clicktotweet.com/Ue2Us',
    // 'http://clicktotweet.com/djzS6',
    'twitter-share-dialog',
    'width=626,height=436'
  );
  return false;
}

$(function () {
	// Testimonials rotator
	$( '#cbp-qtrotator' ).cbpQTRotator();
	// Image Zoom
	$('.thumbnails').magnificPopup({
	delegate: 'a',
	type: 'image',
	closeOnContentClick: false,
	closeBtnInside: true,
	mainClass: 'mfp-with-zoom mfp-img-mobile',
	image: {
		verticalFit: true,
		titleSrc: function(item) {
			return item.el.attr('title') + '<small>Express.js Guide</small>';
		}
	},
	gallery: {
		enabled: true
	},
	zoom: {
		enabled: true,
		duration: 300, // don't foget to change the duration also in CSS
		opener: function(element) {
			return element.find('img');
		}
	}
	});

  //Attach share on Facebook events
  $('.share-facebook').click(shareOnFacebook);
  $('.share-twitter').click(shareOnTwitter);
  $('[rel=tooltip]').tooltip()
});


</script>
  </body>
</html>
